/// ================================================================================
/// # è¯­æ³•è§£æžçš„å¦ä¸€åˆ†æ”¯ï¼šè§£æžç±»åž‹
///
/// æ­å–œä½ ï¼ä½ å·²ç»å¾æœäº†è¡¨è¾¾å¼è§£æžä¸­æœ€è‰°éš¾ã€æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚
/// çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬å°†ç›®å…‰ä»Žâ€œå€¼â€çš„ä¸–ç•Œæš‚æ—¶ç§»å¼€ï¼Œè½¬å‘â€œç±»åž‹â€çš„ä¸–ç•Œã€‚
///
/// åœ¨ `parser/typedef.mbt` ä¸­ï¼Œä½ éœ€è¦å®žçŽ° `parse_type` å‡½æ•°ï¼Œ
/// å®ƒè´Ÿè´£å°† Token åºåˆ—è§£æžä¸º MiniMoonBit ä¸­çš„å„ç§ç±»åž‹ï¼Œä¾‹å¦‚ `Int`ã€`Array[Bool]`ã€`(Int, Double) -> Bool` ç­‰ã€‚
///
/// ç›¸ä¿¡åœ¨ç»åŽ†äº†è¡¨è¾¾å¼è§£æžçš„é‡é‡è€ƒéªŒä¹‹åŽï¼Œç±»åž‹çš„è§£æžå¯¹ä½ æ¥è¯´åº”è¯¥å·²ç»æ˜¯å°èœä¸€ç¢Ÿäº†ã€‚
/// å®ƒçš„é€»è¾‘ä¸Žè§£æžè¡¨è¾¾å¼æœ‰è®¸å¤šç›¸ä¼¼ä¹‹å¤„ï¼Œä½†é€šå¸¸æ›´ç®€å•ï¼Œå› ä¸ºå®ƒä¸æ¶‰åŠè¿ç®—ç¬¦ä¼˜å…ˆçº§ç­‰å¤æ‚é—®é¢˜ã€‚
///
/// å› æ­¤ï¼Œè¿™ä¸ªæŒ‘æˆ˜çš„æ•™ç¨‹å°±ä¸å†åšè¿‡å¤šå±•å¼€äº†ï¼Œè¯·ä½ å°½æƒ…æ–½å±•å§ï¼
///
/// åŠ æ²¹ï¼ðŸ’ª
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p parser -f parse_type_test.mbt
/// ```
/// ================================================================================

///|
test "Simple Type Parsing" {
  let code =
    #|Unit Int Bool Double
  let tokens = @lexer.tokenize(code)
  let (ty, tok_view) = parse_type(tokens[:])
  assert_true(ty.kind is TypeKind::Unit)
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Int)
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Bool)
  let (ty, _) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Double)
}

///|
test "Complex Type Parsing" {
  let code =
    #|Array[Int]
    #|(Int, Double) 
    #|() -> Double
    #|((Int, Double), Unit)
    #|(Array[Bool], Unit) -> Double
    #|Array[(Int, Double)]
    #|Array[() -> Double]
    #|Array[((Int, Double), Unit)]
  let tokens = @lexer.tokenize(code)
  
  let (ty, tok_view) = parse_type(tokens[:])
  assert_true(ty.kind is TypeKind::Array(TypeKind::Int))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Tuple([TypeKind::Int, TypeKind::Double]))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Function([], TypeKind::Double))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Tuple([TypeKind::Tuple([TypeKind::Int, TypeKind::Double]), TypeKind::Unit]))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Function([TypeKind::Array(TypeKind::Bool), TypeKind::Unit], TypeKind::Double))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Array(TypeKind::Tuple([TypeKind::Int, TypeKind::Double])))
  
  let (ty, tok_view) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Array(TypeKind::Function([], TypeKind::Double)))
  
  let (ty, _) = parse_type(tok_view)
  assert_true(ty.kind is TypeKind::Array(TypeKind::Tuple([TypeKind::Tuple([TypeKind::Int, TypeKind::Double]), TypeKind::Unit])))
}
