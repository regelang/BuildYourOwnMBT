/// ================================================================================
/// # ä»£ç å—çš„åŠ›é‡ï¼šè§£æ BlockExpr
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥è§£æç‹¬ç«‹çš„è¯­å¥äº†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¦å°†å®ƒä»¬ç»„ç»‡åˆ°ä¸€ä¸ªéå¸¸é‡è¦çš„ç»“æ„ä¸­ï¼š
/// **ä»£ç å—è¡¨è¾¾å¼ï¼ˆBlock Expressionï¼‰**ã€‚
///
/// åœ¨ MiniMoonBit ä¸­ï¼Œä»£ç å—ç”± `{}` åŒ…è£¹ï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå…¶å€¼æ˜¯å—å†…æœ€åä¸€æ¡è¡¨è¾¾å¼çš„å€¼ã€‚
///
/// ## BlockExpr çš„ EBNF èŒƒå¼
///
/// ```
/// block_expr ::= "{" stmt* expr? "}"
/// ```
///
/// è¿™æ®µèŒƒå¼å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸€ä¸ªä»£ç å—åŒ…å«ï¼š
/// 1.  ä¸€ä¸ªèµ·å§‹çš„ `{"{"`ã€‚
/// 2.  é›¶æ¡æˆ–å¤šæ¡ï¼ˆ`*`ï¼‰ä»¥åˆ†å·ç»“å°¾çš„è¯­å¥ï¼ˆ`stmt`ï¼‰ã€‚
/// 3.  å¯é€‰åœ°ï¼ˆ`?`ï¼‰ï¼Œæœ€åå¯ä»¥æœ‰ä¸€æ¡ä¸å¸¦åˆ†å·çš„è¡¨è¾¾å¼ï¼ˆ`expr`ï¼‰ï¼Œå®ƒçš„å€¼å°±æ˜¯æ•´ä¸ªå—çš„å€¼ã€‚
/// 4.  ä¸€ä¸ªç»ˆç»“çš„ `"}"`ã€‚
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `parse_block_expr`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `parser/block_expr.mbt` ä¸­å®ç° `parse_block_expr` å‡½æ•°ã€‚
///
/// **å®ç°æ€è·¯ï¼š**
///
/// 1.  åŒ¹é…å¹¶è·³è¿‡å¼€å¤´çš„ `{"{"`ã€‚
/// 2.  è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåå¤è°ƒç”¨ `parse_stmt` æ¥è§£æå—å†…çš„æ¯ä¸€æ¡è¯­å¥ã€‚
/// 3.  å¾ªç¯ç›´åˆ°é‡åˆ° `"}"` ä¸ºæ­¢ã€‚
/// 4.  åŒ¹é…å¹¶è·³è¿‡ç»“å°¾çš„ `"}"`ã€‚
///
/// ### ğŸ¤” ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¦‚ä½•å¤„ç†æœ€åä¸€æ¡â€œä¸å¸¦åˆ†å·â€çš„è¡¨è¾¾å¼ï¼Ÿ
///
/// EBNF ä¸­çš„ `expr?` æ˜¯æ•´ä¸ªè§£æè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ã€‚
/// `let x = { let y = 1; y + 1 }` æ˜¯åˆæ³•çš„ï¼Œæœ€åçš„ `y + 1` æ²¡æœ‰åˆ†å·ã€‚
///
/// è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬çš„ `parse_stmt` åœ¨è§£æä¸€ä¸ªå¯èƒ½æ˜¯ `expr_stmt` çš„è¯­å¥æ—¶ï¼Œ
/// å®ƒä¸èƒ½å†å›ºæ‰§åœ°è¦æ±‚ç»“å°¾å¿…é¡»æ˜¯ `;` äº†ã€‚
///
/// **ğŸ’¡ æç¤ºï¼š**
///
/// è§£å†³è¿™ä¸ªé—®é¢˜çš„å…³é”®åœ¨äº**ä¿®æ”¹ `parse_stmt` å‡½æ•°**ã€‚
///
/// å½“ `parse_stmt` è§£æå®Œä¸€ä¸ª `expr_stmt` åï¼Œå®ƒéœ€è¦æ£€æŸ¥ä¸‹ä¸€ä¸ª Tokenï¼š
/// *   å¦‚æœ Token æ˜¯ `;`ï¼Œé‚£ä¹ˆæ¶ˆè€—å®ƒï¼Œè¯­å¥ç»“æŸã€‚
/// *   å¦‚æœ Token æ˜¯ `}`ï¼Œé‚£ä¹ˆè¯´æ˜è¿™å·²ç»æ˜¯å—çš„ç»“å°¾äº†ï¼Œ**ä¸æ¶ˆè€—å®ƒ**ï¼Œç›´æ¥å°† `expr_stmt` è¿”å›ã€‚
/// *   å¦‚æœæ˜¯å…¶ä»– Tokenï¼Œåˆ™åº”è¯¥æŠ¥é”™ã€‚
///
/// é€šè¿‡åœ¨ `parse_stmt` ä¸­å¢åŠ å¯¹ `}` çš„â€œå®½å®¹â€ï¼Œ`parse_block_expr` çš„å®ç°å°±å¯ä»¥ä¿æŒéå¸¸ç®€å•ã€‚
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p parser -f parse_block_expr_test.mbt
/// ```
/// ================================================================================

///|
test "Block Expr Parsing" {
  let code =
    #|{
    #|  let x = 10;
    #|  let mut y = 20;
    #|  y = y + x;
    #|  let t = Array::make(5, 0);
    #|  t[0] = y;
    #|}
  let tokens = @lexer.tokenize(code)
  let (block, _) = parse_block_expr(tokens)
  assert_true(block.stmts.length() is 5)
  assert_true(block.stmts[0].kind is LetStmt(_))
  assert_true(block.stmts[1].kind is LetMutStmt(_))
  assert_true(block.stmts[2].kind is AssignStmt(_))
  assert_true(block.stmts[3].kind is LetStmt(_))
  assert_true(block.stmts[4].kind is AssignStmt(_))
}
