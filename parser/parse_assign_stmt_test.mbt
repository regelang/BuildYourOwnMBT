/// ================================================================================
/// # ç»„è£…ï¼è§£æèµ‹å€¼è¯­å¥
///
/// ä¸‡äº‹ä¿±å¤‡ï¼æˆ‘ä»¬å·²ç»åˆ†åˆ«å®ç°äº† `left_value` å’Œ `expr` çš„è§£æå™¨ã€‚
/// ç°åœ¨ï¼Œæ˜¯æ—¶å€™å°†å®ƒä»¬ç»„è£…èµ·æ¥ï¼Œå®Œæˆ**èµ‹å€¼è¯­å¥ï¼ˆAssignment Statementï¼‰**çš„è§£æäº†ã€‚
///
/// ## èµ‹å€¼è¯­å¥çš„ EBNF èŒƒå¼
///
/// è®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹èµ‹å€¼è¯­å¥çš„ç»“æ„ï¼š
///
/// ```
/// assign_stmt ::= left_value assign_op expr ";"
/// ```
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `parse_assign_stmt`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `parser/assign_stmt.mbt` ä¸­å®ç° `parse_assign_stmt` å‡½æ•°ã€‚
///
/// è¿™ä¸ªä»»åŠ¡éå¸¸ç›´æ¥ï¼Œå®ƒå®Œç¾åœ°ä½“ç°äº†é€’å½’ä¸‹é™è§£æå™¨çš„â€œç»„åˆâ€æ€æƒ³ï¼š
///
/// 1.  **è§£æå·¦å€¼ï¼š** é¦–å…ˆï¼Œè°ƒç”¨ä½ åˆšåˆšå®Œæˆçš„ `parse_left_value` å‡½æ•°æ¥è§£æèµ‹å€¼ç¬¦å·å·¦è¾¹çš„éƒ¨åˆ†ã€‚
/// 2.  **è§£æèµ‹å€¼ç¬¦å·ï¼š** æ¥ç€ï¼ŒåŒ¹é…ä¸€ä¸ªèµ‹å€¼æ“ä½œç¬¦ï¼ˆ`=`ã€`+=` ç­‰ï¼‰ã€‚
/// 3.  **è§£æå³å€¼ï¼š** ç„¶åï¼Œè°ƒç”¨æˆ‘ä»¬å¼ºå¤§çš„ `parse_expr` å‡½æ•°æ¥è§£æèµ‹å€¼ç¬¦å·å³è¾¹çš„è¡¨è¾¾å¼ã€‚
/// 4.  **ç»“å°¾ï¼š** æœ€åï¼Œç¡®ä¿è¯­å¥ä»¥åˆ†å· `;` ç»“å°¾ã€‚
///
/// ä½ çœ‹ï¼Œæˆ‘ä»¬ä¹‹å‰æ‰€æœ‰çš„åŠªåŠ›ï¼Œéƒ½æ˜¯ä¸ºäº†åœ¨è¿™ä¸€åˆ»èƒ½å¤Ÿè½»æ¾åœ°å°†å„ä¸ªéƒ¨åˆ†ç»„åˆåœ¨ä¸€èµ·ã€‚
///
/// åŠ æ²¹ï¼Œè§£æå™¨çš„è¯­å¥éƒ¨åˆ†å³å°†å®Œæˆï¼
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p parser -f parse_assign_stmt_test.mbt
/// ```
/// ================================================================================

///|
test "Assign Stmt Parsing Test" {
  let code =
    #|obj.field1 = 42 ;
    #|matrix[1][2] += 3.14 ;
    #|arr[3][5].field -= arr[0][0] ;
    #|x *= 10 ;
    #|y /= 2 ;
    #|z %= 5 ;
  let tokens = @lexer.tokenize(code)
  let (a, tok_view) = parse_assign_stmt(tokens[:])
  assert_true(
    a.left_value.kind is FieldAccess(field_access, field_name) &&
    field_name is "field1" &&
    field_access.kind is Ident("obj") &&
    a.op is Assign &&
    a.expr.kind is ApplyExpr(expr_app) &&
    expr_app.kind is AtomExpr(expr_atom) &&
    expr_atom.kind is Int(42),
  )
  let (a, tok_view) = parse_assign_stmt(tok_view)
  assert_true(
    a.left_value.kind is ArrayAccess(array_access2, index_expr2) &&
    index_expr2.kind is ApplyExpr(index_app2) &&
    index_app2.kind is AtomExpr(index_atom2) &&
    index_atom2.kind is Int(2) &&
    array_access2.kind is ArrayAccess(array_access1, index_expr1) &&
    index_expr1.kind is ApplyExpr(index_app1) &&
    index_app1.kind is AtomExpr(index_atom1) &&
    index_atom1.kind is Int(1) &&
    array_access1.kind is Ident("matrix") &&
    a.op is PlusAssign &&
    a.expr.kind is ApplyExpr(expr_app2) &&
    expr_app2.kind is AtomExpr(expr_atom2) &&
    expr_atom2.kind is Double(3.14),
  )
  let (a, tok_view) = parse_assign_stmt(tok_view)
  assert_true(
    a.left_value.kind is FieldAccess(field_access2, field_name2) &&
    field_name2 is "field" &&
    field_access2.kind is ArrayAccess(array_access3, index_expr3) &&
    index_expr3.kind is ApplyExpr(index_app3) &&
    index_app3.kind is AtomExpr(index_atom3) &&
    index_atom3.kind is Int(5) &&
    array_access3.kind is ArrayAccess(array_access4, index_expr4) &&
    index_expr4.kind is ApplyExpr(index_app4) &&
    index_app4.kind is AtomExpr(index_atom4) &&
    index_atom4.kind is Int(3) &&
    array_access4.kind is Ident("arr") &&
    a.op is MinusAssign &&
    a.expr.kind is ApplyExpr(expr_app3) &&
    expr_app3.kind is ArrayAccess(expr_array_access, expr_index_expr) &&
    expr_index_expr.kind is ApplyExpr(expr_index_app) &&
    expr_index_app.kind is AtomExpr(expr_index_atom) &&
    expr_index_atom.kind is Int(0) &&
    expr_array_access.kind is ArrayAccess(expr_array_access2, expr_index_expr2) &&
    expr_index_expr2.kind is ApplyExpr(expr_index_app2) &&
    expr_index_app2.kind is AtomExpr(expr_index_atom2) &&
    expr_index_atom2.kind is Int(0) &&
    expr_array_access2.kind is AtomExpr(expr_array_atom) &&
    expr_array_atom.kind is Ident("arr"),
  )
  let (a, _) = parse_assign_stmt(tok_view)
  assert_true(
    a.left_value.kind is Ident("x") &&
    a.op is MultAssign &&
    a.expr.kind is ApplyExpr(expr_app4) &&
    expr_app4.kind is AtomExpr(expr_atom4) &&
    expr_atom4.kind is Int(10),
  )
}
