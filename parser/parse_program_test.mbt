/// ================================================================================
/// # è¯­æ³•åˆ†æžçš„ç»ˆç‚¹ï¼šè§£æžæ•´ä¸ªç¨‹åº
///
/// ðŸŽ‰ **ç¥è´ºä½ ï¼ä½ å·²ç»æ¥åˆ°äº†è¯­æ³•åˆ†æžé˜¶æ®µçš„æœ€åŽä¸€å…³ï¼** ðŸŽ‰
///
/// æˆ‘ä»¬å·²ç»åˆ†åˆ«æž„å»ºäº†ç”¨äºŽè§£æžè¡¨è¾¾å¼ã€è¯­å¥ã€ç±»åž‹å’Œå„ç§é¡¶å±‚å£°æ˜Žçš„è§£æžå™¨ã€‚
/// çŽ°åœ¨ï¼Œæ˜¯æ—¶å€™å°†å®ƒä»¬å…¨éƒ¨æ•´åˆèµ·æ¥ï¼Œæž„å»ºä¸€ä¸ªèƒ½å¤Ÿè§£æžå®Œæ•´ MiniMoonBit ç¨‹åºçš„æœ€ç»ˆ `parse` å‡½æ•°äº†ã€‚
///
/// ## ä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿ
///
/// åœ¨ MiniMoonBit ä¸­ï¼Œä¸€ä¸ªç¨‹åºï¼ˆ`Program`ï¼‰å°±æ˜¯ä¸€ç³»åˆ—é¡¶å±‚å£°æ˜Žçš„é›†åˆã€‚è¿™äº›å£°æ˜Žå¯ä»¥æ˜¯ï¼š
/// *   é¡¶å±‚å‡½æ•° (`TopFunction`)
/// *   é¡¶å±‚ `let` ç»‘å®š (`TopLet`)
/// *   ç»“æž„ä½“å®šä¹‰ (`StructDef`)
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡ï¼šå®žçŽ°æœ€ç»ˆçš„ `parse` å‡½æ•°
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `parser/parser.mbt` ä¸­å®žçŽ° `parse` å‡½æ•°ã€‚
///
/// **è¯·æ³¨æ„ï¼š** è¿™ä¸ªæœ€ç»ˆçš„ `parse` å‡½æ•°çš„ç­¾åä¸Žæˆ‘ä»¬ä¹‹å‰å†™çš„è¾…åŠ©å‡½æ•°æœ‰æ‰€ä¸åŒã€‚
/// å®ƒæŽ¥æ”¶çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„ `Array[Token]`ï¼Œè€Œä¸æ˜¯ `ArrayView[Token]`ã€‚
///
/// **å®žçŽ°æ€è·¯ï¼š**
///
/// 1.  **åˆå§‹åŒ–ï¼š** åˆ›å»ºç”¨äºŽå­˜å‚¨ `TopFunction`ã€`TopLet` å’Œ `StructDef` çš„ `Map`ã€‚
///
/// 2.  **å¾ªçŽ¯è§£æžï¼š**
///     *   å¯åŠ¨ä¸€ä¸ªå¾ªçŽ¯ï¼ŒæŒç»­å¤„ç† Token è§†å›¾ã€‚
///     *   åœ¨å¾ªçŽ¯çš„æ¯ä¸€æ­¥ï¼Œæ£€æŸ¥å½“å‰çš„ Token æ˜¯ä»€ä¹ˆï¼š
///         *   å¦‚æžœæ˜¯ `fn` å…³é”®å­—ï¼Œè°ƒç”¨ `parse_top_function`ã€‚
///         *   å¦‚æžœæ˜¯ `let` å…³é”®å­—ï¼Œè°ƒç”¨ `parse_top_let`ã€‚
///         *   å¦‚æžœæ˜¯ `struct` å…³é”®å­—ï¼Œè°ƒç”¨ `parse_struct_def`ã€‚
///     *   å°†è§£æžå¾—åˆ°çš„ç»“æžœå­˜å…¥ç›¸åº”çš„ `Map` ä¸­ã€‚
///     *   ç”¨å‰©ä½™çš„ Token ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªçŽ¯ã€‚
///
/// 3.  **ç»ˆæ­¢æ¡ä»¶ï¼š** å½“ä½ é‡åˆ° `EOF` Token æ—¶ï¼Œæ„å‘³ç€æ‰€æœ‰æºä»£ç éƒ½å·²å¤„ç†å®Œæ¯•ï¼Œå¾ªçŽ¯ç»“æŸã€‚
///
/// 4.  **ç»„è£… `Program`ï¼š** æœ€åŽï¼Œç”¨å¡«å……å¥½çš„ `Map` åˆ›å»ºå¹¶è¿”å›žæœ€ç»ˆçš„ `Program` å¯¹è±¡ã€‚
///
/// ## ðŸš€ è§è¯ä½ çš„æˆæžœï¼
///
/// å®Œæˆè¿™ä¸ªä»»åŠ¡åŽï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ MiniMoonBit è¯­æ³•åˆ†æžå™¨ï¼
/// ä½ å¯ä»¥æ‰¾ä¸€ä¸ª `examples/` ç›®å½•ä¸‹çš„ `.mbt` æ–‡ä»¶ï¼Œç„¶åŽè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œäº²çœ¼çœ‹çœ‹ä½ çš„è§£æžå™¨çš„å·¥ä½œæˆæžœï¼š
///
/// ```bash
/// moon run main -- --file examples/nbody.mbt -stop-after=parse
/// ```
///
/// è¿™ä¸ªå‘½ä»¤ä¼šè¿è¡Œä½ çš„ç¼–è¯‘å™¨ï¼Œä½†åœ¨è¯­æ³•åˆ†æžé˜¶æ®µç»“æŸåŽå°±åœæ­¢ï¼Œå¹¶æ‰“å°å‡ºç”Ÿæˆçš„ ASTã€‚
///
/// **å†æ¬¡ç¥è´ºä½ å®Œæˆäº†è¯­æ³•åˆ†æžè¿™ä¸€é‡è¦çš„é‡Œç¨‹ç¢‘ï¼æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥æ›´æ¿€åŠ¨äººå¿ƒçš„è¯­ä¹‰åˆ†æžé˜¶æ®µï¼**
/// ================================================================================

///|
test "Parse Program Test" {
  let code =
    #|struct Circle {
    #|  radius: Double;
    #|}
    #|
    #|struct Rectangle {
    #|  a: Double;
    #|  b: Double;
    #|  c: Double;
    #|}
    #|
    #|let pi: Double = 3.14;
    #|
    #|fn area_circle(c: Circle) -> Double {
    #|  if c.radius < 0.0 {
    #|    return 0.0;
    #|  };
    #|  pi * c.radius * c.radius;
    #|}
    #|
    #|fn area_rectangle(r: Rectangle) -> Double {
    #|   let p = (r.a + r.b + r.c) / 2.0;
    #|   let x = p - r.a;
    #|   let y = p - r.b;
    #|   let z = p - r.c;
    #|   sqrt(p * x * y * z);
    #|}
    #|
    #|fn main {
    #|  let c = Circle::{ radius: 2.0 };
    #|  let r = Rectangle::{ a: 3.0, b: 4.0, c: 5.0 };
    #|  let ac = area_circle(c);
    #|  let ar = area_rectangle(r);
    #|  if ac > ar {
    #|    print_str("Circle area is larger");
    #|  } else {
    #|    print_str("Rectangle area is larger");
    #|  };
    #|}
  let tokens = @lexer.tokenize(code)
  let program = parse(tokens)
  assert_true(program.struct_defs.length() is 2)
  assert_true(program.top_lets.length() is 1)
  assert_true(program.top_functions.length() is 3)
  assert_true(program.struct_defs.get("Circle") is Some(_))
  assert_true(program.struct_defs.get("Rectangle") is Some(_))
  assert_true(program.top_lets.get("pi") is Some(_))
  assert_true(program.top_functions.get("area_circle") is Some(_))
  assert_true(program.top_functions.get("area_rectangle") is Some(_))
  assert_true(program.top_functions.get("main") is Some(_))
}
