/// ================================================================================
/// # âš”ï¸ ç¬¬äºŒæŒ‘æˆ˜ï¼šè¯­æ³•åˆ†æå™¨ (Parser) çš„ç»“æ„ä¹‹åŠ›
///
/// æ­å–œä½ å®Œæˆäº†è¯æ³•åˆ†æï¼ä½ å·²ç»æ‹¥æœ‰äº†ç¼–è¯‘å™¨å†’é™©çš„ç¬¬ä¸€æŠŠé’¥åŒ™â€”â€”Token åºåˆ—ã€‚
/// ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº› Tokenï¼Œæ¥æ„å»ºä»£ç çš„â€œéª¨æ¶â€ï¼š**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰**ã€‚
///
/// ---
///
/// ## ğŸ—ºï¸ è¯­æ³•åˆ†æï¼ˆParsingï¼‰ï¼šä»åºåˆ—åˆ°å±‚æ¬¡
///
/// è¯­æ³•åˆ†æå™¨æ˜¯ç¼–è¯‘å™¨çš„â€œå»ºç­‘å¸ˆâ€ã€‚å®ƒçš„ä½¿å‘½æ˜¯å°†çº¿æ€§çš„ Token æµï¼Œ
/// æŒ‰ç…§è¯­è¨€çš„**è¯­æ³•è§„åˆ™**ï¼Œç»„ç»‡æˆå…·æœ‰å±‚æ¬¡ç»“æ„çš„ **AST èŠ‚ç‚¹**ã€‚
///
/// **ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š**
///
/// ```
/// let total : Int = price * count + 10;
/// ```
///
/// Parser ä¸ä»…è¦çœ‹åˆ° `*` å’Œ `+` è¿ç®—ç¬¦ï¼Œè¿˜è¦ç†è§£å®ƒä»¬ä¹‹é—´çš„**ä¼˜å…ˆçº§**å’Œ**ç»“åˆæ€§**ï¼Œ
/// æœ€ç»ˆç”Ÿæˆå¦‚ä¸‹ç»“æ„ï¼ˆç®€åŒ–è¡¨ç¤ºï¼‰ï¼š
///
/// ```
/// - LetStatement (å˜é‡å£°æ˜)
///   - Name: "total"
///   - Type: Int
///   - Value:
///     - BinaryExpr (äºŒå…ƒè¿ç®— '+')
///       - Left: BinaryExpr (äºŒå…ƒè¿ç®— '*')
///         - Left: Identifier "price"
///         - Right: Identifier "count"
///       - Right: Integer 10
/// ```
///
/// **æ ¸å¿ƒç›®æ ‡ï¼š** å°†å¹³é“ºçš„ `Array[Token]` è½¬æ¢ä¸ºåµŒå¥—çš„ `Program` ç»“æ„ã€‚
///
/// ```moonbit
/// parse(tokens: Array[Token]) -> Program
/// ```
///
/// ## ğŸ›ï¸ è§£ææŠ€æœ¯ï¼šé€’å½’ä¸‹é™ï¼ˆRecursive Descentï¼‰
///
/// åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨æœ€ç›´è§‚ä¸”å¼ºå¤§çš„è§£ææŠ€æœ¯ä¹‹ä¸€ï¼š**é€’å½’ä¸‹é™è§£æï¼ˆRecursive Descent Parsingï¼‰**ã€‚
///
/// è¿™ç§æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**æ¯ä¸€ä¸ªè¯­æ³•è§„åˆ™éƒ½å¯¹åº”ä¸€ä¸ªè§£æå‡½æ•°ã€‚**
/// * è§£æ `Expr` çš„å‡½æ•°ä¼šè°ƒç”¨è§£æ `BinaryExpr` çš„å‡½æ•°ã€‚
/// * è§£æ `BinaryExpr` çš„å‡½æ•°ä¼šè°ƒç”¨è§£æ `AtomExpr` çš„å‡½æ•°ã€‚
///
/// ğŸ“Œ **æˆ‘ä»¬çš„ç­–ç•¥ï¼šè‡ªåº•å‘ä¸Šæ„å»ºï¼**
/// æˆ‘ä»¬å°†ä»æœ€åº•å±‚ã€æœ€ç®€å•çš„è¯­æ³•å•å…ƒï¼ˆä¾‹å¦‚å•ä¸ªæ•°å­—ï¼‰å¼€å§‹å®ç°ï¼Œé€æ­¥å‘ä¸Šæ„å»ºå‡ºèƒ½å¤Ÿè§£ææ•´ä¸ªç¨‹åºçš„å‡½æ•°ã€‚
///
/// ---
///
/// ## ğŸ¯ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šè§£æåŸå­è¡¨è¾¾å¼ï¼ˆAtomExprï¼‰
///
/// **åŸå­è¡¨è¾¾å¼ï¼ˆAtomExprï¼‰**æ˜¯æ‰€æœ‰å¤æ‚è¡¨è¾¾å¼çš„åŸºçŸ³ã€‚å®ƒä»¬æ˜¯ä¸èƒ½å†è¢«åˆ†è§£çš„æœ€å°è¡¨è¾¾å¼å•å…ƒã€‚
///
/// è¯·åœ¨ `parser/atom_expr.mbt` æ–‡ä»¶ä¸­å®ç° `parse_atom_expr` å‡½æ•°ã€‚
///
/// **ä½ çš„ç›®æ ‡æ˜¯è®©å®ƒèƒ½å¤ŸæˆåŠŸè§£æä»¥ä¸‹åŸºç¡€å…ƒç´ ï¼š**
///
/// * **æ•°å­—ï¼š** `42`, `3.14`
/// * **å¸ƒå°”å€¼ï¼š** `true`, `false`
/// * **æ ‡è¯†ç¬¦ï¼š** `my_variable`
/// * **å­—ç¬¦ä¸²ï¼š** `"hello world"`
///
/// **å‡½æ•°ç­¾åï¼ˆå…³é”®ï¼ï¼‰:**
///
/// ```moonbit
/// parse_atom_expr: (ArrayView[Token]) -> (AtomExpr, ArrayView[Token])
/// ```
///
/// * **è¾“å…¥ï¼š** æ¥å—å½“å‰çš„ `Token` è§†å›¾ã€‚
/// * **è¾“å‡ºï¼š** è¿”å›ä¸€ä¸ª `Tuple`ï¼ŒåŒ…å«ï¼š
///     1.  è§£æå¾—åˆ°çš„ `AtomExpr` èŠ‚ç‚¹ã€‚
///     2.  **å‰©ä½™çš„ `Token` è§†å›¾ï¼ˆå¿…é¡»è·³è¿‡å·²æ¶ˆè€—çš„ Tokenï¼ï¼‰**ã€‚
///
/// **å®ç°æ€è·¯ï¼š**
/// æ£€æŸ¥å½“å‰ Token çš„ `kind`ã€‚å¦‚æœå®ƒåŒ¹é… `Int(_)`ã€`Double(_)`ã€`Bool(_)`ã€`Lower(_)` æˆ– `String(_)`ï¼Œåˆ™ï¼š
/// 1.  æ„é€ å¯¹åº”çš„ `AtomExpr` ç»“æ„ä½“ã€‚
/// 2.  è¿”å›ç»“æœï¼Œå¹¶å°† `Token` è§†å›¾å‘å‰æ¨è¿›ä¸€ä½ã€‚
/// 3.  å¦‚æœä¸åŒ¹é…ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ï¼ˆ`raise ParseError`ï¼‰ï¼Œè¡¨ç¤ºè¯­æ³•è§£æå¤±è´¥ã€‚
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// åœ¨å®Œæˆå®ç°åï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç²¾ç¡®è¿è¡Œä½ çš„æµ‹è¯•ï¼š
///
/// ```bash
/// moon test -p parser -f parse_simple_atom_expr_test.mbt
/// ```
///
/// ---
///
/// ## ğŸ’¡ æŠ€æœ¯å®å…¸ï¼šToken è§£æ„ä¸æ¨¡å¼åŒ¹é…
///
/// åœ¨è¯­æ³•åˆ†æé˜¶æ®µï¼ŒToken çš„è§£æ„æ˜¯ä½ çš„ä¸»è¦å·¥å…·ã€‚MoonBit å¼ºå¤§çš„æ¨¡å¼åŒ¹é…èƒ½è®©ä»£ç æå…¶ç®€æ´ï¼š
///
/// æˆ‘ä»¬çš„ `Token` ç»“æ„ï¼š`struct Token { kind: TokenKind }`
///
/// **ç›´æ¥åŒ¹é… Token æ•°ç»„å’Œç»“æ„ä½“ï¼š**
///
/// è¦è§£æä¸€ä¸ª `Int` ç±»å‹çš„åŸå­è¡¨è¾¾å¼ï¼Œä½ åªéœ€è¦ä¸€æ¬¡æ¨¡å¼åŒ¹é…å°±èƒ½å®Œæˆæå–å’Œæ¨è¿› Token è§†å›¾çš„æ“ä½œï¼š
///
/// ```moonbit
/// let tokens : ArrayView[Token] = ...
///
/// match tokens {
///     // æ¨¡å¼åŒ¹é…ï¼šå¦‚æœ Token è§†å›¾ä»¥ { kind: Int(value), ... } å¼€å¤´
///     [ { kind: Int(value) }, ..rest_tokens ] => {
///         // æˆåŠŸåŒ¹é…ï¼ value æ˜¯æ•´æ•°çš„å®é™…å€¼
///         // rest_tokens æ˜¯è§†å›¾ä¸­å‰©ä¸‹çš„éƒ¨åˆ†
///         // ... æ„é€  AtomExpr å¹¶è¿”å› (AtomExpr, rest_tokens)
///     }
///     // å…¶ä»– Token ç±»å‹...
///     _ => raise ParseError("æœŸæœ› ...ï¼Œä½†é‡åˆ°æ„å¤–çš„ Token ...")
/// }
/// ```
///
/// è¿™ç§å¼ºå¤§çš„è§£æ„èƒ½åŠ›èƒ½å¤Ÿè®©ä½ è½»æ¾å¤„ç†å„ç§ Token ç±»å‹ï¼Œå¹¶ä¸”ä»£ç ç®€æ´æ˜“è¯»ã€‚
///
/// **ç¥ä½ æˆåŠŸï¼è¿ˆå‡ºæ„å»º AST çš„ç¬¬ä¸€æ­¥ï¼**
/// ================================================================================

///|
test "Simple AtomExpr Parsing Test" {
  let code =
    #|42 3.14 true false
    #|foo bar "hello minimoonbit"
  let tokens = @lexer.tokenize(code)
  let (a, tok_view) = parse_atom_expr(tokens[:])
  assert_true(a.kind is Int(42))
  let (a, tok_view) = parse_atom_expr(tok_view)
  assert_true(a.kind is Double(3.14))
  let (a, tok_view) = parse_atom_expr(tok_view)
  assert_true(a.kind is Bool(true))
  let (a, tok_view) = parse_atom_expr(tok_view)
  assert_true(a.kind is Bool(false))
  let (a, tok_view) = parse_atom_expr(tok_view)
  assert_true(a.kind is Ident("foo"))
  let (a, tok_view) = parse_atom_expr(tok_view)
  assert_true(a.kind is Ident("bar"))
  let (a, _) = parse_atom_expr(tok_view)
  assert_true(a.kind is String("hello minimoonbit"))
}
