/// ================================================================================
/// # LLVM Codegen: ç”Ÿæˆé¡¶å±‚å‡½æ•°
///
/// æ­å–œä½ ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† KNF IR çš„å­¦ä¹ ï¼ŒçŽ°åœ¨æ­£å¼è¿›å…¥ä»£ç ç”Ÿæˆçš„æœ€åŽé˜¶æ®µï¼š**LLVM IR ç”Ÿæˆ**ã€‚
/// åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¼šå°† KNF å½¢å¼çš„ç¨‹åºé€ä¸€è½¬æ¢ä¸º LLVM IRã€‚
///
/// ## ðŸ’¡ ä¸¤é˜¶æ®µä»£ç ç”Ÿæˆï¼ˆTwo-Pass Codegenï¼‰
///
/// ä¸ŽKnfç±»ä¼¼ï¼Œllvmä»£ç ç”Ÿæˆä¹Ÿé‡‡ç”¨â€œä¸¤é˜¶æ®µâ€ç­–ç•¥æ¥å¤„ç†å‡½æ•°é—´çš„ç›¸äº’è°ƒç”¨å’Œé€’å½’ã€‚
///
/// 1.  **ç¬¬ä¸€é˜¶æ®µï¼ˆæ”¶é›†ï¼‰**ï¼šéåŽ†æ•´ä¸ª KNF ç¨‹åºï¼Œä½†ä¸ç”Ÿæˆä»»ä½•å‡½æ•°ä½“ã€‚æˆ‘ä»¬åªæ”¶é›†æ‰€æœ‰å‡½æ•°å’Œç»“æž„ä½“çš„â€œç­¾åâ€ä¿¡æ¯ï¼Œ
///     å¹¶åœ¨ LLVM ä¸­åˆ›å»ºå¯¹åº”çš„ã€ä½†å°šæ— å†…å®¹çš„å‡½æ•°ï¼ˆFunctionï¼‰å’Œç»“æž„ä½“ç±»åž‹ï¼ˆStructTypeï¼‰ã€‚
///     è¿™æ ·ï¼ŒLLVM å°±çŸ¥é“äº†æ¯ä¸ªå‡½æ•°çš„åå­—ã€å‚æ•°å’Œè¿”å›žç±»åž‹ã€‚
///
/// 2.  **ç¬¬äºŒé˜¶æ®µï¼ˆç”Ÿæˆï¼‰**ï¼šå†æ¬¡éåŽ† KNF ç¨‹åºï¼Œè¿™æ¬¡æˆ‘ä»¬çœŸæ­£è¿›å…¥æ¯ä¸ªå‡½æ•°å†…éƒ¨ï¼Œç”Ÿæˆå…¶å‡½æ•°ä½“çš„ LLVM IR æŒ‡ä»¤ã€‚
///     ç”±äºŽç¬¬ä¸€é˜¶æ®µå·²ç»åˆ›å»ºäº†æ‰€æœ‰å‡½æ•°çš„å£°æ˜Žï¼Œæ‰€ä»¥åœ¨ç”Ÿæˆå‡½æ•°ä½“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°è°ƒç”¨å…¶ä»–ä»»ä½•å‡½æ•°ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯å®Œæˆç¬¬ä¸€é˜¶æ®µçš„å¤§éƒ¨åˆ†å·¥ä½œï¼Œå¹¶ä¸ºç¬¬äºŒé˜¶æ®µç”Ÿæˆä¸€ä¸ªæœ€ç®€å•çš„å‡½æ•°ã€‚
///
/// ### 1. é˜…è¯»å¹¶å®žçŽ° `context.mbt`
///
/// é¦–å…ˆï¼Œè¯·ä»”ç»†é˜…è¯» `codegen/context.mbt` æ–‡ä»¶ã€‚ä½ éœ€è¦å®žçŽ°ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒçš„â€œæ”¶é›†â€å‡½æ•°ï¼š
///
///   - `collect_struct_types(struct_defs)`: éåŽ† KNF çš„ç»“æž„ä½“å®šä¹‰ï¼Œå¹¶åœ¨ LLVM ä¸­åˆ›å»ºå¯¹åº”çš„ `StructType`ã€‚
///   - `collect_func_values(functions)`: éåŽ† KNF çš„å‡½æ•°å®šä¹‰ï¼Œå¹¶åœ¨ LLVM ä¸­åˆ›å»ºå¯¹åº”çš„ `Function` **å£°æ˜Ž**ã€‚
///     **æ³¨æ„**ï¼šåœ¨è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬**æš‚æ—¶ä¸å¤„ç†å‡½æ•°ä½“**ï¼Œåªåˆ›å»ºå‡½æ•°çš„ç­¾åã€‚
///
/// ### 2. å®žçŽ° `top_function_codegen`
///
/// æŽ¥ä¸‹æ¥ï¼Œåœ¨ `codegen/top_function.mbt` ä¸­ï¼Œä½ éœ€è¦å®žçŽ° `top_function_codegen` å‡½æ•°ã€‚
/// è¿™ä¸ªå‡½æ•°è´Ÿè´£ä¸ºå•ä¸ª KNF å‡½æ•°ç”Ÿæˆå®Œæ•´çš„ LLVM IRï¼ŒåŒ…æ‹¬å‡½æ•°ä½“ã€‚
///
/// **LLVM API å…³é”®æç¤ºï¼š**
///
/// - **åˆ›å»ºåŸºæœ¬å—**ï¼šä¸€ä¸ªå‡½æ•°è‡³å°‘éœ€è¦ä¸€ä¸ªå…¥å£åŸºæœ¬å—ï¼ˆBasic Blockï¼‰ã€‚ä½¿ç”¨ `@llvm.Function::addBasicBlock` æ¥åˆ›å»ºå®ƒã€‚
///
/// - **è®¾ç½®æ’å…¥ç‚¹**ï¼šåœ¨ç”ŸæˆæŒ‡ä»¤ä¹‹å‰ï¼Œä½ å¿…é¡»å‘Šè¯‰ LLVM æŒ‡ä»¤åº”è¯¥è¢«æ’å…¥åˆ°å“ªé‡Œã€‚ä½¿ç”¨ `@llvm.IRBuilder::setInsertPoint` å°†æ’å…¥ç‚¹è®¾ç½®åˆ°ä½ åˆ›å»ºçš„åŸºæœ¬å—ä¸Šã€‚
///
/// - **åˆ›å»ºè¿”å›žæŒ‡ä»¤**ï¼šä¸€ä¸ªåˆæ³•çš„ LLVM åŸºæœ¬å—å¿…é¡»ä»¥ä¸€ä¸ªâ€œç»ˆç»“æŒ‡ä»¤â€ï¼ˆTerminator Instructionï¼‰ç»“æŸï¼Œæœ€å¸¸è§çš„å°±æ˜¯è¿”å›žæŒ‡ä»¤ã€‚
///   - å¦‚æžœå‡½æ•°æœ‰è¿”å›žå€¼ï¼Œä½¿ç”¨ `builder.createRet(...)`ã€‚
///   - å¦‚æžœå‡½æ•°è¿”å›ž `Unit` (å³ C ä¸­çš„ `void`)ï¼Œä½¿ç”¨ `builder.createRetVoid()`ã€‚
///   - ä½ éœ€è¦åˆ¤æ–­å‡½æ•°çš„è¿”å›žç±»åž‹ï¼Œä»¥å†³å®šæ˜¯å¦ä»¥åŠå¦‚ä½•æ·»åŠ  `ret` æŒ‡ä»¤ã€‚
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_empty_top_func_test.mbt` å°†ä¼šæ£€æŸ¥ä½ æ˜¯å¦èƒ½ä¸ºä¸€ä¸ªæ²¡æœ‰å‚æ•°å’Œå…·ä½“é€»è¾‘çš„ç©ºå‡½æ•°æ­£ç¡®ç”Ÿæˆ LLVM IRã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚
/// ================================================================================

///|
///
/// åŠ¡å¿…æ³¨æ„ï¼Œä»»ä½•çš„å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯éšå¼ä¼ å…¥çš„çŽ¯å¢ƒæŒ‡é’ˆã€‚
/// æ— è®ºå®ƒæ˜¯å¦æ˜¯Top Level Functionï¼Œä¹Ÿæ— è®ºå®ƒæ˜¯å¦ä»Žè¯æ³•çŽ¯å¢ƒä¸­æ•èŽ·äº†å˜é‡ã€‚
///
/// è¿™æ ·æ‰èƒ½æ›´æ–¹ä¾¿åœ°æ”¯æŒé—­åŒ…çš„å®žçŽ°ã€‚
test "Codegen for Empty Top Function Test" {

  let code = 
    #|fn foo() -> Unit {}
    #|
    #|fn bar(x: Int, y: Double) -> Unit {}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  // foo 
  let foo = knf_prog.functions.get("foo").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(foo)
  inspect(
    llvm_func,
    content=(
      #|define void @foo(ptr %0) {
      #|entry:
      #|  ret void
      #|}
      #|
    )
  )

  // bar
  let bar = knf_prog.functions.get("bar").unwrap()
  let llvm_func2 = codegen_ctx.top_function_codegen(bar)
  inspect(
    llvm_func2,
    content=(
      #|define void @bar(ptr %0, i32 %1, double %2) {
      #|entry:
      #|  ret void
      #|}
      #|
    )
  )
}
