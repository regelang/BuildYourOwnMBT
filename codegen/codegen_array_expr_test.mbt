/// ================================================================================
/// # LLVM Codegen: æ•°ç»„å­—é¢é‡
/// ================================================================================
///
/// æˆ‘ä»¬å·²ç»å­¦ä¹ äº† `Array::make`ï¼ŒçŽ°åœ¨æˆ‘ä»¬æ¥å¤„ç†å¦ä¸€ç§æ›´ç›´è§‚çš„æ•°ç»„åˆ›å»ºæ–¹å¼ï¼š**æ•°ç»„å­—é¢é‡ï¼ˆArray Literalsï¼‰**ï¼Œä¾‹å¦‚ `[1, 2, 3]`ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯æ‰©å±• `expr_codegen` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç† `KnfExpr::ArrayLiteral` è¡¨è¾¾å¼ã€‚
///
/// ## ðŸ’¡ å®žçŽ°æŒ‡å—ï¼šä¸‰æ­¥èµ°
///
/// ç”Ÿæˆæ•°ç»„å­—é¢é‡çš„ä»£ç å¯ä»¥åˆ†è§£ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š
///
/// 1.  **åˆ›å»ºç©ºæ•°ç»„**:
///     é¦–å…ˆï¼Œè°ƒç”¨æˆ‘ä»¬ä¹‹å‰å®žçŽ°çš„ `make_..._array` å†…å»ºå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæŒ‡å®šå¤§å°ä½†å†…å®¹ä¸ºé»˜è®¤å€¼çš„æ•°ç»„ã€‚
///     - **å¤§å°**: æ•°ç»„å­—é¢é‡ä¸­çš„å…ƒç´ æ•°é‡ã€‚
///     - **åˆå§‹å€¼**: å¯ä»¥æ˜¯è¯¥ç±»åž‹çš„ä»»æ„é»˜è®¤å€¼ï¼ˆä¾‹å¦‚ `0` æˆ– `false`ï¼‰ï¼Œå› ä¸ºå®ƒé©¬ä¸Šå°±ä¼šè¢«è¦†ç›–ã€‚
///
/// 2.  **é€ä¸ªå¡«å……å…ƒç´ **:
///     éåŽ†æ•°ç»„å­—é¢é‡ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚å¯¹äºŽæ¯ä¸ªå…ƒç´ ï¼Œç”Ÿæˆä¸€ä¸ª `array_..._put` è°ƒç”¨ï¼Œ
///     å°†å…ƒç´ çš„å€¼è®¾ç½®åˆ°æ•°ç»„å¯¹åº”çš„ç´¢å¼•ä½ç½®ä¸Šã€‚
///
/// 3.  **è¿”å›žæ•°ç»„**:
///     æœ€åŽï¼Œè¿”å›žç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„æ•°ç»„çš„æŒ‡é’ˆã€‚
///
/// ç®€å•æ¥è¯´ï¼Œ`[1, 2, 3]` çš„ä»£ç ç”Ÿæˆé€»è¾‘ç­‰ä»·äºŽï¼š
///
/// ```skip
/// let __internal_array = Array::make(3, 0); // æ­¥éª¤ 1
/// __internal_array[0] = 1;                  // æ­¥éª¤ 2
/// __internal_array[1] = 2;
/// __internal_array[2] = 3;
/// __internal_array;                         // æ­¥éª¤ 3
/// ```
///
/// åŒæ ·ï¼Œä½ éœ€è¦æ ¹æ®æ•°ç»„çš„å…ƒç´ ç±»åž‹ï¼Œä»Ž `Context` çš„ `builtin_funcs` ä¸­é€‰æ‹©æ­£ç¡®çš„ `make` å’Œ `put` å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ `createCall` æ¥è°ƒç”¨å®ƒä»¬ã€‚
///
/// ---
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_array_expr_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½ä¸ºæ•°ç»„å­—é¢é‡æ­£ç¡®ç”Ÿæˆåˆ›å»ºå’Œå¡«å……æŒ‡ä»¤ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

test "Codegen for Array Literal Test" {

  let code = 
    #|fn create_arr() -> Array[Int] {
    #|  [1, 2, 3];
    #|}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  // codegen
  let create_arr = knf_prog.functions.get("create_arr").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(create_arr)
  inspect(llvm_func, content=(
    
    #|define ptr @create_arr(ptr %0) {
    #|entry:
    #|  %1 = call ptr @minimbt_create_array(i32 3, i32 0)
    #|  %2 = getelementptr i32, ptr %1, i32 0
    #|  store i32 1, ptr %2, align 4
    #|  %4 = getelementptr i32, ptr %1, i32 1
    #|  store i32 2, ptr %4, align 4
    #|  %6 = getelementptr i32, ptr %1, i32 2
    #|  store i32 3, ptr %6, align 4
    #|  ret ptr %1
    #|}
    #|

  ))
}
