/// ================================================================================
/// # LLVM Codegen: å—è¡¨è¾¾å¼
/// ================================================================================
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥å¤„ç†å¤§éƒ¨åˆ†ç‹¬ç«‹çš„è¡¨è¾¾å¼å’Œè¯­å¥äº†ã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬æ¥å¤„ç†å®ƒä»¬çš„é›†åˆï¼š**å—è¡¨è¾¾å¼ï¼ˆBlock Expressionsï¼‰**ã€‚
///
/// åœ¨ LLVM IR ä¸­ï¼Œä»£ç çš„åŸºæœ¬å•å…ƒæ˜¯**åŸºæœ¬å—ï¼ˆBasic Blockï¼‰**ã€‚ä¸€ä¸ªåŸºæœ¬å—æ˜¯ä¸€ç³»åˆ—è¿žç»­çš„ã€ä¸­é—´æ²¡æœ‰ä»»ä½•è·³è½¬çš„æŒ‡ä»¤ï¼Œå¹¶ä»¥ä¸€ä¸ªâ€œç»ˆç»“æŒ‡ä»¤â€ï¼ˆå¦‚ `br` æˆ– `ret`ï¼‰ç»“æŸã€‚
///
/// ä¸ºäº†æ­£ç¡®åœ°ç”Ÿæˆå—è¡¨è¾¾å¼çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„åŸºæœ¬å—ï¼Œä»¥éš”ç¦»å…¶å†…éƒ¨çš„æŒ‡ä»¤åºåˆ—ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯å®žçŽ° `block_codegen` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç† `KnfExpr::Block` è¡¨è¾¾å¼ã€‚
///
/// ## ðŸ’¡ å®žçŽ°æŒ‡å—ï¼šåˆ›å»ºä¸Žè·³è½¬
///
/// ç”Ÿæˆå—è¡¨è¾¾å¼ä»£ç çš„æ ¸å¿ƒåœ¨äºŽæ­£ç¡®åœ°ç®¡ç†æŽ§åˆ¶æµã€‚è¿™é€šå¸¸éœ€è¦åˆ›å»ºè‡³å°‘ä¸¤ä¸ªæ–°çš„åŸºæœ¬å—ã€‚
///
/// å‡è®¾æˆ‘ä»¬å½“å‰çš„æŒ‡ä»¤æ’å…¥ç‚¹åœ¨ `current_bb`ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆ `{...}` çš„ä»£ç ï¼š
///
/// 1.  **èŽ·å–å½“å‰å‡½æ•°**:
///     é¦–å…ˆï¼Œä½ éœ€è¦çŸ¥é“ä½ æ­£åœ¨ä¸ºå“ªä¸ªå‡½æ•°æ·»åŠ åŸºæœ¬å—ã€‚
///     - **æŽ¥å£**: `builder.getInsertFunction()`
///
/// 2.  **åˆ›å»ºæ–°åŸºæœ¬å—**:
///     ä½¿ç”¨èŽ·å–åˆ°çš„å‡½æ•°å¯¹è±¡ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„åŸºæœ¬å—ï¼šä¸€ä¸ªç”¨äºŽå—è¡¨è¾¾å¼æœ¬èº«ï¼ˆ`block_bb`ï¼‰ï¼Œå¦ä¸€ä¸ªç”¨äºŽå—è¡¨è¾¾å¼ä¹‹åŽçš„æ‰€æœ‰ä»£ç ï¼ˆ`after_bb`ï¼‰ã€‚
///     - **æŽ¥å£**: `current_func.addBasicBlock()`
///
/// 3.  **è·³è½¬åˆ°æ–°å—**:
///     åœ¨ `current_bb` çš„æœ«å°¾ï¼Œæ·»åŠ ä¸€ä¸ªæ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œå°†æŽ§åˆ¶æµå¯¼å‘ `block_bb`ã€‚
///     - **æŽ¥å£**: `builder.createBr(block_bb)`
///
/// 4.  **ç”Ÿæˆå—å†…ä»£ç **:
///     a. å°†æŒ‡ä»¤ç”Ÿæˆå™¨çš„æ’å…¥ç‚¹ç§»åŠ¨åˆ° `block_bb`ã€‚
///        - **æŽ¥å£**: `builder.setInsertPoint(block_bb)`
///     b. éåŽ†å—è¡¨è¾¾å¼ä¸­çš„æ‰€æœ‰è¯­å¥ï¼Œå¹¶ä¸ºå®ƒä»¬ç”Ÿæˆä»£ç ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è°ƒç”¨ `stmt_codegen`ï¼‰ã€‚
///
/// 5.  **ä»Žå—ä¸­è·³å‡º**:
///     åœ¨ `block_bb` çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ç”Ÿæˆå®Œæ¯•åŽï¼Œåœ¨å…¶æœ«å°¾æ·»åŠ ä¸€ä¸ªæ— æ¡ä»¶è·³è½¬ï¼Œå°†æŽ§åˆ¶æµå¯¼å‘ `after_bb`ã€‚
///     - **æŽ¥å£**: `builder.createBr(after_bb)`
///
/// 6.  **ç»§ç»­åŽç»­ä»£ç ç”Ÿæˆ**:
///     æœ€åŽï¼Œå°†æŒ‡ä»¤ç”Ÿæˆå™¨çš„æ’å…¥ç‚¹ç§»åŠ¨åˆ° `after_bb`ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥ç»§ç»­ç”Ÿæˆå—è¡¨è¾¾å¼ä¹‹åŽçš„ä»£ç äº†ã€‚
///     - **æŽ¥å£**: `builder.setInsertPoint(after_bb)`
///
/// ---
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_block_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½ä¸ºä¸€ä¸ªå—è¡¨è¾¾å¼æ­£ç¡®åœ°åˆ›å»ºåŸºæœ¬å—å¹¶ç®¡ç†è·³è½¬ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

///|
///
test "Codegen for Simple Let and LetMut Test" {

  let code = 
    #|fn foo(x: Int, y: Int) -> Int {
    #|  let z = { let a = x + 1; let b = y -1; a * b };
    #|  z
    #|}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  // foo
  let foo = knf_prog.functions.get("foo").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(foo)
  inspect(llvm_func, content=(
    
    #|define i32 @foo(ptr %0, i32 %1, i32 %2) {
    #|entry:
    #|  br label %4
    #|
    #|4:                                     ; preds = %entry
    #|  %5 = add i32 %1, 1
    #|  %6 = sub i32 %2, 1
    #|  %7 = mul i32 %5, %6
    #|  br label %9
    #|
    #|9:                                     ; preds = %4
    #|  ret i32 %7
    #|}
    #|
  ))
}