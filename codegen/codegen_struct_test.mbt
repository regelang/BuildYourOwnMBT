/// ================================================================================
/// # LLVM Codegen: ç»“æ„ä½“æ“ä½œ
/// ================================================================================
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥å¤„ç†æ•°ç»„äº†ï¼Œç°åœ¨æˆ‘ä»¬æ¥å¤„ç†å¦ä¸€ç§é‡è¦çš„å¤åˆç±»å‹ï¼š**ç»“æ„ä½“ï¼ˆStructsï¼‰**ã€‚
/// è¿™åŒ…æ‹¬ç»“æ„ä½“çš„åˆ›å»ºã€å­—æ®µçš„è¯»å–å’Œå­—æ®µçš„æ›´æ–°ã€‚è¿™äº›æ“ä½œçš„æ ¸å¿ƒéƒ½ç¦»ä¸å¼€ä¸€æ¡å…³é”®æŒ‡ä»¤ï¼š`getelementptr`ã€‚
///
/// ## ğŸ’¡ æ ¸å¿ƒæŒ‡ä»¤ï¼š`getelementptr` (GEP)
///
/// `getelementptr`ï¼ˆè·å–å…ƒç´ æŒ‡é’ˆï¼‰æ˜¯ LLVM ä¸­ç”¨äºåœ°å€è®¡ç®—çš„æŒ‡ä»¤ã€‚å®ƒ**ä¸è®¿é—®å†…å­˜**ï¼Œ
/// è€Œæ˜¯æ ¹æ®åŸºåœ°å€å’Œç´¢å¼•ï¼Œè®¡ç®—å‡ºç»“æ„ä½“æˆ–æ•°ç»„ä¸­æŸä¸ªå…ƒç´ çš„å†…å­˜åœ°å€ã€‚
///
/// ### GEP æŒ‡ä»¤æ ¼å¼
///
/// å½“æˆ‘ä»¬æƒ³è·å–ä¸€ä¸ªç»“æ„ä½“å®ä¾‹ä¸­æŸä¸ªå­—æ®µçš„æŒ‡é’ˆæ—¶ï¼ŒGEP æŒ‡ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š
///
/// `%field_ptr = getelementptr %MyStruct, ptr %struct_ptr, i32 0, i32 <field_index>`
///
/// - `%MyStruct`: è¿™æ˜¯ç»“æ„ä½“çš„ç±»å‹ã€‚
/// - `ptr %struct_ptr`: è¿™æ˜¯æŒ‡å‘ç»“æ„ä½“å®ä¾‹çš„åŸºåœ°å€æŒ‡é’ˆã€‚
/// - `i32 0`: ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚å®ƒç”¨äºâ€œç©¿è¿‡â€`%struct_ptr` æŒ‡é’ˆã€‚åœ¨è®¿é—®ç»“æ„ä½“å­—æ®µæ—¶ï¼Œè¿™ä¸ªç´¢å¼•**æ€»æ˜¯ 0**ã€‚
/// - `i32 <field_index>`: ç¬¬äºŒä¸ªç´¢å¼•ï¼Œä»£è¡¨ä½ æƒ³è¦è®¿é—®çš„å­—æ®µåœ¨ç»“æ„ä½“å®šä¹‰ä¸­çš„**åºå·**ï¼ˆä» 0 å¼€å§‹ï¼‰ã€‚
///
/// ä¾‹å¦‚ï¼Œå¯¹äº `struct Point { x: Int; y: Int; }`ï¼Œå­—æ®µ `y` çš„ç´¢å¼•å°±æ˜¯ `1`ã€‚
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯å®ç°ç»“æ„ä½“çš„åˆ›å»ºã€è®¿é—®å’Œæ›´æ–°ã€‚
///
/// ### 1. ç»“æ„ä½“åˆ›å»º (`CreateStruct`)
///
/// åœ¨ `expr_codegen` ä¸­å¤„ç† `CreateStruct` æ—¶ï¼š
/// a. **åˆ†é…å†…å­˜**: ä¸æ•°ç»„ç±»ä¼¼ï¼Œç»“æ„ä½“å®ä¾‹ä¹Ÿå­˜æ”¾åœ¨å †ä¸Šã€‚ä½ éœ€è¦è°ƒç”¨ `moonbit_malloc` å†…å»ºå‡½æ•°æ¥ä¸ºå…¶åˆ†é…å†…å­˜ã€‚åˆ†é…çš„å¤§å°å¯ä»¥é€šè¿‡ `module.getDataLayout().getTypeAllocSize(struct_ty)` æ¥è·å–ã€‚
/// b. **å¡«å……å­—æ®µ**: éå†æ‰€æœ‰éœ€è¦åˆå§‹åŒ–çš„å­—æ®µã€‚å¯¹äºæ¯ä¸ªå­—æ®µï¼š
///    i.  ä½¿ç”¨ `getelementptr` è®¡ç®—å‡ºè¯¥å­—æ®µçš„åœ°å€ã€‚
///    ii. ä½¿ç”¨ `builder.createStore` å°†åˆå§‹å€¼å­˜å…¥è¯¥åœ°å€ã€‚
///
/// ### 2. å­—æ®µè®¿é—® (`FieldAccess`)
///
/// åœ¨ `expr_codegen` ä¸­å¤„ç† `FieldAccess` æ—¶ï¼š
/// a. **è·å–å­—æ®µæŒ‡é’ˆ**: ä½¿ç”¨ `getelementptr` è®¡ç®—å‡ºå­—æ®µçš„åœ°å€ã€‚
/// b. **åŠ è½½å€¼**: ä½¿ç”¨ `builder.createLoad` ä»è¯¥åœ°å€åŠ è½½å­—æ®µçš„å€¼ã€‚
///
/// ### 3. å­—æ®µæ›´æ–° (`StructFieldSet`)
///
/// åœ¨ `stmt_codegen` ä¸­æ·»åŠ å¯¹ `StructFieldSet` çš„å¤„ç†ï¼š
/// a. **è·å–å­—æ®µæŒ‡é’ˆ**: åŒæ ·ï¼Œä½¿ç”¨ `getelementptr` è®¡ç®—å‡ºå­—æ®µçš„åœ°å€ã€‚
/// b. **å­˜å‚¨æ–°å€¼**: ä½¿ç”¨ `builder.createStore` å°†æ–°å€¼å­˜å…¥è¯¥åœ°å€ã€‚
///
/// ---
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_struct_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½æ­£ç¡®åœ°ä¸ºç»“æ„ä½“çš„åˆ›å»ºã€è®¿é—®å’Œæ›´æ–°ç”Ÿæˆä»£ç ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

///|
///
test "Codegen for Struct Create, Access and Set Test" {

  let code = 
    #|struct Point {
    #|  mut x: Int;
    #|  mut y: Int;
    #|}
    #|
    #|fn create_point() -> Point {
    #|  let p = Point::{ x: 10, y: 20 };
    #|  p;
    #|}
    #|
    #|fn swap_x_y(p: Point) -> Unit {
    #|  let t = p.x;
    #|  p.x = p.y;
    #|  p.y = t;
    #|}
  

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)
  codegen_ctx.collect_struct_types(knf_prog.struct_defs)

  // codegen for create_point
  let create_point = knf_prog.functions.get("create_point").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(create_point)
  inspect(llvm_func, content=(
    #|define ptr @create_point(ptr %0) {
    #|entry:
    #|  %1 = call ptr @minimbt_malloc(i32 8)
    #|  %2 = getelementptr %Point, ptr %1, i32 0, i32 0
    #|  store i32 10, ptr %2, align 4
    #|  %4 = getelementptr %Point, ptr %1, i32 0, i32 1
    #|  store i32 20, ptr %4, align 4
    #|  ret ptr %1
    #|}
    #|
  ))

  // codegen for swap_x_y
  let swap_x_y = knf_prog.functions.get("swap_x_y").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(swap_x_y)
  inspect(llvm_func, content=(
    #|define void @swap_x_y(ptr %0, ptr %1) {
    #|entry:
    #|  %2 = getelementptr %Point, ptr %1, i32 0, i32 0
    #|  %3 = load i32, ptr %2, align 4
    #|  %4 = getelementptr %Point, ptr %1, i32 0, i32 1
    #|  %5 = load i32, ptr %4, align 4
    #|  %6 = getelementptr %Point, ptr %1, i32 0, i32 0
    #|  store i32 %5, ptr %6, align 4
    #|  %8 = getelementptr %Point, ptr %1, i32 0, i32 1
    #|  store i32 %3, ptr %8, align 4
    #|  ret void
    #|}
    #|


  ))
}