/// ================================================================================
/// # LLVM Codegen: èµ‹å€¼è¯­å¥
/// ================================================================================
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥å£°æ˜Žå¯å˜å˜é‡äº†ï¼ŒçŽ°åœ¨æˆ‘ä»¬æ¥å¤„ç†å¯¹å®ƒä»¬è¿›è¡Œ**èµ‹å€¼**çš„æ“ä½œã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯å®žçŽ° `assign_stmt_codegen` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç† `KnfStmt::Assign` è¯­å¥ã€‚
///
/// ## ðŸ’¡ å®žçŽ°æŒ‡å—
///
/// å¹¸è¿çš„æ˜¯ï¼ŒKNF å˜æ¢é˜¶æ®µå·²ç»ä¸ºæˆ‘ä»¬å®Œæˆäº†å¤§éƒ¨åˆ†å¤æ‚çš„å·¥ä½œã€‚åœ¨ KNF æ ¼å¼ä¸­ï¼Œ
/// èµ‹å€¼æ“ä½œçš„ç›®æ ‡æ€»æ˜¯å·²ç»è¢«è§£æžæˆä¸€ä¸ªæ˜Žç¡®çš„ã€å¯å˜çš„å˜é‡åã€‚
///
/// å›žæƒ³ä¸€ä¸‹ï¼Œåœ¨ `let_mut_codegen` ä¸­ï¼Œæˆ‘ä»¬ä¸ºå¯å˜å˜é‡åˆ›å»ºäº†ä¸€ä¸ª `alloca` æŒ‡ä»¤ï¼Œ
/// å¹¶åœ¨ `Context` ä¸­å°†å˜é‡åæ˜ å°„åˆ°äº†è¿™ä¸ªæŒ‡å‘æ ˆå†…å­˜çš„**æŒ‡é’ˆ**ã€‚
///
/// å› æ­¤ï¼Œç”Ÿæˆèµ‹å€¼è¯­å¥çš„ä»£ç éžå¸¸ç›´æŽ¥ï¼š
///
/// 1.  **è®¡ç®—å³å€¼**ï¼šé¦–å…ˆï¼Œè°ƒç”¨ `expr_codegen` è®¡ç®—å‡ºèµ‹å€¼ç¬¦å·å³ä¾§è¡¨è¾¾å¼çš„ LLVM å€¼ã€‚
/// 2.  **æŸ¥æ‰¾æŒ‡é’ˆ**ï¼šä»Ž `Context` çš„ `name_values` ä¸­ï¼Œæ ¹æ®å·¦ä¾§å˜é‡åæŸ¥æ‰¾åˆ°å¯¹åº”çš„ `alloca` æŒ‡é’ˆã€‚
/// 3.  **å­˜å‚¨æ–°å€¼**ï¼šè°ƒç”¨ `builder.createStore(value, ptr)` æŒ‡ä»¤ï¼Œå°†ç¬¬ä¸€æ­¥è®¡ç®—å‡ºçš„æ–°å€¼å­˜å…¥è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åœ°å€ã€‚
///
/// æ­£å¦‚ä½ æ‰€è§ï¼Œè¿™ç¡®å®žæ˜¯æ¯”è¾ƒç®€å•çš„ä¸€å…³ï¼Œå› ä¸ºå¤æ‚çš„å·¦å€¼è§£æžï¼ˆå¦‚ `a[i].x = ...`ï¼‰å·²ç»åœ¨ KNF é˜¶æ®µè¢«åˆ†è§£äº†ã€‚
/// æˆ‘ä»¬çŽ°åœ¨è¦åšçš„ï¼Œåªæ˜¯æ‰§è¡Œä¸€ä¸ªç®€å•çš„ `store` æ“ä½œã€‚
///
/// ---
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_assign_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½ä¸ºä¸€ä¸ªç®€å•çš„èµ‹å€¼è¯­å¥æ­£ç¡®ç”Ÿæˆ `store` æŒ‡ä»¤ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

///|
///
test "Codegen for Simple Let and LetMut Test" {

  let code = 
    #|fn foo(x: Int) -> Int {
    #|  let mut z = 0;
    #|  z = x;
    #|  z
    #|}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  // foo
  let add = knf_prog.functions.get("foo").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(add)
  inspect(llvm_func, content=(
    
    #|define i32 @foo(ptr %0, i32 %1) {
    #|entry:
    #|  %2 = alloca i32, align 4
    #|  store i32 0, ptr %2, align 4
    #|  store i32 %1, ptr %2, align 4
    #|  %5 = load i32, ptr %2, align 4
    #|  ret i32 %5
    #|}
    #|
  ))
}