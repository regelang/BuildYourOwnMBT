/// ================================================================================
/// # LLVM Codegen: å…ƒç»„ (Tuples)
/// ================================================================================
///
/// åœ¨å¤„ç†å®Œç»“æž„ä½“ä¹‹åŽï¼Œæˆ‘ä»¬æ¥å¤„ç†ä¸€ä¸ªä¸Žå®ƒéžå¸¸ç›¸ä¼¼çš„å…„å¼Ÿï¼š**å…ƒç»„ï¼ˆTuplesï¼‰**ã€‚
///
/// ## ðŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼šå…ƒç»„å°±æ˜¯åŒ¿åçš„ç»“æž„ä½“
///
/// ä»Žä»£ç ç”Ÿæˆçš„è§’åº¦æ¥çœ‹ï¼Œå…ƒç»„å’Œç»“æž„ä½“åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªé“ç†ã€‚ä½ å¯ä»¥å°†ä¸€ä¸ªå…ƒç»„ `(Int, Double)`
/// æƒ³è±¡æˆä¸€ä¸ªåŒ¿åçš„ã€åªæœ‰å­—æ®µåºå·æ²¡æœ‰å­—æ®µåçš„ç»“æž„ä½“ `struct { Int; Double; }`ã€‚
///
/// - **å†…å­˜å¸ƒå±€**: å’Œç»“æž„ä½“ä¸€æ ·ï¼Œå…ƒç»„ä¹Ÿä½œä¸ºä¸€å—è¿žç»­çš„å†…å­˜å­˜åœ¨ï¼Œæˆ‘ä»¬åŒæ ·åœ¨**å †**ä¸Šä¸ºå…¶åˆ†é…ç©ºé—´ã€‚
/// - **å…ƒç´ è®¿é—®**: è®¿é—®å…ƒç»„çš„ç¬¬ `n` ä¸ªå…ƒç´ ï¼Œå°±å’Œè®¿é—®ç»“æž„ä½“çš„ç¬¬ `n` ä¸ªå­—æ®µå®Œå…¨ä¸€æ ·ã€‚
///
/// å› æ­¤ï¼Œç”Ÿæˆå…ƒç»„ç›¸å…³ä»£ç çš„é€»è¾‘ä¸Žæˆ‘ä»¬ä¸Šä¸€å…³å®žçŽ°çš„ç»“æž„ä½“é€»è¾‘é«˜åº¦é‡åˆã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯ä¸ºå…ƒç»„çš„åˆ›å»ºå’Œè®¿é—®ç”Ÿæˆä»£ç ã€‚
///
/// ### 1. å…ƒç»„åˆ›å»º (`TupleLiteral`)
///
/// åœ¨ `expr_codegen` ä¸­å¤„ç† `TupleLiteral` æ—¶ï¼š
/// a. **ç¡®å®šç±»åž‹**: é¦–å…ˆï¼Œä½ éœ€è¦æ ¹æ®å…ƒç»„ä¸­æ‰€æœ‰å…ƒç´ çš„ LLVM ç±»åž‹ï¼Œåœ¨ LLVM ä¸­åˆ›å»ºä¸€ä¸ªåŒ¿åçš„ç»“æž„ä½“ç±»åž‹ï¼Œä¾‹å¦‚ `{ i32, double, i1 }`ã€‚
/// b. **åˆ†é…å†…å­˜**: è°ƒç”¨ `moonbit_malloc` ä¸ºè¿™ä¸ªåŒ¿åç»“æž„ä½“åˆ†é…å †å†…å­˜ã€‚
/// c. **å¡«å……å…ƒç´ **: éåŽ†å…ƒç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå¯¹äºŽç¬¬ `i` ä¸ªå…ƒç´ ï¼š
///    i.  ä½¿ç”¨ `getelementptr` è®¡ç®—å‡ºç¬¬ `i` ä¸ªå…ƒç´ çš„åœ°å€ã€‚æŒ‡ä»¤æ ¼å¼ä¸ºï¼š`getelementptr {..types..}, ptr %tuple_ptr, i32 0, i32 i`
///    ii. ä½¿ç”¨ `builder.createStore` å°†å…ƒç´ å€¼å­˜å…¥è¯¥åœ°å€ã€‚
///
/// ### 2. å…ƒç»„è®¿é—® (`TupleAccess` æˆ– `let` è§£æž„)
///
/// åœ¨ `expr_codegen` ä¸­å¤„ç†å…ƒç»„è®¿é—®æ—¶ï¼ˆKNF å¯èƒ½ä¼šå°† `let (x,...) = t` è½¬æ¢ä¸ºå¯¹ `t` çš„ `TupleAccess`ï¼‰ï¼š
/// a. **èŽ·å–å…ƒç´ æŒ‡é’ˆ**: ä½¿ç”¨ `getelementptr` è®¡ç®—å‡ºè¦è®¿é—®çš„å…ƒç´ çš„åœ°å€ã€‚
/// b. **åŠ è½½å€¼**: ä½¿ç”¨ `builder.createLoad` ä»Žè¯¥åœ°å€åŠ è½½å…ƒç´ çš„å€¼ã€‚
///
/// ---
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_tuple_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½æ­£ç¡®åœ°ä¸ºå…ƒç»„çš„åˆ›å»ºå’Œè®¿é—®ç”Ÿæˆä»£ç ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

test "Codegen for Struct Create And Set Test" {

  let code = 
    #|fn first(a: (Int, Double, Bool)) -> Int {
    #|  let (x, _, _) = a;
    #|  x;
    #|}
    #|
    #|fn combine(a: Int, b: Double, c: Bool) -> (Int, Double, Bool) {
    #|  let x = (a, b, c);
    #|  x;
    #|}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)
  codegen_ctx.collect_struct_types(knf_prog.struct_defs)

  // 
  let first = knf_prog.functions.get("first").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(first)
  inspect(llvm_func, content=(
    
    #|define i32 @first(ptr %0, ptr %1) {
    #|entry:
    #|  %2 = getelementptr { i32, double, i1 }, ptr %1, i32 0, i32 0
    #|  %3 = load i32, ptr %2, align 4
    #|  %4 = getelementptr { i32, double, i1 }, ptr %1, i32 0, i32 1
    #|  %5 = load double, ptr %4, align 8
    #|  %6 = getelementptr { i32, double, i1 }, ptr %1, i32 0, i32 2
    #|  %7 = load i1, ptr %6, align 1
    #|  ret i32 %3
    #|}
    #|
  ))

  let combine = knf_prog.functions.get("combine").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(combine)
  inspect(llvm_func, content=(
    
    #|define ptr @combine(ptr %0, i32 %1, double %2, i1 %3) {
    #|entry:
    #|  %4 = call ptr @minimbt_malloc(i32 24)
    #|  %5 = getelementptr { i32, double, i1 }, ptr %4, i32 0, i32 0
    #|  store i32 %1, ptr %5, align 4
    #|  %7 = getelementptr { i32, double, i1 }, ptr %4, i32 0, i32 1
    #|  store double %2, ptr %7, align 8
    #|  %9 = getelementptr { i32, double, i1 }, ptr %4, i32 0, i32 2
    #|  store i1 %3, ptr %9, align 1
    #|  ret ptr %4
    #|}
    #|

  ))
}