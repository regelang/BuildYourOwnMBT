/// ================================================================================
/// # LLVM Codegen: é—­åŒ… (Closure)
/// ================================================================================
///
/// æ¬¢è¿Žæ¥åˆ°æœ¬ç« éš¾åº¦æœ€é«˜çš„ä¸€èŠ‚ï¼š**é—­åŒ…çš„ä»£ç ç”Ÿæˆ**ã€‚
/// é—­åŒ…æ˜¯â€œä»£ç â€å’Œå…¶â€œçŽ¯å¢ƒâ€çš„ç»“åˆä½“ã€‚ä»£ç æ˜¯å‡½æ•°ä½“æœ¬èº«ï¼Œè€ŒçŽ¯å¢ƒåˆ™æ˜¯å‡½æ•°å®šä¹‰æ—¶æ‰€åœ¨ä½œç”¨åŸŸä¸­è¢«å®ƒå¼•ç”¨çš„å˜é‡ï¼ˆå³â€œæ•èŽ·çš„å˜é‡â€ï¼‰ã€‚
/// åœ¨ä»£ç ç”Ÿæˆé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼æ¥å°†è¿™ä¸¤è€…æ‰“åŒ…åœ¨ä¸€èµ·ã€‚
///
/// ## ðŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼šé—­åŒ…å³ç»“æž„ä½“
///
/// æˆ‘ä»¬å°†ä¸€ä¸ªé—­åŒ…è¡¨ç¤ºä¸ºä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„**ç»“æž„ä½“**ã€‚è¿™ä¸ªç»“æž„ä½“çš„å¸ƒå±€æ˜¯çº¦å®šå¥½çš„ï¼š
///
/// - **ç¬¬ä¸€ä¸ªå­—æ®µ**: æ˜¯ä¸€ä¸ª**å‡½æ•°æŒ‡é’ˆ**ï¼ŒæŒ‡å‘é—­åŒ…å®žé™…çš„ä»£ç ã€‚
/// - **åŽç»­å­—æ®µ**: ä¾æ¬¡å­˜æ”¾æ‰€æœ‰è¢«æ•èŽ·çš„å˜é‡çš„å€¼ã€‚
///
/// ``` skip
/// // fn make_adder(x: Int) -> (Int) -> Int {
/// //   fn adder(y: Int) -> Int { x + y }
/// //   adder
/// // }
/// // `adder` çš„é—­åŒ…ç»“æž„ä½“å¤§è‡´å¦‚ä¸‹ï¼š
/// struct AdderClosure {
///   fn_ptr: Ptr,      // æŒ‡å‘ adder å‡½æ•°çš„ä»£ç 
///   captured_x: Int   // æ•èŽ·çš„å˜é‡ x
/// }
/// ```
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜æ˜¯å®žçŽ°é—­åŒ…çš„åˆ›å»ºå’Œè°ƒç”¨ï¼Œè¿™éœ€è¦ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼š
/// 1.  åœ¨ `stmt_codegen` ä¸­æ·»åŠ å¯¹ `ClosureDef` çš„å¤„ç†é€»è¾‘ã€‚
/// 2.  ä¿®æ”¹ `expr_codegen` ä¸­å¯¹ `Call` çš„å¤„ç†é€»è¾‘ï¼Œä½¿å…¶æ”¯æŒè°ƒç”¨é—­åŒ…ã€‚
///
/// ### 1. åˆ›å»ºé—­åŒ… (`closure_codegen`)
///
/// å½“ `stmt_codegen` é‡åˆ° `ClosureDef` æ—¶ï¼Œä½ éœ€è¦æ‰§è¡Œä¸€ä¸ªä¸¤æ­¥è¿‡ç¨‹ï¼š
///
/// **ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆé—­åŒ…å‡½æ•°æœ¬èº«çš„ä»£ç **
///   - è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ LLVM å‡½æ•°ã€‚å®ƒçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºŽï¼Œå®ƒçš„**ç¬¬ä¸€ä¸ªå‚æ•°**æ˜¯ä¸€ä¸ªéšå¼çš„æŒ‡é’ˆï¼ŒæŒ‡å‘é—­åŒ…ç»“æž„ä½“å®žä¾‹ï¼ˆå³çŽ¯å¢ƒæŒ‡é’ˆï¼‰ã€‚
///   - åœ¨è¿™ä¸ªå‡½æ•°ä½“å†…ï¼Œä½ å¯ä»¥é€šè¿‡ GEP å’Œ `load` è¿™ä¸ªçŽ¯å¢ƒæŒ‡é’ˆæ¥èŽ·å–è¢«æ•èŽ·å˜é‡çš„å€¼ã€‚
///
/// **ç¬¬äºŒæ­¥ï¼šåœ¨å½“å‰å‡½æ•°ä¸­ï¼Œåˆ›å»ºé—­åŒ…ç»“æž„ä½“å®žä¾‹**
///   - **åˆ†é…å†…å­˜**: è°ƒç”¨ `malloc` ä¸ºé—­åŒ…ç»“æž„ä½“åˆ†é…å †å†…å­˜ã€‚
///   - **å¡«å……ç»“æž„ä½“**:
///     a. **å‡½æ•°æŒ‡é’ˆ**: ä½¿ç”¨ GEP èŽ·å–ç¬¬ä¸€ä¸ªå­—æ®µçš„åœ°å€ï¼Œç„¶åŽ `store` æŒ‡å‘ç¬¬ä¸€æ­¥ä¸­ç”Ÿæˆçš„é‚£ä¸ªé—­åŒ…å‡½æ•°çš„æŒ‡é’ˆã€‚
///     b. **æ•èŽ·çš„å˜é‡**: éåŽ†æ‰€æœ‰æ•èŽ·çš„å˜é‡ï¼Œä½¿ç”¨ GEP èŽ·å–åŽç»­å­—æ®µçš„åœ°å€ï¼Œç„¶åŽ `store` è¿™äº›å˜é‡å½“å‰çš„å€¼ã€‚
///   - **æ³¨å†Œé—­åŒ…**: æœ€åŽï¼Œåœ¨ `Context` ä¸­ï¼Œå°†é—­åŒ…çš„åå­—ï¼ˆä¾‹å¦‚ `adder`ï¼‰æ˜ å°„åˆ°è¿™ä¸ªåˆšåˆšåˆ›å»ºçš„ç»“æž„ä½“å®žä¾‹çš„æŒ‡é’ˆã€‚
///
/// ### 2. è°ƒç”¨é—­åŒ… (ä¿®æ”¹ `Call` çš„é€»è¾‘)
///
/// å½“ `expr_codegen` å¤„ç†ä¸€ä¸ª `Call` è¡¨è¾¾å¼æ—¶ï¼Œä½ éœ€è¦åˆ¤æ–­è¢«è°ƒç”¨è€…ï¼ˆcalleeï¼‰çš„ç±»åž‹ã€‚
///
/// - **å¦‚æžœè¢«è°ƒç”¨è€…æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡**ï¼ˆè¿™åœ¨æˆ‘ä»¬çš„è¯­è¨€é‡Œæ„å‘³ç€å®ƒå¯èƒ½æ˜¯ä¸€ä¸ªé—­åŒ…ï¼‰ï¼š
///   a. **èŽ·å–å‡½æ•°æŒ‡é’ˆ**: ä»Žé—­åŒ…ç»“æž„ä½“ä¸­ï¼Œä½¿ç”¨ GEP `getelementptr ..., i32 0, i32 0` æ¥åŠ è½½ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå³å‡½æ•°æŒ‡é’ˆã€‚
///   b. **å‡†å¤‡å‚æ•°**: è°ƒç”¨æ—¶çš„å‚æ•°åˆ—è¡¨éœ€è¦åšç‰¹æ®Šå¤„ç†ã€‚**ç¬¬ä¸€ä¸ªå‚æ•°**å¿…é¡»æ˜¯é—­åŒ…ç»“æž„ä½“è‡ªèº«çš„æŒ‡é’ˆï¼ˆä½œä¸ºçŽ¯å¢ƒæŒ‡é’ˆä¼ å…¥ï¼‰ï¼ŒåŽé¢æ‰æ˜¯çœŸæ­£çš„å‡½æ•°è°ƒç”¨å‚æ•°ã€‚
///   c. **è°ƒç”¨æŒ‡é’ˆ**: ä½¿ç”¨ `builder.createCallPtr` æ¥æ‰§è¡Œè°ƒç”¨ã€‚è¿™ä¸ªæŒ‡ä»¤ç”¨äºŽè°ƒç”¨ä¸€ä¸ªå€¼ä¸ºå‡½æ•°æŒ‡é’ˆçš„å˜é‡ã€‚
///
/// - **å¦‚æžœè¢«è°ƒç”¨è€…æ˜¯é¡¶å±‚å‡½æ•°**ï¼šé€»è¾‘ä¿æŒä¸å˜ï¼Œä½¿ç”¨ `createCall` ç›´æŽ¥è°ƒç”¨ã€‚
///
/// ---
///
/// è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„æŒ‘æˆ˜ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°å‡½æ•°ã€æŒ‡é’ˆã€ç»“æž„ä½“å’Œå†…å­˜æ“ä½œçš„ç»¼åˆè¿ç”¨ã€‚è¯·ä»”ç»†æ€è€ƒæ¯ä¸€æ­¥çš„é€»è¾‘ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

test "Codegen Closure Test" {
  let code = 
    #|fn make_adder(x: Int) -> (Int) -> Int {
    #|  fn adder(y: Int) -> Int {
    #|    x + y;
    #|  }
    #|  adder;
    #|}
    #|
    #|fn main {
    #|  let add_five = make_adder(5);
    #|  let result = add_five(10);
    #|  print_int(result);
    #|}
  
  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  let make_adder_func = knf_prog.functions.get("make_adder").unwrap()
  let _ = codegen_ctx.top_function_codegen(make_adder_func)

  let main_func = knf_prog.functions.get("main").unwrap()
  let main_ir = codegen_ctx.top_function_codegen(main_func)
  inspect(main_ir, content=(
    
    #|define void @minimbt_main() {
    #|entry:
    #|  %0 = call ptr @make_adder(ptr null, i32 5)
    #|  %1 = getelementptr { ptr }, ptr %0, i32 0, i32 0
    #|  %2 = load ptr, ptr %1, align 8
    #|  %3 = call i32 %2(ptr %0, i32 10)
    #|  call void @minimbt_print_int(i32 %3)
    #|  ret void
    #|}
    #|
  ))
}
