/// ================================================================================
/// # LLVM Codegen: åˆ›å»ºç»“æž„ä½“ç±»åž‹
///
/// åœ¨ä¸Šä¸€ä¸ªæŒ‘æˆ˜ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•åˆ›å»ºç®€å•çš„ LLVM å‡½æ•°ã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨ LLVM ä¸­å®šä¹‰å¤åˆç±»åž‹ï¼Œ
/// å³**ç»“æž„ä½“ï¼ˆStructsï¼‰**ã€‚
///
/// ## ä»€ä¹ˆæ˜¯ LLVM ç»“æž„ä½“ç±»åž‹ï¼Ÿ
///
/// LLVM ä¸­çš„ç»“æž„ä½“ç±»åž‹ä¸Ž C è¯­è¨€ä¸­çš„ `struct` éžå¸¸ç›¸ä¼¼ã€‚å®ƒå…è®¸æˆ‘ä»¬å°†å¤šä¸ªä¸åŒç±»åž‹çš„æ•°æ®æˆå‘˜ï¼ˆå­—æ®µï¼‰
/// ç»„åˆæˆä¸€ä¸ªå•ä¸€çš„ã€è¿žç»­çš„å†…å­˜å—ã€‚è¿™å¯¹äºŽè¡¨ç¤ºå¤æ‚çš„æ•°æ®ç»“æž„ï¼Œå¦‚åæ ‡ç‚¹ã€ç”¨æˆ·ä¿¡æ¯æˆ– AST èŠ‚ç‚¹è‡³å…³é‡è¦ã€‚
///
/// LLVM æ”¯æŒä¸¤ç§ç»“æž„ä½“ç±»åž‹ï¼š
///
/// 1.  **å­—é¢ç»“æž„ä½“ï¼ˆLiteral Structsï¼‰**ï¼šå®ƒä»¬æ˜¯åŒ¿åçš„ï¼Œé€šè¿‡å…¶å­—æ®µçš„ç±»åž‹åºåˆ—æ¥å®šä¹‰ï¼Œä¾‹å¦‚ `{ i32, double }`ã€‚
/// 2.  **å·²è¯†åˆ«ç»“æž„ä½“ï¼ˆIdentified Structsï¼‰**ï¼šå®ƒä»¬æœ‰è‡ªå·±çš„åå­—ï¼Œä¾‹å¦‚ `%Point = type { i32, i32 }`ã€‚
///     åœ¨æˆ‘ä»¬çš„ç¼–è¯‘å™¨ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦ä½¿ç”¨å·²è¯†åˆ«ç»“æž„ä½“ï¼Œå› ä¸ºå®ƒä»¬æ›´æ˜“äºŽè°ƒè¯•å’Œå¼•ç”¨ã€‚
///
/// ## ðŸ› ï¸ å¦‚ä½•åˆ›å»ºç»“æž„ä½“ç±»åž‹ï¼Ÿ
///
//  åœ¨ MoonBit çš„ LLVM API ä¸­ï¼Œåˆ›å»ºç»“æž„ä½“ç±»åž‹éžå¸¸ç›´æŽ¥ï¼š
///
/// 1.  **èŽ·å–ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰**ï¼šå’Œä¹‹å‰ä¸€æ ·ï¼Œæ‰€æœ‰æ“ä½œéƒ½å§‹äºŽ `llvm.Context`ã€‚
///
/// 2.  **èŽ·å–å­—æ®µç±»åž‹**ï¼šä½¿ç”¨ `ctx.getInt32Ty()`ã€`ctx.getDoubleTy()` ç­‰æ–¹æ³•èŽ·å–æž„æˆç»“æž„ä½“çš„åŸºæœ¬ç±»åž‹ã€‚
///
/// 3.  **åˆ›å»ºç»“æž„ä½“ç±»åž‹**ï¼šè°ƒç”¨ `ctx.getStructType` æ–¹æ³•ã€‚
///
///     ```moonbit
///     let struct_ty = ctx.getStructType(
///       [i32ty, f64ty], // å­—æ®µç±»åž‹çš„æ•°ç»„
///       name="i32_f64"  // ç»“æž„ä½“çš„åå­—ï¼ˆæŽ¨èï¼‰
///     );
///     ```
///
///     - ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å­—æ®µç±»åž‹çš„ `Array`ã€‚
///     - `name` æ˜¯ä¸€ä¸ªå¯é€‰çš„æ ‡ç­¾å‚æ•°ï¼Œç”¨äºŽç»™ç»“æž„ä½“å‘½åã€‚ä¸ºç»“æž„ä½“å‘½åæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œ
///       å› ä¸ºå®ƒå…è®¸æˆ‘ä»¬ç¨åŽé€šè¿‡ `ctx.getStructTypeByName("i32_f64")` æ¥å¼•ç”¨å®ƒï¼Œé¿å…é‡å¤å®šä¹‰ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œ`demo_i32_f64` å‡½æ•°å·²ç»ä¸ºä½ å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªåŒ…å« `i32` å’Œ `f64` ä¸¤ä¸ªå­—æ®µçš„ç»“æž„ä½“ã€‚
///
/// ä½ çš„ä»»åŠ¡æ˜¯æ¨¡ä»¿å®ƒï¼Œå®Œæˆ `demo_i8_i16_i32_f32_f64` å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å« `i8`, `i16`, `i32`, `f32`, `f64` äº”ç§ç±»åž‹çš„ç»“æž„ä½“ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚
/// ================================================================================

///|
///
/// demo_i32_f64åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«i32å’Œf64ä¸¤ä¸ªå­—æ®µçš„ç»“æž„ä½“ç±»åž‹ã€‚
/// åœ¨Cè¯­è¨€é‡Œï¼Œè¿™ç›¸å½“äºŽå®šä¹‰äº†å¦‚ä¸‹ç»“æž„ä½“ï¼š
///
/// ```c
/// struct i32_f64 {
///   int32_t a;
///   double b;
/// };
/// ```
///
/// ä½ çš„ä»»åŠ¡æ˜¯å®žçŽ°demo_i8_i16_i32_f32_f64å‡½æ•°ï¼Œ
/// åˆ›å»ºä¸€ä¸ªåŒ…å«i8ã€i16ã€i32ã€f32å’Œf64äº”ä¸ªå­—æ®µçš„ç»“æž„ä½“ç±»åž‹ã€‚
///
/// åœ¨Cè¯­è¨€é‡Œï¼Œè¿™ç›¸å½“äºŽå®šä¹‰äº†å¦‚ä¸‹ç»“æž„ä½“ï¼š
///
/// ```c
/// struct i8_i16_i32_f32_f64 {
///   int8_t a;
///   int16_t b;
///   int32_t c;
///   float d;
///   double e;
/// };
/// ```
///
/// æç¤ºï¼š
///
/// - ä½¿ç”¨ `getInt8Ty` æ¥èŽ·å– i8 ç±»åž‹ã€‚
/// - ä½¿ç”¨ `getInt16Ty` æ¥èŽ·å– i16 ç±»åž‹ã€‚
/// - ä½¿ç”¨ `getInt32Ty` æ¥èŽ·å– i32 ç±»åž‹ã€‚
/// - ä½¿ç”¨ `getFloatTy` æ¥èŽ·å– f32 ç±»åž‹ã€‚
/// - ä½¿ç”¨ `getDoubleTy` æ¥èŽ·å– f64 ç±»åž‹ã€‚
///
/// æé†’ï¼š
///
/// 1. getStructTypeæœ‰ä¸€ä¸ªlabelå‚æ•°nameï¼Œå¯ä»¥ç”¨æ¥ç»™ç»“æž„ä½“å‘½åï¼Œ
/// llvmå…è®¸å®šä¹‰åŒ¿åç»“æž„ä½“ï¼Œå¦‚æžœä¸ä¼ nameå‚æ•°ï¼Œåˆ™åˆ›å»ºçš„æ˜¯åŒ¿åç»“æž„ä½“ç±»åž‹ã€‚
///
/// ä½†å»ºè®®åœ¨å®šä¹‰ç»“æž„ä½“ç±»åž‹æ—¶ï¼Œæœ€å¥½ç»™ç»“æž„ä½“å‘½åã€‚
///
/// å…¶ä¸­çš„ä¸€ä¸ªé‡è¦åŽŸå› ï¼Œæ˜¯å‘½åçš„ç»“æž„ä½“å¯ä»¥ä½¿ç”¨contextçš„`getStructTypeByName`æ–¹æ³•æ¥èŽ·å–ã€‚
/// ä»Žè€Œé¿å…é‡å¤å®šä¹‰ç›¸åŒåç§°çš„ç»“æž„ä½“ç±»åž‹ã€‚
///
/// 2. åœ¨æ‰“å°ç»“æž„ä½“æ—¶ï¼Œå¦‚æžœç›´æŽ¥ç”¨`println(struct_ty)`ï¼Œ
/// å¯¹äºŽéžåŒ¿åçš„ç»“æž„ä½“ç±»åž‹ï¼Œè¾“å‡ºå¯èƒ½åªæ˜¾ç¤ºç»“æž„ä½“çš„åç§°ã€‚
/// å¦‚æžœéœ€è¦æŸ¥çœ‹ç»“æž„ä½“çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨`struct_ty.full_info()`æ–¹æ³•ã€‚
fn demo_i32_f64() -> @llvm.StructType raise {
  let ctx = @llvm.Context::new();
  let i32ty = ctx.getInt32Ty();
  let f64ty = ctx.getDoubleTy();
  let struct_ty = ctx.getStructType([i32ty, f64ty], name="i32_f64");
  struct_ty
}

///|
pub fn demo_i8_i16_i32_f32_f64() -> @llvm.StructType raise {
  let ctx = @llvm.Context::new();
  let i8ty = ctx.getInt8Ty();
  let i16ty = ctx.getInt16Ty();
  let i32ty = ctx.getInt32Ty();
  let f32ty = ctx.getFloatTy();
  let f64ty = ctx.getDoubleTy();
  let struct_ty = ctx.getStructType([i8ty, i16ty, i32ty, f32ty, f64ty], name="i8_i16_i32_f32_f64");
  struct_ty
}

///|
test "Codegen Demo Struct Test" {
  let s = demo_i32_f64();
  inspect(
    s.full_info(), 
    content="%i32_f64 = type { i32, double }"
  )

  //
  let s = demo_i8_i16_i32_f32_f64();
  inspect(
    s.full_info(), 
    content="%i8_i16_i32_f32_f64 = type { i8, i16, i32, float, double }"
  )
}
