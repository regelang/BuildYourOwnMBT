/// ================================================================================
/// # LLVM Codegen: if-else ä¸Ž PHI èŠ‚ç‚¹
/// ================================================================================
///
/// æˆ‘ä»¬å³å°†å¤„ç†ç¬¬ä¸€ä¸ªçœŸæ­£çš„æŽ§åˆ¶æµç»“æž„ï¼š`if-else` è¡¨è¾¾å¼ã€‚
/// è¿™åœ¨ä»£ç ç”Ÿæˆä¸­æ˜¯ä¸€ä¸ªé£žè·ƒï¼Œå› ä¸ºå®ƒæ‰“ç ´äº†æŒ‡ä»¤çš„çº¿æ€§æ‰§è¡Œæµç¨‹ï¼Œå¹¶å¼•å…¥äº†ä¸€ä¸ªå¼ºå¤§çš„æ–°æ¦‚å¿µï¼š**PHI èŠ‚ç‚¹**ã€‚
///
/// ## `if-else` çš„æŽ§åˆ¶æµ
///
/// `if-else` è¯­å¥åœ¨ LLVM IR ä¸­é€šè¿‡ä¸€ç³»åˆ—åŸºæœ¬å—å’Œåˆ†æ”¯æŒ‡ä»¤æ¥è¡¨ç¤ºï¼š
///
/// 1.  **å…¥å£å— (`entry_bb`)**: è®¡ç®— `if` çš„æ¡ä»¶ï¼Œç„¶åŽæ ¹æ®ç»“æžœä½¿ç”¨ `createCondBr` æŒ‡ä»¤è·³è½¬åˆ° `then_bb` æˆ– `else_bb`ã€‚
/// 2.  **Then å— (`then_bb`)**: åŒ…å« `if` ä¸ºçœŸæ—¶æ‰§è¡Œçš„ä»£ç ã€‚
/// 3.  **Else å— (`else_bb`)**: åŒ…å« `if` ä¸ºå‡æ—¶æ‰§è¡Œçš„ä»£ç ã€‚
/// 4.  **åˆå¹¶å— (`merge_bb`)**: `then` å’Œ `else` åˆ†æ”¯æ‰§è¡Œå®Œæ¯•åŽï¼ŒæŽ§åˆ¶æµä¼šé‡æ–°æ±‡åˆåˆ°è¿™ä¸ªå—ï¼Œç»§ç»­æ‰§è¡ŒåŽç»­ä»£ç ã€‚
///
/// ## ðŸ’¡ æ ¸å¿ƒæ¦‚å¿µï¼šPHI èŠ‚ç‚¹
///
/// è€ƒè™‘è¡¨è¾¾å¼ `let z = if cond { x } else { y }`ã€‚å½“æŽ§åˆ¶æµåˆ°è¾¾ `merge_bb` æ—¶ï¼Œ`z` çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
/// å®ƒå¯èƒ½æ˜¯ `x`ï¼ˆå¦‚æžœèµ°äº† `then` åˆ†æ”¯ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ `y`ï¼ˆå¦‚æžœèµ°äº† `else` åˆ†æ”¯ï¼‰ã€‚
///
/// ä¸ºäº†åœ¨ SSA å½¢å¼ä¸‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆä¸€ä¸ªå˜é‡åªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ï¼‰ï¼ŒLLVM å¼•å…¥äº† `phi` æŒ‡ä»¤ã€‚
///
/// **PHI èŠ‚ç‚¹å°±åƒä¸€ä¸ªæ ¹æ®æ¥æºè·¯å¾„é€‰æ‹©å€¼çš„å¼€å…³**ã€‚
///
/// `z = phi i32 [ %x, %then_bb ], [ %y, %else_bb ]`
///
/// è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼š
/// - `z` çš„å€¼æ˜¯ä¸€ä¸ª `i32`ã€‚
/// - å¦‚æžœæŽ§åˆ¶æµæ˜¯ä»Ž `%then_bb` è¿‡æ¥çš„ï¼Œ`z` çš„å€¼å°±ç­‰äºŽ `%x`ã€‚
/// - å¦‚æžœæŽ§åˆ¶æµæ˜¯ä»Ž `%else_bb` è¿‡æ¥çš„ï¼Œ`z` çš„å€¼å°±ç­‰äºŽ `%y`ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯å®žçŽ° `if_codegen` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£ç¡®å¤„ç† `if-else` è¡¨è¾¾å¼ã€‚
///
/// ### 1. åˆ›å»ºåŸºæœ¬å—å’Œåˆ†æ”¯
///
/// - å¦‚ä¸Šæ‰€è¿°ï¼Œä¸º `then`ã€`else` å’Œ `merge` åˆ›å»ºä¸‰ä¸ªæ–°çš„åŸºæœ¬å—ã€‚
/// - ç”Ÿæˆ `createCondBr` æŒ‡ä»¤è¿›è¡Œæ¡ä»¶è·³è½¬ã€‚
///
/// ### 2. å®žçŽ° PHI èŠ‚ç‚¹é€»è¾‘
///
/// - å¦‚æžœ `if` è¡¨è¾¾å¼æœ‰è¿”å›žå€¼ï¼ˆå³å®ƒçš„ç±»åž‹ä¸æ˜¯ `Unit`ï¼‰ï¼Œä½ éœ€è¦åœ¨ `merge_bb` çš„**æœ€å¼€å§‹**åˆ›å»ºä¸€ä¸ª PHI èŠ‚ç‚¹ã€‚
///   - **æŽ¥å£**: `builder.createPHI(type)`
/// - åœ¨åˆ†åˆ«ç”Ÿæˆå®Œ `then` å—å’Œ `else` å—çš„ä»£ç åŽï¼Œä½ éœ€è¦å‘Šè¯‰ PHI èŠ‚ç‚¹è¿™ä¸¤ä¸ªåˆ†æ”¯åˆ†åˆ«ä¼šäº§ç”Ÿä»€ä¹ˆå€¼ã€‚
///   - **æŽ¥å£**: `phi_node.addIncoming(value, block)`
///
/// ### 3. âš ï¸ æ³¨æ„ï¼šå¤„ç†å·²ç»ˆç»“çš„å—
///
/// åœ¨ `then` å—æˆ– `else` å—çš„æœ«å°¾ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä¸€ä¸ª `createBr` æŒ‡ä»¤è·³è½¬åˆ° `merge_bb`ã€‚
/// ä½†æ˜¯ï¼Œå¦‚æžœè¿™ä¸ªå—å·²ç»å› ä¸ºä¸€ä¸ª `return` æŒ‡ä»¤è€Œâ€œç»ˆç»“â€äº†å‘¢ï¼Ÿåœ¨ä¸€ä¸ªåŸºæœ¬å—ä¸­æ·»åŠ ä¸¤ä¸ªç»ˆç»“æŒ‡ä»¤æ˜¯é”™è¯¯çš„ã€‚
///
/// - åœ¨æ·»åŠ  `br` æŒ‡ä»¤å‰ï¼Œä½ å¿…é¡»æ£€æŸ¥å½“å‰å—æ˜¯å¦å·²ç»æœ‰äº†ç»ˆç»“æŒ‡ä»¤ã€‚
///   - **æŽ¥å£**: `builder.getInsertBlock().getTerminator()`ã€‚å¦‚æžœè¿”å›žå€¼æ˜¯ `Some(...)`ï¼Œåˆ™è¯´æ˜Žå·²æœ‰ç»ˆç»“æŒ‡ä»¤ï¼Œä¸åº”å†æ·»åŠ  `br`ã€‚
///
/// ### 4. âš ï¸ ç‰¹åˆ«å½“å¿ƒï¼šæ— ç”¨çš„ `merge` å—
///
/// è€ƒè™‘è¿™ç§æƒ…å†µï¼š`fn max(a, b) { if a > b { return a; } else { return b; } }`
///
/// åœ¨è¿™é‡Œï¼Œ`then` å—å’Œ `else` å—éƒ½ä»¥ `return` ç»“æŸã€‚æŽ§åˆ¶æµ**æ°¸è¿œä¸ä¼š**åˆ°è¾¾ `merge_bb`ã€‚
/// è¿™ç§æƒ…å†µä¸‹ï¼Œ`merge_bb` æˆäº†ä¸€ä¸ªæ²¡æœ‰å‰é©±ï¼ˆpredecessorï¼‰çš„â€œæ­»å—â€ã€‚ä¸€ä¸ªæ²¡æœ‰å‰é©±çš„åŸºæœ¬å—æ˜¯éžæ³•çš„ï¼ˆå…¥å£å—é™¤å¤–ï¼‰ã€‚
///
/// - ä½ éœ€è¦æ£€æµ‹è¿™ç§æƒ…å†µï¼ˆå³ `then` å’Œ `else` å—éƒ½å·²è¢«ç»ˆç»“ï¼‰ã€‚
/// - å¦‚æžœå‘ç”Ÿï¼Œä½ åº”è¯¥å°† `merge_bb` ä»Žå‡½æ•°ä¸­ç§»é™¤ï¼Œä»¥ä¿æŒ IR çš„åˆæ³•æ€§ã€‚
///   - **æŽ¥å£**: `merge_bb.removeFromParent()`
///
/// ---
///
/// è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„æŒ‘æˆ˜ï¼Œä½†å®ƒæ¶µç›–äº†ä»£ç ç”Ÿæˆä¸­å…³äºŽæŽ§åˆ¶æµçš„è®¸å¤šæ ¸å¿ƒæ€æƒ³ã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

///|
///
test "Codegen for If Test" {

  let code = 
    #|fn max(x: Int, y: Int) -> Int {
    #|  let z = if x > y { x } else { y };
    #|  z
    #|}
    #|
    #|fn min(x: Int, y: Int) -> Int {
    #|  if x < y {
    #|    return x;
    #|  } else {
    #|    return y;
    #|  }
    #|}
    #|

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  // max
  let max = knf_prog.functions.get("max").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(max)
  inspect(llvm_func, content=(
    
    #|define i32 @max(ptr %0, i32 %1, i32 %2) {
    #|entry:
    #|  %3 = icmp sgt i32 %1, %2
    #|  br i1 %3, label %5, label %7
    #|
    #|5:                                     ; preds = %entry
    #|  br label %9
    #|
    #|7:                                     ; preds = %entry
    #|  br label %9
    #|
    #|9:                                     ; preds = %5, %7
    #|  %10 = phi i32 [ %1, %5 ], [ %2, %7 ]
    #|  ret i32 %10
    #|}
    #|
  ))

  // min
  let min = knf_prog.functions.get("min").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(min)
  inspect(llvm_func, content=(
    
    #|define i32 @min(ptr %0, i32 %1, i32 %2) {
    #|entry:
    #|  %3 = icmp slt i32 %1, %2
    #|  br i1 %3, label %5, label %7
    #|
    #|5:                                     ; preds = %entry
    #|  ret i32 %1
    #|
    #|7:                                     ; preds = %entry
    #|  ret i32 %2
    #|}
    #|

  ))
}