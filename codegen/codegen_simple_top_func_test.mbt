/// ================================================================================
/// # LLVM Codegen: ç”Ÿæˆå¸¦è¿”å›žå€¼çš„å‡½æ•°
/// ================================================================================
///
/// åœ¨ä¸Šä¸€ä¸ªæŒ‘æˆ˜ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸç”Ÿæˆäº†ç©ºå‡½æ•°ä½“çš„ LLVM IRã€‚çŽ°åœ¨ï¼Œæ˜¯æ—¶å€™è®©æˆ‘ä»¬çš„å‡½æ•°åšä¸€äº›å®žé™…çš„äº‹æƒ…äº†â€”â€”è¿”å›žä¸€ä¸ªå€¼ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯è®© `top_function_codegen` èƒ½å¤Ÿå¤„ç†è¿”å›žç®€å•å¸¸é‡ï¼ˆå¦‚æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ï¼‰çš„å‡½æ•°ã€‚
/// ä¸ºäº†å®žçŽ°è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦å¼€å§‹å¡«å……å¦å¤–ä¸¤ä¸ªå…³é”®çš„è¾…åŠ©å‡½æ•°ï¼š
///
/// ### 1. å®žçŽ° `expr_codegen` (åœ¨ `codegen/top_function.mbt` ä¸­)
///
/// `expr_codegen` å‡½æ•°è´Ÿè´£å°†ä¸€ä¸ª KNF è¡¨è¾¾å¼ï¼ˆ`KnfExpr`ï¼‰è½¬æ¢ä¸ºå¯¹åº”çš„ LLVM å€¼ï¼ˆ`@llvm.Value`ï¼‰ã€‚
///
/// ä½ éœ€è¦å¼€å§‹å¤„ç† `KnfExpr` çš„å‡ ä¸ªåŸºæœ¬æƒ…å†µï¼š
///   - `Int(i)`: ä½¿ç”¨ `llvm_ctx.getConstInt32(i)` åˆ›å»ºä¸€ä¸ª LLVM æ•´æ•°å¸¸é‡ã€‚
///   - `Double(d)`: ä½¿ç”¨ `llvm_ctx.getConstDouble(d)` åˆ›å»ºä¸€ä¸ª LLVM æµ®ç‚¹æ•°å¸¸é‡ã€‚
///   - `Bool(b)`: ä½¿ç”¨ `llvm_ctx.getConstTrue()` æˆ– `llvm_ctx.getConstFalse()`ã€‚
///   - `String(s)`: ä½¿ç”¨ `builder.createGlobalString(s, name=...)` åˆ›å»ºä¸€ä¸ªå…¨å±€å­—ç¬¦ä¸²å¸¸é‡ã€‚
///     - **æç¤º**ï¼šä¸ºå…¨å±€å­—ç¬¦ä¸²å‘½åæ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œå¯ä»¥é¿å…å†²çªã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆä¾‹å¦‚ `str_cnt`ï¼‰æ¥ç”Ÿæˆå”¯ä¸€çš„åå­—ï¼Œå¦‚ `"str_lit_1"`, `"str_lit_2"` ç­‰ã€‚
///
/// ### 2. å®žçŽ° `stmt_codegen` (åœ¨ `codegen/top_function.mbt` ä¸­)
///
/// `stmt_codegen` è´Ÿè´£å°† KNF è¯­å¥ï¼ˆ`KnfStmt`ï¼‰è½¬æ¢ä¸º LLVM æŒ‡ä»¤ã€‚è™½ç„¶æœ¬æ¬¡æŒ‘æˆ˜çš„æ ¸å¿ƒåœ¨ `expr_codegen`ï¼Œä½† `top_function_codegen` çš„é€»è¾‘ä¼šé€šè¿‡ `stmt_codegen` æ¥å¤„ç†å‡½æ•°ä½“çš„æœ€åŽä¸€æ¡è¯­å¥ã€‚
///
/// ä½ éœ€è¦ç¡®ä¿ `stmt_codegen` èƒ½å¤Ÿå¤„ç† `Return(expr)` å’Œ `ExprStmt(expr)` è¿™ä¸¤ç§æƒ…å†µï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ `expr_codegen` æ¥èŽ·å–è¿”å›žå€¼ã€‚
///
/// ## ðŸ’¡ å…³é”®é€»è¾‘
///
/// åœ¨ `top_function_codegen` ä¸­ï¼Œå½“å¤„ç†å®Œå‡½æ•°ä½“ï¼ˆ`func.body`ï¼‰åŽï¼Œä½ éœ€è¦æ£€æŸ¥å‡½æ•°ä½“çš„æœ€åŽä¸€æ¡è¯­å¥ï¼Œä»¥ç¡®å®šå¦‚ä½•ç”Ÿæˆ `ret` æŒ‡ä»¤ï¼š
///
/// - **å¦‚æžœæœ€åŽæ˜¯ `Return(expr)` æˆ– `ExprStmt(expr)`**ï¼š
///   1. è°ƒç”¨ `expr_codegen(expr)` èŽ·å¾— LLVM å€¼ã€‚
///   2. ä½¿ç”¨ `builder.createRet(value)` ç”Ÿæˆè¿”å›žè¯¥å€¼çš„æŒ‡ä»¤ã€‚
///
/// - **å¦‚æžœå‡½æ•°ä½“ä¸ºç©ºæˆ–æœ€åŽä¸€æ¡è¯­å¥ä¸æ˜¯è¿”å›žè¡¨è¾¾å¼**ï¼š
///   1. æ£€æŸ¥å‡½æ•°çš„è¿”å›žç±»åž‹ã€‚
///   2. å¦‚æžœè¿”å›žç±»åž‹æ˜¯ `void` (å¯¹åº”æˆ‘ä»¬çš„ `Unit`)ï¼Œåˆ™ä½¿ç”¨ `builder.createRetVoid()`ã€‚
///
/// æœ¬æ¬¡æµ‹è¯• `codegen_simple_top_func_test.mbt` å°†æ£€æŸ¥ä½ æ˜¯å¦èƒ½ä¸ºè¿”å›žä¸åŒç±»åž‹å¸¸é‡çš„å‡½æ•°æ­£ç¡®ç”Ÿæˆ LLVM IRã€‚
///
/// è·Ÿç€ä¸‹é¢çš„æŒ‡å¼•å®Œæˆä»»åŠ¡å§ã€‚

test "Codegen for Simple Top Function Test" {

  let code = 
    #|fn ret42() -> Int { 42 }
    #|
    #|fn ret_double_63() -> Double { 63.0 }
    #|
    #|fn hello() -> String {
    #|  "Hello, World!"
    #|}

  let tokens = @lexer.tokenize(code)
  let ast = @parser.parse(tokens)
  let typed_ast = @typecheck.typecheck(ast)
  let knf_prog = @knf.knf_transform(typed_ast)
  let codegen_ctx = Context::new("demo")
  codegen_ctx.collect_func_values(knf_prog.functions)

  let foo = knf_prog.functions.get("ret42").unwrap()
  let llvm_func = codegen_ctx.top_function_codegen(foo)
  inspect(
    llvm_func,
    content=(
      #|define i32 @ret42(ptr %0) {
      #|entry:
      #|  ret i32 42
      #|}
      #|
    )
  )

  // ret_double_63
  let bar = knf_prog.functions.get("ret_double_63").unwrap()
  let llvm_func2 = codegen_ctx.top_function_codegen(bar)
  inspect(
    llvm_func2,
    content=(
      #|define double @ret_double_63(ptr %0) {
      #|entry:
      #|  ret double 0x404F800000000000
      #|}
      #|
    )
  )

  // hello
  let baz = knf_prog.functions.get("hello").unwrap()
  let llvm_func3 = codegen_ctx.top_function_codegen(baz)
  inspect(llvm_func3, content=(
    #|define ptr @hello(ptr %0) {
    #|entry:
    #|  ret ptr @str_lit_1
    #|}
    #|
  ))

}