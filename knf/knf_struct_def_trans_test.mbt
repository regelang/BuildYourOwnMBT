/// ================================================================================
/// # ğŸ—ï¸ ç»“æ„ä½“å®šä¹‰çš„ KNF è½¬æ¢
///
/// ## ğŸ¯ ä»€ä¹ˆæ˜¯ç»“æ„ä½“å®šä¹‰ï¼Ÿ
///
/// ç»“æ„ä½“å®šä¹‰æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­å®šä¹‰å¤åˆæ•°æ®ç±»å‹çš„æ–¹å¼ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†å¤šä¸ªç›¸å…³çš„æ•°æ®ç»„åˆåœ¨ä¸€èµ·ã€‚
/// ç»“æ„ä½“å®šä¹‰çš„åŸºæœ¬ç»“æ„æ˜¯ï¼š
/// struct StructName {
///   field1: Type1;
///   field2: Type2;
///   mut field3: Type3;
/// }
///
/// ç»“æ„ä½“å®šä¹‰çš„ç‰¹ç‚¹ï¼š
/// - å®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ•°æ®ç±»å‹
/// - åŒ…å«å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µæœ‰åç§°å’Œç±»å‹
/// - å­—æ®µå¯ä»¥æ˜¯å¯å˜çš„ï¼ˆmutï¼‰æˆ–ä¸å¯å˜çš„
/// - ç»“æ„ä½“å®šä¹‰æœ¬èº«ä¸äº§ç”Ÿè¿è¡Œæ—¶ä»£ç ï¼Œåªæ˜¯ç±»å‹å®šä¹‰
///
/// ## ğŸ” ç»“æ„å·®å¼‚åˆ†æ
///
/// åœ¨è¯­æ³•æ ‘ä¸­ï¼Œç»“æ„ä½“å®šä¹‰çš„ç»“æ„ç›¸å¯¹ç®€å•ï¼š
/// - `name`: ç»“æ„ä½“åç§°ï¼ˆStringï¼‰
/// - `fields`: å­—æ®µåˆ—è¡¨ï¼ˆArray[StructField]ï¼‰
///
/// åœ¨ KNF ä¸­ï¼Œç»“æ„ä½“å®šä¹‰çš„ç»“æ„æ›´åŠ ç»Ÿä¸€ï¼š
/// - `KnfStructDef`: åŒ…å« name å’Œ fields çš„ç»“æ„ä½“
/// - `fields`: å­—æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå­—æ®µåŒ…å«ï¼ˆå­—æ®µåï¼Œæ˜¯å¦å¯å˜ï¼Œå­—æ®µç±»å‹ï¼‰
///
/// ## ğŸ› ï¸ å®ç°æ€è·¯
///
/// å®ç° `struct_def_to_knf` å‡½æ•°éœ€è¦ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
///
/// ### 1. å­—æ®µè½¬æ¢
/// - éå†ç»“æ„ä½“çš„æ‰€æœ‰å­—æ®µ
/// - å¯¹æ¯ä¸ªå­—æ®µï¼Œæå–å­—æ®µåã€å¯å˜æ€§å’Œç±»å‹
/// - ä½¿ç”¨ `typekind_to_knf` è½¬æ¢å­—æ®µç±»å‹
/// - å°†å­—æ®µä¿¡æ¯å­˜å‚¨ä¸ºï¼ˆå­—æ®µåï¼Œæ˜¯å¦å¯å˜ï¼Œå­—æ®µç±»å‹ï¼‰çš„å…ƒç»„
///
/// ### 2. æ„é€ ç»“æ„ä½“å®šä¹‰
/// - åˆ›å»º `KnfStructDef` ç»“æ„
/// - è®¾ç½®ç»“æ„ä½“åç§°å’Œè½¬æ¢åçš„å­—æ®µåˆ—è¡¨
/// - è¿”å›è½¬æ¢åçš„ç»“æ„ä½“å®šä¹‰
///
/// ## ğŸ”§ å…³é”®å®ç°ç»†èŠ‚
///
/// ### å­—æ®µä¿¡æ¯æå–
/// ä» `StructField` ä¸­æå–å­—æ®µä¿¡æ¯ï¼š
/// - `name`: å­—æ®µåç§°
/// - `ty.kind`: å­—æ®µç±»å‹
/// - `ty.mutable`: å­—æ®µæ˜¯å¦å¯å˜
///
/// ### ç±»å‹è½¬æ¢
/// ä½¿ç”¨ `typekind_to_knf` å°†å­—æ®µç±»å‹è½¬æ¢ä¸º KNF ç±»å‹ï¼š
/// - Int -> Int
/// - String -> String
/// - Double -> Double
/// - å…¶ä»–ç±»å‹æŒ‰éœ€è½¬æ¢
///
/// ### å­—æ®µå­˜å‚¨
/// å°†å­—æ®µä¿¡æ¯å­˜å‚¨ä¸ºå…ƒç»„æ ¼å¼ï¼š
/// (å­—æ®µå: String, æ˜¯å¦å¯å˜: Bool, å­—æ®µç±»å‹: Type)
///
/// ## ğŸ“ æµ‹è¯•ç”¨ä¾‹è§£æ
///
/// ### æµ‹è¯•ç”¨ä¾‹ 1ï¼šç®€å•ç»“æ„ä½“
/// struct Point {
///   x: Int;
///   y: Int;
/// }
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. ç»“æ„ä½“åç§°ï¼šPoint
/// 2. å­—æ®µåˆ—è¡¨ï¼š[(x, false, Int), (y, false, Int)]
/// 3. è¿”å› KnfStructDef { name: "Point", fields: [...] }
///
/// ### æµ‹è¯•ç”¨ä¾‹ 2ï¼šåŒ…å«å¯å˜å­—æ®µçš„ç»“æ„ä½“
/// struct Person {
///   name: String;
///   age: Int;
///   mut score: Double;
/// }
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. ç»“æ„ä½“åç§°ï¼šPerson
/// 2. å­—æ®µåˆ—è¡¨ï¼š[(name, false, String), (age, false, Int), (score, true, Double)]
/// 3. è¿”å› KnfStructDef { name: "Person", fields: [...] }
///
/// ### æµ‹è¯•ç”¨ä¾‹ 3ï¼šç©ºç»“æ„ä½“
/// struct Empty {}
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. ç»“æ„ä½“åç§°ï¼šEmpty
/// 2. å­—æ®µåˆ—è¡¨ï¼š[]
/// 3. è¿”å› KnfStructDef { name: "Empty", fields: [] }
///
/// ## ğŸ’¡ è®¾è®¡æ€æƒ³
///
/// ### ç±»å‹å®šä¹‰
/// ç»“æ„ä½“å®šä¹‰æ˜¯ç±»å‹å®šä¹‰ï¼Œä¸äº§ç”Ÿè¿è¡Œæ—¶ä»£ç ï¼Œåªæ˜¯å®šä¹‰æ•°æ®ç»“æ„ã€‚
///
/// ### å­—æ®µä¿¡æ¯ä¿ç•™
/// ä¿ç•™å­—æ®µçš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€å¯å˜æ€§å’Œç±»å‹ã€‚
///
/// ### ç±»å‹ç»Ÿä¸€
/// å°†å­—æ®µç±»å‹è½¬æ¢ä¸ºç»Ÿä¸€çš„ KNF ç±»å‹è¡¨ç¤ºã€‚
///
/// ### ç»“æ„ç®€åŒ–
/// åœ¨ KNF ä¸­ç®€åŒ–ç»“æ„ä½“å®šä¹‰çš„è¡¨ç¤ºï¼Œä¾¿äºåç»­å¤„ç†ã€‚
///
/// ## ğŸš€ å®ç°æŒ‘æˆ˜
///
/// ### å­—æ®µéå†
/// éœ€è¦æ­£ç¡®éå†ç»“æ„ä½“çš„æ‰€æœ‰å­—æ®µã€‚
///
/// ### ç±»å‹è½¬æ¢
/// éœ€è¦æ­£ç¡®è½¬æ¢å­—æ®µç±»å‹ä¸º KNF ç±»å‹ã€‚
///
/// ### ä¿¡æ¯æå–
/// éœ€è¦æ­£ç¡®æå–å­—æ®µçš„åç§°ã€å¯å˜æ€§å’Œç±»å‹ä¿¡æ¯ã€‚
///
/// ## ğŸ¯ å®ç°ç›®æ ‡
///
/// å®Œæˆ `struct_def.mbt` ä¸­çš„ `struct_def_to_knf` å‡½æ•°ï¼Œå®ç°ç»“æ„ä½“å®šä¹‰çš„ KNF è½¬æ¢ã€‚
/// å‡½æ•°åº”è¯¥ï¼š
/// 1. æ­£ç¡®éå†ç»“æ„ä½“çš„æ‰€æœ‰å­—æ®µ
/// 2. æ­£ç¡®æå–å­—æ®µçš„åç§°ã€å¯å˜æ€§å’Œç±»å‹ä¿¡æ¯
/// 3. æ­£ç¡®è½¬æ¢å­—æ®µç±»å‹ä¸º KNF ç±»å‹
/// 4. è¿”å›ç»Ÿä¸€çš„ KnfStructDef ç»“æ„
///
/// ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹å®ç°ç»“æ„ä½“å®šä¹‰çš„è½¬æ¢å§ï¼ğŸš€
///
/// ================================================================================

///|
test "Struct Def Knf Transformation Test" {
  // Prelude Parts
  let typecheck_ctx = @typecheck.Context::new()
  let knf_ctx = @knf.Context::new()

  // Put all code together
  let code =
    #|struct Point {
    #|  x: Int;
    #|  y: Int;
    #|}
    #|struct Person {
    #|  name: String;
    #|  age: Int;
    #|  mut score: Double;
    #|}
    #|struct Empty {}
  let tokens = @lexer.tokenize(code)

  // Test 1: Simple struct with two immutable fields
  let (struct_def1, tok_view) = @parser.parse_struct_def(tokens)
  let checked_struct_def1 = typecheck_ctx.check_struct_def(struct_def1)
  let knf_struct_def1 = knf_ctx.struct_def_to_knf(checked_struct_def1)
  assert_true(knf_struct_def1.name == "Point")
  assert_true(knf_struct_def1.fields.length() is 2)
  assert_true(
    knf_struct_def1.fields[0] is (field_name1, is_mut1, field_type1) &&
    field_name1 == "x" &&
    is_mut1 == false &&
    field_type1 is Int,
  )
  assert_true(
    knf_struct_def1.fields[1] is (field_name2, is_mut2, field_type2) &&
    field_name2 == "y" &&
    is_mut2 == false &&
    field_type2 is Int,
  )

  // Test 2: Struct with mutable field
  let (struct_def2, tok_view) = @parser.parse_struct_def(tok_view)
  let checked_struct_def2 = typecheck_ctx.check_struct_def(struct_def2)
  let knf_struct_def2 = knf_ctx.struct_def_to_knf(checked_struct_def2)
  assert_true(knf_struct_def2.name == "Person")
  assert_true(knf_struct_def2.fields.length() is 3)
  assert_true(
    knf_struct_def2.fields[0] is (field_name3, is_mut3, field_type3) &&
    field_name3 == "name" &&
    is_mut3 == false &&
    field_type3 is String,
  )
  assert_true(
    knf_struct_def2.fields[1] is (field_name4, is_mut4, field_type4) &&
    field_name4 == "age" &&
    is_mut4 == false &&
    field_type4 is Int,
  )
  assert_true(
    knf_struct_def2.fields[2] is (field_name5, is_mut5, field_type5) &&
    field_name5 == "score" &&
    is_mut5 == true &&
    field_type5 is Double,
  )

  // Test 3: Empty struct
  let (struct_def3, _) = @parser.parse_struct_def(tok_view)
  let checked_struct_def3 = typecheck_ctx.check_struct_def(struct_def3)
  let knf_struct_def3 = knf_ctx.struct_def_to_knf(checked_struct_def3)
  assert_true(knf_struct_def3.name == "Empty")
  assert_true(knf_struct_def3.fields.is_empty())
}
