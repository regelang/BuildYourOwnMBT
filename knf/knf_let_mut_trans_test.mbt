/// ================================================================================
/// # ğŸ¯ å¯å˜ Let è¯­å¥çš„ KNF å˜æ¢ï¼šå¼•å…¥å¯å˜æ€§
///
/// åœ¨å®Œæˆäº†è¡¨è¾¾å¼çš„è½¬æ¢ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨è¦å¼€å§‹å¤„ç†**è¯­å¥ (Statement)** çš„è½¬æ¢ã€‚
/// è¿™æ˜¯ KNF å˜æ¢çš„ä¸€ä¸ªé‡è¦è½¬æŠ˜ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä»è¡¨è¾¾å¼å¤„ç†è½¬å‘è¯­å¥å¤„ç†ã€‚
///
/// ## ğŸŒŸ ä»€ä¹ˆæ˜¯ Let Mut è¯­å¥ï¼Ÿ
///
/// **Let Mut è¯­å¥**æ˜¯å£°æ˜å¯å˜å˜é‡çš„è¯­å¥ï¼Œå®ƒä»¬çš„å½¢å¼æ˜¯ï¼š
///
/// ```
/// let mut x: Int = 10;        // å¸¦ç±»å‹æ³¨è§£çš„å¯å˜å˜é‡
/// let mut a = 42.0;          // ç±»å‹æ¨æ–­çš„å¯å˜å˜é‡
/// let mut y: Double = a + b; // å¤æ‚åˆå§‹åŒ–è¡¨è¾¾å¼çš„å¯å˜å˜é‡
/// ```
///
/// **Let Mut è¯­å¥çš„ç‰¹ç‚¹**ï¼š
/// - **å¯å˜æ€§**ï¼šå£°æ˜çš„å˜é‡å¯ä»¥åœ¨åç»­ä»£ç ä¸­è¢«ä¿®æ”¹
/// - **åˆå§‹åŒ–**ï¼šå¿…é¡»åœ¨å£°æ˜æ—¶æä¾›åˆå§‹å€¼
/// - **ç±»å‹æ³¨è§£**ï¼šå¯ä»¥æ˜¾å¼æŒ‡å®šç±»å‹ï¼Œä¹Ÿå¯ä»¥è®©ç¼–è¯‘å™¨æ¨æ–­
/// - **ä½œç”¨åŸŸ**ï¼šå˜é‡åœ¨å£°æ˜çš„ä½œç”¨åŸŸå†…æœ‰æ•ˆ
///
/// ## ğŸ” KNF ä¸­çš„ Let Mut è¯­å¥
///
/// åœ¨ KNF ä¸­ï¼ŒLet Mut è¯­å¥è¢«è½¬æ¢ä¸º `KnfStmt::LetMut`ï¼š
///
/// ```
/// enum KnfStmt {
///   LetMut(Name, Type, KnfExpr)  // let mut name : Type = expr;
///   // ... å…¶ä»–è¯­å¥ç±»å‹
/// }
/// ```
///
/// **è½¬æ¢è¿‡ç¨‹**ï¼š
/// 1. å¤„ç†åˆå§‹åŒ–è¡¨è¾¾å¼
/// 2. åˆ›å»ºå˜é‡å
/// 3. è½¬æ¢ç±»å‹ä¿¡æ¯
/// 4. ç”Ÿæˆ KNF Let Mut è¯­å¥
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `let_mut_stmt_to_knf` å‡½æ•°
///
/// åœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œä½ éœ€è¦å®ç° `Context::let_mut_stmt_to_knf` å‡½æ•°ã€‚
///
/// ### ğŸ’¡ å®ç°æ€è·¯
///
/// å¯¹äº Let Mut è¯­å¥çš„è½¬æ¢ï¼Œæ ¸å¿ƒæ­¥éª¤æ˜¯ï¼š
///
/// 1. **å¤„ç†åˆå§‹åŒ–è¡¨è¾¾å¼**ï¼šä½¿ç”¨ `expr_to_knf` é€’å½’å¤„ç†åˆå§‹åŒ–è¡¨è¾¾å¼
/// 2. **åˆå¹¶è¯­å¥**ï¼šå°†åˆå§‹åŒ–è¡¨è¾¾å¼çš„è¯­å¥åˆå¹¶åˆ°ç»“æœä¸­
/// 3. **ç±»å‹è½¬æ¢**ï¼šä½¿ç”¨ `typekind_to_knf` è½¬æ¢ç±»å‹ä¿¡æ¯
/// 4. **åˆ›å»ºå˜é‡å**ï¼šä½¿ç”¨ `add_new_name` åˆ›å»ºå˜é‡å
/// 5. **ç”Ÿæˆè¯­å¥**ï¼šåˆ›å»º `KnfStmt::LetMut` è¯­å¥
///
/// **å…³é”®è§‚å¯Ÿ**ï¼š
/// - Let Mut è¯­å¥çš„è½¬æ¢ç›¸å¯¹ç®€å•ï¼Œä¸»è¦æ˜¯å§”æ‰˜ç»™è¡¨è¾¾å¼è½¬æ¢
/// - éœ€è¦æ­£ç¡®å¤„ç†åˆå§‹åŒ–è¡¨è¾¾å¼å¯èƒ½äº§ç”Ÿçš„è¯­å¥
/// - å˜é‡åé€šè¿‡ `add_new_name` åˆ›å»ºï¼Œç¡®ä¿ä½œç”¨åŸŸç®¡ç†æ­£ç¡®
///
/// ## ğŸš€ æµ‹è¯•ç”¨ä¾‹è§£æ
///
/// è¿™ä¸ªæµ‹è¯•æ–‡ä»¶åŒ…å«äº†å¤šç§ Let Mut è¯­å¥çš„è½¬æ¢ï¼š
///
/// 1. **ç®€å•å­—é¢é‡**ï¼š`let mut x: Int = 10;` â†’ `LetMut(x, Int, Int(10))`
/// 2. **ç±»å‹æ¨æ–­**ï¼š`let mut a = 42.0;` â†’ `LetMut(a, Double, Double(42.0))`
/// 3. **å¤æ‚è¡¨è¾¾å¼**ï¼š`let mut y: Double = a + b;` â†’ `LetMut(y, Double, Binary(Add, a, b))`
///
/// **å…³é”®éªŒè¯ç‚¹**ï¼š
/// - å˜é‡åæ˜¯å¦æ­£ç¡®åˆ›å»º
/// - ç±»å‹ä¿¡æ¯æ˜¯å¦æ­£ç¡®è½¬æ¢
/// - åˆå§‹åŒ–è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®å¤„ç†
/// - è¯­å¥ç»“æ„æ˜¯å¦æ­£ç¡®
///
/// ## ğŸ’¡ å®ç°æç¤º
///
/// 1. **è¡¨è¾¾å¼å¤„ç†**ï¼šä½¿ç”¨ `expr_to_knf` å¤„ç†åˆå§‹åŒ–è¡¨è¾¾å¼
/// 2. **è¯­å¥åˆå¹¶**ï¼šä½¿ç”¨ `append` åˆå¹¶åˆå§‹åŒ–è¡¨è¾¾å¼çš„è¯­å¥
/// 3. **ç±»å‹è½¬æ¢**ï¼šä½¿ç”¨ `typekind_to_knf` è½¬æ¢ç±»å‹
/// 4. **å˜é‡åˆ›å»º**ï¼šä½¿ç”¨ `add_new_name` åˆ›å»ºå˜é‡å
/// 5. **è¯­å¥ç”Ÿæˆ**ï¼šä½¿ç”¨ `KnfStmt::LetMut` åˆ›å»ºè¯­å¥
///
/// ## ğŸ”® ä¸ Let è¯­å¥çš„åŒºåˆ«
///
/// Let Mut è¯­å¥ä¸æ™®é€šçš„ Let è¯­å¥çš„ä¸»è¦åŒºåˆ«ï¼š
///
/// - **å¯å˜æ€§**ï¼šLet Mut å£°æ˜çš„å˜é‡å¯ä»¥è¢«ä¿®æ”¹ï¼ŒLet å£°æ˜çš„å˜é‡ä¸å¯å˜
/// - **KNF è¡¨ç¤º**ï¼šLet Mut ä½¿ç”¨ `LetMut`ï¼ŒLet ä½¿ç”¨ `Let`
/// - **åç»­å¤„ç†**ï¼šLet Mut å˜é‡å¯ä»¥ç”¨äºèµ‹å€¼è¯­å¥ï¼ŒLet å˜é‡ä¸èƒ½
///
/// ## ğŸ¯ å¼€å§‹å®ç°å§ï¼
///
/// è¿™æ˜¯è¯­å¥è½¬æ¢çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼é€šè¿‡å®ç° Let Mut è¯­å¥çš„è½¬æ¢ï¼Œ
/// æˆ‘ä»¬å°†ä¸ºåç»­æ›´å¤æ‚çš„è¯­å¥å¤„ç†å¥ å®šåŸºç¡€ã€‚
///
/// **å‡†å¤‡å¥½å¼€å§‹è¯­å¥è½¬æ¢ä¹‹æ—…äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å®ç°ï¼**
/// ================================================================================

///|
test "Let Mut Knf Transformation Test" {
  // Prelucde Parts
  let typecheck_ctx = @typecheck.Context::new()
  let knf_ctx = @knf.Context::new()
  // Test Parts
  let code =
    #|let mut x: Int = 10;
    #|let mut a = 42.0;
    #|let mut b = 33.0;
    #|let mut y: Double = a + b;
  // Code parse, typecheck, knf transform
  let tokens = @lexer.tokenize(code)
  // Parse and transform `let mut x: Int = 10;`
  let (stmt, tok_view) = @parser.parse_let_mut_stmt(tokens)
  let stmt = typecheck_ctx.check_let_mut_stmt(stmt)
  let knf_stmts = knf_ctx.let_mut_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s] &&
    s is LetMut(name1, Int, init_expr) &&
    name1 is { id: "x", .. } &&
    init_expr is Int(10),
  )
  // Parse and transform `let mut a = 42.0;`
  let (stmt1, tok_view) = @parser.parse_let_mut_stmt(tok_view)
  let stmt1 = typecheck_ctx.check_let_mut_stmt(stmt1)
  let knf_stmts1 = knf_ctx.let_mut_stmt_to_knf(stmt1)
  assert_true(
    knf_stmts1 is [s1] &&
    s1 is LetMut(name_a, Double, init_expr1) &&
    name_a is { id: "a", .. } &&
    init_expr1 is Double(42.0),
  )
  // Parse and transform `let mut b = 33.0;`
  let (stmt_b, tok_view) = @parser.parse_let_mut_stmt(tok_view)
  let stmt_b = typecheck_ctx.check_let_mut_stmt(stmt_b)
  let knf_stmts_b = knf_ctx.let_mut_stmt_to_knf(stmt_b)
  assert_true(
    knf_stmts_b is [s_b] &&
    s_b is LetMut(name_b, Double, init_expr_b) &&
    name_b is { id: "b", .. } &&
    init_expr_b is Double(33.0),
  )
  // Parse and transform `let mut y: Double = a + b;`
  let (stmt2, _) = @parser.parse_let_mut_stmt(tok_view)
  let stmt2 = typecheck_ctx.check_let_mut_stmt(stmt2)
  let knf_stmts2 = knf_ctx.let_mut_stmt_to_knf(stmt2)
  assert_true(
    knf_stmts2 is [s2] &&
    s2 is LetMut(name2, Double, init_expr2) &&
    name2 is { id: "y", .. } &&
    init_expr2 is Binary(Add, left, right) &&
    left is { id: "a", .. } &&
    right is { id: "b", .. },
  )
}
