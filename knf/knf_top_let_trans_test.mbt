/// ================================================================================
/// # ğŸŒ é¡¶å±‚ Let è¯­å¥çš„ KNF è½¬æ¢
///
/// ## ğŸ¯ ä»€ä¹ˆæ˜¯é¡¶å±‚ Let è¯­å¥ï¼Ÿ
///
/// é¡¶å±‚ Let è¯­å¥æ˜¯ç¨‹åºä¸­æœ€é¡¶å±‚çš„å˜é‡å£°æ˜ï¼Œå®ƒä»¬å®šä¹‰å…¨å±€å˜é‡å’Œå¸¸é‡ã€‚
/// é¡¶å±‚ Let è¯­å¥çš„åŸºæœ¬ç»“æ„æ˜¯ï¼š
/// let variable_name: Type = expression;
///
/// ä¸å‡½æ•°å†…çš„ Let è¯­å¥ä¸åŒï¼Œé¡¶å±‚ Let è¯­å¥ï¼š
/// - å·¦è¾¹ä¸æ˜¯æ¨¡å¼ï¼ˆPatternï¼‰ï¼Œè€Œæ˜¯ç®€å•çš„æ ‡è¯†ç¬¦
/// - å£°æ˜çš„æ˜¯å…¨å±€å˜é‡ï¼Œéœ€è¦åœ¨å…¨å±€ä½œç”¨åŸŸä¸­æ³¨å†Œ
/// - è½¬æ¢å®Œæˆåéœ€è¦æ³¨å†Œåˆ° Context çš„ globals å­—æ®µä¸­
///
/// ## ğŸ” ç»“æ„å·®å¼‚åˆ†æ
///
/// åœ¨è¯­æ³•æ ‘ä¸­ï¼Œé¡¶å±‚ Let è¯­å¥çš„ç»“æ„ç›¸å¯¹ç®€å•ï¼š
/// - `name`: å˜é‡åï¼ˆStringï¼‰
/// - `ty`: ç±»å‹ï¼ˆTypeï¼‰
/// - `expr`: åˆå§‹åŒ–è¡¨è¾¾å¼ï¼ˆExprï¼‰
///
/// ä½†åœ¨ KNF ä¸­ï¼Œé¡¶å±‚ Let è¯­å¥çš„ç»“æ„æ›´åŠ ç»Ÿä¸€ï¼š
/// - `KnfTopLet`: åŒ…å« nameã€tyã€expr çš„ç»“æ„ä½“
/// - å˜é‡åè¢«è½¬æ¢ä¸º `Name` ç»“æ„
/// - ç±»å‹è¢«è½¬æ¢ä¸º KNF ç±»å‹
/// - è¡¨è¾¾å¼è¢«è½¬æ¢ä¸º KNF è¡¨è¾¾å¼
///
/// ## ğŸ› ï¸ å®ç°æ€è·¯
///
/// å®ç° `top_let_to_knf` å‡½æ•°éœ€è¦å››ä¸ªä¸»è¦æ­¥éª¤ï¼š
///
/// ### 1. è¡¨è¾¾å¼è½¬æ¢
/// - ä½¿ç”¨ `expr_to_knf` è½¬æ¢åˆå§‹åŒ–è¡¨è¾¾å¼
/// - æ”¶é›†è¡¨è¾¾å¼è½¬æ¢è¿‡ç¨‹ä¸­äº§ç”Ÿçš„è¯­å¥
///
/// ### 2. ç±»å‹è½¬æ¢
/// - ä½¿ç”¨ `typekind_to_knf` è½¬æ¢ç±»å‹
/// - ç¡®ä¿ç±»å‹ä¸€è‡´æ€§
///
/// ### 3. é‡å¤å£°æ˜æ£€æŸ¥
/// - æ£€æŸ¥ globals ä¸­æ˜¯å¦å·²å­˜åœ¨åŒåå˜é‡
/// - å¦‚æœå­˜åœ¨ï¼ŒæŠ›å‡ºé‡å¤å£°æ˜é”™è¯¯
///
/// ### 4. å…¨å±€æ³¨å†Œ
/// - ä½¿ç”¨ `add_new_name` åˆ›å»ºæ–°çš„ Name
/// - å°†å˜é‡æ³¨å†Œåˆ° globals å­—æ®µä¸­
/// - è¿”å› `KnfTopLet` ç»“æ„
///
/// ## ğŸ”§ å…³é”®å®ç°ç»†èŠ‚
///
/// ### å…¨å±€å˜é‡ç®¡ç†
/// é¡¶å±‚ Let è¯­å¥å£°æ˜çš„å˜é‡éœ€è¦æ³¨å†Œåˆ°å…¨å±€ä½œç”¨åŸŸï¼š
/// let x: Int = 42;
/// è½¬æ¢ä¸ºï¼š
/// - åˆ›å»º Name { id: "x", slot: 0 }
/// - æ³¨å†Œåˆ° globals["x"] = Int
/// - è¿”å› KnfTopLet { name, ty: Int, expr: Int(42) }
///
/// ### é‡å¤å£°æ˜æ£€æŸ¥
/// åœ¨æ³¨å†Œå…¨å±€å˜é‡ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼š
/// guard self.globals.get(top_let.name) is None else {
///   raise KnfTransformError("Duplicate global variable declaration: ...")
/// }
///
/// ### è¡¨è¾¾å¼å¤„ç†
/// åˆå§‹åŒ–è¡¨è¾¾å¼å¯èƒ½åŒ…å«å¤æ‚çš„è®¡ç®—ï¼Œéœ€è¦å…ˆè½¬æ¢ä¸º KNFï¼š
/// let sum = a + b;
/// è½¬æ¢ä¸ºï¼š
/// - è¡¨è¾¾å¼ a + b è½¬æ¢ä¸º KNF
/// - åˆ›å»ºå…¨å±€å˜é‡ sum
/// - æ³¨å†Œåˆ° globals
///
/// ### ç±»å‹ä¸€è‡´æ€§
/// ç¡®ä¿å£°æ˜çš„ç±»å‹ä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸€è‡´ï¼š
/// - å¦‚æœæä¾›äº†ç±»å‹æ³¨è§£ï¼Œéœ€è¦éªŒè¯ç±»å‹å…¼å®¹æ€§
/// - å¦‚æœæ²¡æœ‰ç±»å‹æ³¨è§£ï¼Œä½¿ç”¨è¡¨è¾¾å¼çš„æ¨æ–­ç±»å‹
///
/// ## ğŸ“ æµ‹è¯•ç”¨ä¾‹è§£æ
///
/// ### æµ‹è¯•ç”¨ä¾‹ 1ï¼šç®€å•ç±»å‹æ³¨è§£
/// let x: Int = 42;
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. è¡¨è¾¾å¼ 42 è½¬æ¢ä¸º Int(42)
/// 2. ç±»å‹ Int ä¿æŒä¸å˜
/// 3. åˆ›å»º Name { id: "x", slot: 0 }
/// 4. æ³¨å†Œåˆ° globals["x"] = Int
///
/// ### æµ‹è¯•ç”¨ä¾‹ 2ï¼šç±»å‹æ¨æ–­
/// let y = 3.14;
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. è¡¨è¾¾å¼ 3.14 è½¬æ¢ä¸º Double(3.14)
/// 2. æ¨æ–­ç±»å‹ä¸º Double
/// 3. åˆ›å»º Name { id: "y", slot: 0 }
/// 4. æ³¨å†Œåˆ° globals["y"] = Double
///
/// ### æµ‹è¯•ç”¨ä¾‹ 3ï¼šå­—ç¬¦ä¸²ç±»å‹
/// let s: String = "hello";
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. è¡¨è¾¾å¼ "hello" è½¬æ¢ä¸º String("hello")
/// 2. ç±»å‹ String ä¿æŒä¸å˜
/// 3. åˆ›å»º Name { id: "s", slot: 0 }
/// 4. æ³¨å†Œåˆ° globals["s"] = String
///
/// ### æµ‹è¯•ç”¨ä¾‹ 4ï¼šå¤æ‚è¡¨è¾¾å¼
/// let sum = a + b;
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. è¡¨è¾¾å¼ a + b è½¬æ¢ä¸º Binary(Add, a_name, b_name)
/// 2. æ¨æ–­ç±»å‹ä¸º Int
/// 3. åˆ›å»º Name { id: "sum", slot: 0 }
/// 4. æ³¨å†Œåˆ° globals["sum"] = Int
///
/// ## ğŸ’¡ è®¾è®¡æ€æƒ³
///
/// ### å…¨å±€ä½œç”¨åŸŸç®¡ç†
/// é¡¶å±‚ Let è¯­å¥å£°æ˜çš„å˜é‡å±äºå…¨å±€ä½œç”¨åŸŸï¼Œéœ€è¦ç»Ÿä¸€ç®¡ç†ã€‚
///
/// ### é‡å¤å£°æ˜é˜²æŠ¤
/// é€šè¿‡æ£€æŸ¥ globals å­—æ®µï¼Œé˜²æ­¢é‡å¤å£°æ˜å…¨å±€å˜é‡ã€‚
///
/// ### ç±»å‹å®‰å…¨
/// ç¡®ä¿å£°æ˜çš„ç±»å‹ä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸€è‡´ï¼Œä¿è¯ç±»å‹å®‰å…¨ã€‚
///
/// ### ç»Ÿä¸€ç»“æ„
/// å°†é¡¶å±‚ Let è¯­å¥è½¬æ¢ä¸ºç»Ÿä¸€çš„ KnfTopLet ç»“æ„ï¼Œä¾¿äºåç»­å¤„ç†ã€‚
///
/// ## ğŸš€ å®ç°æŒ‘æˆ˜
///
/// ### å…¨å±€å˜é‡ç®¡ç†
/// éœ€è¦æ­£ç¡®ç®¡ç†å…¨å±€å˜é‡çš„æ³¨å†Œå’ŒæŸ¥æ‰¾ï¼Œé¿å…å‘½åå†²çªã€‚
///
/// ### ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥
/// éœ€è¦ç¡®ä¿å£°æ˜çš„ç±»å‹ä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸€è‡´ã€‚
///
/// ### é‡å¤å£°æ˜å¤„ç†
/// éœ€è¦æ£€æŸ¥å¹¶é˜²æ­¢é‡å¤å£°æ˜å…¨å±€å˜é‡ã€‚
///
/// ### è¡¨è¾¾å¼å¤æ‚æ€§
/// åˆå§‹åŒ–è¡¨è¾¾å¼å¯èƒ½åŒ…å«å¤æ‚çš„è®¡ç®—ï¼Œéœ€è¦æ­£ç¡®è½¬æ¢ä¸º KNFã€‚
///
/// ## ğŸ¯ å®ç°ç›®æ ‡
///
/// å®Œæˆ `top_let.mbt` ä¸­çš„ `top_let_to_knf` å‡½æ•°ï¼Œå®ç°é¡¶å±‚ Let è¯­å¥çš„ KNF è½¬æ¢ã€‚
/// å‡½æ•°åº”è¯¥ï¼š
/// 1. æ­£ç¡®è½¬æ¢åˆå§‹åŒ–è¡¨è¾¾å¼ä¸º KNF
/// 2. æ­£ç¡®è½¬æ¢ç±»å‹ä¸º KNF ç±»å‹
/// 3. æ£€æŸ¥é‡å¤å£°æ˜å¹¶é˜²æ­¢å†²çª
/// 4. å°†å˜é‡æ³¨å†Œåˆ°å…¨å±€ä½œç”¨åŸŸ
/// 5. è¿”å›ç»Ÿä¸€çš„ KnfTopLet ç»“æ„
///
/// ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹å®ç°é¡¶å±‚ Let è¯­å¥çš„è½¬æ¢å§ï¼ğŸš€
///
/// ================================================================================

///|
test "Top Let Knf Transformation Test" {
  // Prelude Parts
  let typecheck_ctx = @typecheck.Context::new()
  let knf_ctx = @knf.Context::new()

  // Test 1: Simple top-level let with type annotation: let x: Int = 42;
  let code =
    #|let x: Int = 42;
    #|let y = 3.14;
    #|let s: String = "hello";
    #|let a = 1;
    #|let b = 2;
    #|let sum = a + b;
  let tokens1 = @lexer.tokenize(code)
  // Test 1: Check the structure
  let (top_let1, tok_view) = @parser.parse_top_let(tokens1)
  let checked_top_let1 = typecheck_ctx.check_top_let(top_let1)
  let knf_top_let1 = knf_ctx.top_let_to_knf(checked_top_let1)
  assert_true(
    knf_top_let1.name is { id: "x", slot: 0 } &&
    knf_top_let1.ty is Int &&
    knf_top_let1.expr is Int(42),
  )

  // Test 2: Check the structure
  let (top_let2, tok_view) = @parser.parse_top_let(tok_view)
  let checked_top_let2 = typecheck_ctx.check_top_let(top_let2)
  let knf_top_let2 = knf_ctx.top_let_to_knf(checked_top_let2)
  assert_true(
    knf_top_let2.name is { id: "y", slot: 0 } &&
    knf_top_let2.ty is Double &&
    knf_top_let2.expr is Double(3.14),
  )

  // Test 3: Top-level let with string: let s: String = "hello";
  let (top_let3, tok_view) = @parser.parse_top_let(tok_view)
  let checked_top_let3 = typecheck_ctx.check_top_let(top_let3)
  let knf_top_let3 = knf_ctx.top_let_to_knf(checked_top_let3)

  // Test 3: Check the structure
  assert_true(
    knf_top_let3.name is { id: "s", slot: 0 } &&
    knf_top_let3.ty is String &&
    knf_top_let3.expr is String("hello"),
  )

  // Test 4: Top-level let with computation: let sum = 10 + 20;
  let (top_let, tok_view) = @parser.parse_top_let(tok_view)
  let checked_top_let4 = typecheck_ctx.check_top_let(top_let)
  let _ = knf_ctx.top_let_to_knf(checked_top_let4)
  let (top_let, tok_view) = @parser.parse_top_let(tok_view)
  let checked_top_let4 = typecheck_ctx.check_top_let(top_let)
  let _ = knf_ctx.top_let_to_knf(checked_top_let4)
  let (top_let4, _) = @parser.parse_top_let(tok_view)
  let checked_top_let4 = typecheck_ctx.check_top_let(top_let4)
  let knf_top_let4 = knf_ctx.top_let_to_knf(checked_top_let4)
  assert_true(
    knf_top_let4.name is { id: "sum", slot: 0 } &&
    knf_top_let4.ty is Int &&
    knf_top_let4.expr is Binary(Add, l, r) &&
    l is { id: "a", .. } &&
    r is { id: "b", .. },
  )
}
