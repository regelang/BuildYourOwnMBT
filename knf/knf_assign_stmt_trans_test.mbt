/// ================================================================================
/// # ğŸ¯ èµ‹å€¼è¯­å¥çš„ KNF å˜æ¢ï¼šå·¦å€¼çš„å¤æ‚æ€§
///
/// åœ¨å®Œæˆäº† Let è¯­å¥çš„è½¬æ¢ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨è¦å¤„ç†**èµ‹å€¼è¯­å¥ (Assignment Statement)** çš„è½¬æ¢ã€‚
/// è¿™æ˜¯ KNF å˜æ¢ä¸­çš„ä¸€ä¸ªé‡è¦æŒ‘æˆ˜ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°**å·¦å€¼ (Left Value)** çš„å¤æ‚å¤„ç†ã€‚
///
/// ## ğŸŒŸ ä»€ä¹ˆæ˜¯èµ‹å€¼è¯­å¥ï¼Ÿ
///
/// **èµ‹å€¼è¯­å¥**æ˜¯ä¿®æ”¹å˜é‡å€¼çš„è¯­å¥ï¼Œå®ƒä»¬çš„å½¢å¼æ˜¯ï¼š
///
/// ```
/// x = 10;              // ç®€å•èµ‹å€¼
/// y += 5;              // å¤åˆèµ‹å€¼
/// mat[0][0] = 42;      // å¤æ‚å·¦å€¼èµ‹å€¼
/// point.x = 100;       // å­—æ®µèµ‹å€¼
/// ```
///
/// **èµ‹å€¼è¯­å¥çš„ç‰¹ç‚¹**ï¼š
/// - **å·¦å€¼**ï¼šå·¦ä¾§å¿…é¡»æ˜¯å¯ä¿®æ”¹çš„ä½ç½®ï¼ˆå˜é‡ã€æ•°ç»„å…ƒç´ ã€å­—æ®µç­‰ï¼‰
/// - **å³å€¼**ï¼šå³ä¾§æ˜¯è¡¨è¾¾å¼ï¼Œè®¡ç®—ç»“æœèµ‹å€¼ç»™å·¦å€¼
/// - **å¤åˆæ“ä½œ**ï¼šæ”¯æŒ `+=`ã€`-=`ã€`*=` ç­‰å¤åˆèµ‹å€¼æ“ä½œ
/// - **å‰¯ä½œç”¨**ï¼šä¿®æ”¹ç¨‹åºçŠ¶æ€
///
/// ## ğŸ” å·¦å€¼çš„å¤æ‚æ€§æŒ‘æˆ˜
///
/// èµ‹å€¼è¯­å¥çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äº**å·¦å€¼çš„å¤æ‚æ€§**ï¼Œç‰¹åˆ«æ˜¯**åµŒå¥—å·¦å€¼**ï¼š
///
/// ### é—®é¢˜ï¼šåµŒå¥—å·¦å€¼çš„å¤„ç†
///
/// å¯¹äº `mat[0][0] = 42` è¿™æ ·çš„è¯­å¥ï¼Œå·¦å€¼ `mat[0][0]` æ˜¯åµŒå¥—çš„ï¼š
///
/// ```
/// mat[0][0] = 42
///     â†‘     â†‘
///   å¤–å±‚å·¦å€¼ å†…å±‚å·¦å€¼
/// ```
///
/// **æŒ‘æˆ˜**ï¼š
/// - å¤–å±‚å·¦å€¼ `mat[0]` éœ€è¦è¢«å½“ä½œè¡¨è¾¾å¼å¤„ç†
/// - å†…å±‚å·¦å€¼ `[0]` éœ€è¦è®¿é—®å¤–å±‚å·¦å€¼çš„ç»“æœ
/// - éœ€è¦æ­£ç¡®å¤„ç†ä¸­é—´ç»“æœçš„å­˜å‚¨
///
/// ### è§£å†³æ–¹æ¡ˆï¼šå·¦å€¼åˆ°è¡¨è¾¾å¼çš„è½¬æ¢
///
/// å¯¹äºå¤æ‚çš„å·¦å€¼ï¼Œéœ€è¦é‡‡ç”¨**å·¦å€¼åˆ°è¡¨è¾¾å¼çš„è½¬æ¢**ç­–ç•¥ï¼š
///
/// ```
/// mat[0][0] = 42
/// ```
///
/// **è½¬æ¢è¿‡ç¨‹**ï¼š
/// 1. å¤„ç†å¤–å±‚å·¦å€¼ `mat[0]`ï¼Œå°†å…¶è½¬æ¢ä¸ºè¡¨è¾¾å¼
/// 2. ä¸ºå¤–å±‚å·¦å€¼çš„ç»“æœåˆ›å»ºä¸´æ—¶å˜é‡
/// 3. å¤„ç†å†…å±‚å·¦å€¼ `[0]`ï¼Œä½¿ç”¨ä¸´æ—¶å˜é‡ä½œä¸ºæ•°ç»„
/// 4. ç”Ÿæˆ `ArrayPut` è¯­å¥
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `assign_stmt_to_knf` å‡½æ•°
///
/// åœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œä½ éœ€è¦å®ç° `Context::assign_stmt_to_knf` å‡½æ•°ã€‚
///
/// ### ğŸ’¡ å®ç°æ€è·¯
///
/// èµ‹å€¼è¯­å¥çš„è½¬æ¢åˆ†ä¸ºä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼š
///
/// 1. **å¤„ç†å·¦å€¼**ï¼šä½¿ç”¨ `left_value_to_knf` å¤„ç†å·¦ä¾§å·¦å€¼
/// 2. **å¤„ç†å³å€¼**ï¼šä½¿ç”¨ `expr_to_knf` å¤„ç†å³ä¾§è¡¨è¾¾å¼
/// 3. **ç”Ÿæˆèµ‹å€¼è¯­å¥**ï¼šæ ¹æ®å·¦å€¼ç±»å‹ç”Ÿæˆç›¸åº”çš„ KNF è¯­å¥
///
/// ### ğŸ”§ å·¦å€¼å¤„ç†çš„æ ¸å¿ƒç­–ç•¥
///
/// å¯¹äºä¸åŒçš„å·¦å€¼ç±»å‹ï¼Œéœ€è¦é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ï¼š
///
/// #### 1. ç®€å•æ ‡è¯†ç¬¦å·¦å€¼
/// - ç›´æ¥æŸ¥æ‰¾å˜é‡å
/// - ç”Ÿæˆ `Assign` è¯­å¥
///
/// #### 2. æ•°ç»„è®¿é—®å·¦å€¼
/// - **é€’å½’å¤„ç†**ï¼šå¯¹åµŒå¥—çš„æ•°ç»„è®¿é—®é€’å½’å¤„ç†
/// - **è¡¨è¾¾å¼è½¬æ¢**ï¼šå°†å·¦å€¼è½¬æ¢ä¸ºè¡¨è¾¾å¼
/// - **ä¸´æ—¶å˜é‡**ï¼šä¸ºä¸­é—´ç»“æœåˆ›å»ºä¸´æ—¶å˜é‡
/// - **ArrayPut è¯­å¥**ï¼šç”Ÿæˆæ•°ç»„èµ‹å€¼è¯­å¥
///
/// #### 3. å­—æ®µè®¿é—®å·¦å€¼
/// - **é€’å½’å¤„ç†**ï¼šå¯¹åµŒå¥—çš„å­—æ®µè®¿é—®é€’å½’å¤„ç†
/// - **è¡¨è¾¾å¼è½¬æ¢**ï¼šå°†å·¦å€¼è½¬æ¢ä¸ºè¡¨è¾¾å¼
/// - **ä¸´æ—¶å˜é‡**ï¼šä¸ºä¸­é—´ç»“æœåˆ›å»ºä¸´æ—¶å˜é‡
/// - **StructFieldSet è¯­å¥**ï¼šç”Ÿæˆå­—æ®µèµ‹å€¼è¯­å¥
///
/// ### ğŸ”§ å¤åˆèµ‹å€¼æ“ä½œçš„å¤„ç†
///
/// å¯¹äº `+=`ã€`-=` ç­‰å¤åˆèµ‹å€¼æ“ä½œï¼š
///
/// 1. **è¯»å–å·¦å€¼**ï¼šå°†å·¦å€¼è½¬æ¢ä¸ºè¡¨è¾¾å¼å¹¶è¯»å–å…¶å€¼
/// 2. **è®¡ç®—æ–°å€¼**ï¼šæ‰§è¡Œç›¸åº”çš„äºŒå…ƒè¿ç®—
/// 3. **èµ‹å€¼**ï¼šå°†è®¡ç®—ç»“æœèµ‹å€¼ç»™å·¦å€¼
///
/// ## ğŸš€ æµ‹è¯•ç”¨ä¾‹è§£æ
///
/// è¿™ä¸ªæµ‹è¯•æ–‡ä»¶åŒ…å«äº†å¤šç§èµ‹å€¼è¯­å¥çš„è½¬æ¢ï¼š
///
/// ### æµ‹è¯•ç”¨ä¾‹ 1ï¼š`x = 10;`
/// **è½¬æ¢ç»“æœ**ï¼š`Assign(x, Int(10))`
/// **ç‰¹ç‚¹**ï¼šç®€å•çš„æ ‡è¯†ç¬¦èµ‹å€¼
///
/// ### æµ‹è¯•ç”¨ä¾‹ 2ï¼š`x += 5;`
/// **æœŸæœ›è½¬æ¢**ï¼š
/// ```
/// let tmp1 = 5;
/// let tmp2 = x + tmp1;
/// x = tmp2;
/// ```
/// **ç‰¹ç‚¹**ï¼šå¤åˆèµ‹å€¼æ“ä½œ
///
/// ### æµ‹è¯•ç”¨ä¾‹ 3ï¼š`mat[0][0] = 42;`
/// **æœŸæœ›è½¬æ¢**ï¼š
/// ```
/// let tmp1 = 0;
/// let tmp2 = mat[tmp1];
/// let tmp3 = 0;
/// ArrayPut(tmp2, tmp3, 42);
/// ```
/// **å…³é”®ç‚¹**ï¼šåµŒå¥—å·¦å€¼çš„å¤„ç†
///
/// ### æµ‹è¯•ç”¨ä¾‹ 4ï¼š`point.x = 100;`
/// **æœŸæœ›è½¬æ¢**ï¼š
/// ```
/// let tmp1 = 100;
/// StructFieldSet(point, "x", tmp1);
/// ```
/// **ç‰¹ç‚¹**ï¼šå­—æ®µèµ‹å€¼
///
/// ## ğŸ’¡ å®ç°æç¤º
///
/// 1. **å·¦å€¼å¤„ç†**ï¼šä½¿ç”¨ `left_value_to_knf` å¤„ç†å¤æ‚å·¦å€¼
/// 2. **è¡¨è¾¾å¼è½¬æ¢**ï¼šå°†å·¦å€¼è½¬æ¢ä¸ºè¡¨è¾¾å¼è¿›è¡Œå¤„ç†
/// 3. **ä¸´æ—¶å˜é‡**ï¼šä¸ºä¸­é—´ç»“æœåˆ›å»ºä¸´æ—¶å˜é‡
/// 4. **é€’å½’å¤„ç†**ï¼šå¯¹åµŒå¥—å·¦å€¼ä½¿ç”¨é€’å½’ç­–ç•¥
/// 5. **å¤åˆæ“ä½œ**ï¼šæ­£ç¡®å¤„ç†å¤åˆèµ‹å€¼æ“ä½œ
///
/// ## ğŸ”® ä¼˜åŒ–æ€è€ƒ
///
/// åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–é—®é¢˜ï¼š
///
/// ### é—®é¢˜ï¼šå¦‚ä½•å‡å°‘ä¸´æ—¶å˜é‡ï¼Ÿ
/// å¯¹äº `mat[0][0] = 42`ï¼Œæ˜¯å¦å¯ä»¥ç›´æ¥ç”Ÿæˆï¼š
/// ```
/// ArrayPut(mat, 0, 42);
/// ```
///
/// **æ€è€ƒ**ï¼š
/// - è¿™åœ¨ç®€å•æƒ…å†µä¸‹æ˜¯å¯èƒ½çš„
/// - ä½†åœ¨å¤æ‚åµŒå¥—æƒ…å†µä¸‹å¯èƒ½éš¾ä»¥å®ç°
/// - éœ€è¦æ·±å…¥åˆ†æå·¦å€¼çš„ç»“æ„
///
/// ### æ›´å¥½çš„æ–¹å¼ï¼Ÿ
/// è€ƒè™‘æ˜¯å¦æœ‰æ›´å¥½çš„ä¼˜åŒ–ç­–ç•¥ï¼š
/// - åœ¨å“ªä¸ªé˜¶æ®µè¿›è¡Œä¼˜åŒ–æ›´åˆé€‚ï¼Ÿ
/// - å¦‚ä½•å¹³è¡¡å®ç°çš„å¤æ‚åº¦å’Œä¼˜åŒ–æ•ˆæœï¼Ÿ
/// - å¦‚ä½•ç¡®ä¿ä¼˜åŒ–çš„æ­£ç¡®æ€§ï¼Ÿ
///
/// ## ğŸ¯ å¼€å§‹å®ç°å§ï¼
///
/// **å‡†å¤‡å¥½è¿æ¥å·¦å€¼å¤„ç†çš„æŒ‘æˆ˜äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å®ç°ï¼**
/// ================================================================================

///|
test "Assign Stmt Knf Transformation Test" {
  // Prelude Parts
  // set x, y type in typecheck and knf context
  let typecheck_ctx = @typecheck.Context::new()
  let point_struct_def : @typecheck.StructDef = {
    name: "Point",
    fields: [{ name: "x", ty: { kind: Int, mutable: true } }],
  }
  typecheck_ctx.struct_defs.set("Point", point_struct_def)
  typecheck_ctx.type_env.set("x", { kind: Int, mutable: true })
  typecheck_ctx.type_env.set("y", { kind: Double, mutable: true })
  typecheck_ctx.type_env.set("mat", { kind: Array(Array(Int)), mutable: true })
  typecheck_ctx.type_env.set("point", { kind: Struct("Point"), mutable: false })
  let knf_ctx = Context::new()
  let _ = knf_ctx.add_new_name("x", Int)
  let _ = knf_ctx.add_new_name("y", Double)
  let _ = knf_ctx.add_new_name("arr", Array(Int))
  let _ = knf_ctx.add_new_name("point", Struct("Point"))
  let _ = knf_ctx.add_new_name("mat", Array(Array(Int)))

  // Test Parts
  let code =
    #|x = 10;
    #|y = 3.14;
    #|x += 5;
    #|y -= 1.0;
    #|mat[0][0] = 42;
    #|point.x = 100;
  // Code parse, typecheck, knf transform
  let tokens = @lexer.tokenize(code)

  // Parse and transform `x = 10;`
  let (stmt, tok_view) = @parser.parse_assign_stmt(tokens)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s] &&
    s is Assign(name, expr) &&
    name is { id: "x", .. } &&
    expr is Int(10),
  )

  // Parse and transform `y = 3.14;`
  let (stmt, tok_view) = @parser.parse_assign_stmt(tok_view)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s] &&
    s is Assign(name, expr) &&
    name is { id: "y", .. } &&
    expr is Double(3.14),
  )

  // Parse and transform `x += 5;`
  let (stmt, tok_view) = @parser.parse_assign_stmt(tok_view)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s1, s2, s3] &&
    s1 is Let(_, Int, Int(5)) &&
    s2 is Let(_, Int, Binary(Add, _, _)) &&
    s3 is Assign(name, Ident(_)) &&
    name is { id: "x", .. },
  )

  // Parse and transform `y -= 1.0;`
  let (stmt, tok_view) = @parser.parse_assign_stmt(tok_view)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s1, s2, s3] &&
    s1 is Let(_, Double, Double(1.0)) &&
    s2 is Let(_, Double, Binary(Sub, _, _)) &&
    s3 is Assign(name, Ident(_)) &&
    name is { id: "y", .. },
  )
  // Parse and transform `max[0][0] = 42;`
  let (stmt, tok_view) = @parser.parse_assign_stmt(tok_view)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s1, s2, s3, s4] &&
    s1 is Let(n1, Int, Int(0)) &&
    s2 is Let(n2, Array(Int), ArrayAccess(_, mat_idx_name)) &&
    s3 is Let(n3, Int, Int(0)) &&
    s4 is ArrayPut(array_name, idx_name, Int(42)) &&
    n1 == mat_idx_name &&
    array_name == n2 &&
    idx_name == n3,
  )
  // Parse and transform `point.x = 100;`
  let (stmt, _) = @parser.parse_assign_stmt(tok_view)
  let stmt = typecheck_ctx.check_assign_stmt(stmt)
  let knf_stmts = knf_ctx.assign_stmt_to_knf(stmt)
  assert_true(
    knf_stmts is [s1, s2] &&
    s1 is Let(n1, Int, Int(100)) &&
    s2 is StructFieldSet(_, "x", value_name) &&
    n1 == value_name,
  )
}
