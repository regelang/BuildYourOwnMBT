/// ================================================================================
/// # ðŸŽ¯ ç¨‹åºçš„ KNF è½¬æ¢ï¼ˆæœ€ç»ˆç« ï¼‰
///
/// æ¬¢è¿Žæ¥åˆ° KNF å˜æ¢çš„**æœ€ç»ˆé˜¶æ®µ**ï¼åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†æ•´ä¸ªç¨‹åºè½¬æ¢ä¸º KNF å½¢å¼ã€‚
/// è¿™æ˜¯ KNF è½¬æ¢çš„æœ€åŽä¸€ç« ï¼Œæ­å–œä½ å³å°†å®Œæˆæ•´ä¸ª KNF è½¬æ¢çš„å­¦ä¹ ï¼
///
/// ## ðŸŽ¯ ä»€ä¹ˆæ˜¯ç¨‹åºè½¬æ¢ï¼Ÿ
///
/// ç¨‹åºè½¬æ¢æ˜¯å°†æ•´ä¸ªç±»åž‹æ£€æŸ¥åŽçš„ç¨‹åºï¼ˆTypedASTï¼‰è½¬æ¢ä¸º KNF å½¢å¼çš„è¿‡ç¨‹ã€‚
/// ç¨‹åºçš„åŸºæœ¬ç»“æž„åŒ…å«ï¼š
/// - ç»“æž„ä½“å®šä¹‰ï¼ˆStructDefï¼‰
/// - é¡¶å±‚å˜é‡å£°æ˜Žï¼ˆTopLetï¼‰
/// - é¡¶å±‚å‡½æ•°å®šä¹‰ï¼ˆTopFunctionï¼‰
///
/// ç¨‹åºè½¬æ¢çš„ç‰¹ç‚¹ï¼š
/// - éœ€è¦æŒ‰ç…§ç‰¹å®šé¡ºåºè¿›è¡Œè½¬æ¢
/// - å…ˆè½¬æ¢ç»“æž„ä½“å®šä¹‰ï¼Œå†è½¬æ¢é¡¶å±‚å˜é‡ï¼Œæœ€åŽè½¬æ¢å‡½æ•°
/// - éœ€è¦åˆå§‹åŒ–å…¨å±€çŽ¯å¢ƒ
/// - å°†æ‰€æœ‰ç»„ä»¶æ•´åˆä¸ºç»Ÿä¸€çš„ KNF ç¨‹åº
///
/// ## ðŸ” ç»“æž„å·®å¼‚åˆ†æž
///
/// åœ¨ç±»åž‹æ£€æŸ¥åŽçš„ç¨‹åºä¸­ï¼Œç»“æž„ç›¸å¯¹ç®€å•ï¼š
/// - `struct_defs`: ç»“æž„ä½“å®šä¹‰æ˜ å°„ï¼ˆMap[String, StructDef]ï¼‰
/// - `top_lets`: é¡¶å±‚å˜é‡æ˜ å°„ï¼ˆMap[String, TopLet]ï¼‰
/// - `top_functions`: é¡¶å±‚å‡½æ•°æ˜ å°„ï¼ˆMap[String, TopFunction]ï¼‰
///
/// åœ¨ KNF ä¸­ï¼Œç¨‹åºçš„ç»“æž„æ›´åŠ ç»Ÿä¸€ï¼š
/// - `KnfProgram`: åŒ…å« struct_defsã€top_letsã€functions çš„ç»“æž„ä½“
/// - `struct_defs`: KNF ç»“æž„ä½“å®šä¹‰æ˜ å°„ï¼ˆMap[String, KnfStructDef]ï¼‰
/// - `top_lets`: KNF é¡¶å±‚å˜é‡æ˜ å°„ï¼ˆMap[String, KnfTopLet]ï¼‰
/// - `functions`: KNF å‡½æ•°æ˜ å°„ï¼ˆMap[String, KnfFunction]ï¼‰
///
/// ## ðŸ› ï¸ å®žçŽ°æ€è·¯
///
/// å®žçŽ° `knf_transform` å‡½æ•°éœ€è¦å››ä¸ªä¸»è¦æ­¥éª¤ï¼š
///
/// ### 1. åˆå§‹åŒ–ä¸Šä¸‹æ–‡
/// - åˆ›å»ºæ–°çš„ KNF ä¸Šä¸‹æ–‡
/// - è®¾ç½®å†…ç½®å‡½æ•°ï¼ˆå¦‚ print_intï¼‰
/// - å‡†å¤‡å…¨å±€çŽ¯å¢ƒ
///
/// ### 2. è½¬æ¢ç»“æž„ä½“å®šä¹‰
/// - éåŽ†æ‰€æœ‰ç»“æž„ä½“å®šä¹‰
/// - ä½¿ç”¨ `struct_def_to_knf` è½¬æ¢æ¯ä¸ªç»“æž„ä½“
/// - å°†è½¬æ¢ç»“æžœå­˜å‚¨åˆ° KNF ç¨‹åºä¸­
///
/// ### 3. è½¬æ¢é¡¶å±‚å˜é‡
/// - éåŽ†æ‰€æœ‰é¡¶å±‚å˜é‡å£°æ˜Ž
/// - ä½¿ç”¨ `top_let_to_knf` è½¬æ¢æ¯ä¸ªå˜é‡
/// - å°†è½¬æ¢ç»“æžœå­˜å‚¨åˆ° KNF ç¨‹åºä¸­
///
/// ### 4. è½¬æ¢é¡¶å±‚å‡½æ•°
/// - éåŽ†æ‰€æœ‰é¡¶å±‚å‡½æ•°å®šä¹‰
/// - ä½¿ç”¨ `top_function_to_knf` è½¬æ¢æ¯ä¸ªå‡½æ•°
/// - å°†è½¬æ¢ç»“æžœå­˜å‚¨åˆ° KNF ç¨‹åºä¸­
///
/// ## ðŸ”§ å…³é”®å®žçŽ°ç»†èŠ‚
///
/// ### è½¬æ¢é¡ºåº
/// è½¬æ¢å¿…é¡»æŒ‰ç…§ç‰¹å®šé¡ºåºè¿›è¡Œï¼š
/// 1. **ç»“æž„ä½“å®šä¹‰**ï¼šå…ˆè½¬æ¢ç»“æž„ä½“ï¼Œå› ä¸ºå‡½æ•°å’Œå˜é‡å¯èƒ½å¼•ç”¨ç»“æž„ä½“ç±»åž‹
/// 2. **é¡¶å±‚å˜é‡**ï¼šå†è½¬æ¢é¡¶å±‚å˜é‡ï¼Œå› ä¸ºå‡½æ•°å¯èƒ½å¼•ç”¨è¿™äº›å˜é‡
/// 3. **é¡¶å±‚å‡½æ•°**ï¼šæœ€åŽè½¬æ¢å‡½æ•°ï¼Œå› ä¸ºå‡½æ•°å¯èƒ½å¼•ç”¨ç»“æž„ä½“å’Œå˜é‡
///
/// ### å…¨å±€çŽ¯å¢ƒåˆå§‹åŒ–
/// éœ€è¦è®¾ç½®å†…ç½®å‡½æ•°å’Œå…¨å±€çŽ¯å¢ƒï¼š
/// - è®¾ç½® print_int ç­‰å†…ç½®å‡½æ•°
/// - åˆå§‹åŒ–å…¨å±€å˜é‡æ˜ å°„
/// - å‡†å¤‡å‡½æ•°ç±»åž‹çŽ¯å¢ƒ
///
/// ### ç»„ä»¶æ•´åˆ
/// å°†æ‰€æœ‰è½¬æ¢åŽçš„ç»„ä»¶æ•´åˆä¸ºç»Ÿä¸€çš„ KNF ç¨‹åºï¼š
/// - ç»“æž„ä½“å®šä¹‰æ˜ å°„
/// - é¡¶å±‚å˜é‡æ˜ å°„
/// - å‡½æ•°æ˜ å°„
///
/// ### é”™è¯¯å¤„ç†
/// åœ¨æ•´ä¸ªè½¬æ¢è¿‡ç¨‹ä¸­éœ€è¦å¤„ç†å¯èƒ½çš„é”™è¯¯ï¼š
/// - ç±»åž‹è½¬æ¢é”™è¯¯
/// - ä½œç”¨åŸŸé”™è¯¯
/// - é‡å¤å®šä¹‰é”™è¯¯
///
/// ## ðŸ“ æµ‹è¯•ç”¨ä¾‹è§£æž
///
/// ### æµ‹è¯•ç”¨ä¾‹ï¼šå¤æ‚ç¨‹åº
/// æµ‹è¯•ç”¨ä¾‹åŒ…å«ï¼š
/// - é¡¶å±‚å˜é‡ï¼ša, b
/// - é¡¶å±‚å‡½æ•°ï¼šfold, main
/// - å±€éƒ¨å‡½æ•°ï¼šmax, minï¼ˆåœ¨ main ä¸­å®šä¹‰ï¼‰
/// - å¤æ‚è¡¨è¾¾å¼ï¼šæ•°ç»„ã€å‡½æ•°è°ƒç”¨ã€å¾ªçŽ¯ç­‰
///
/// è½¬æ¢è¿‡ç¨‹ï¼š
/// 1. è½¬æ¢ç»“æž„ä½“å®šä¹‰ï¼ˆå¦‚æžœæœ‰ï¼‰
/// 2. è½¬æ¢é¡¶å±‚å˜é‡ a, b
/// 3. è½¬æ¢é¡¶å±‚å‡½æ•° fold
/// 4. è½¬æ¢é¡¶å±‚å‡½æ•° mainï¼ˆåŒ…å«å±€éƒ¨å‡½æ•° max, minï¼‰
/// 5. æ•´åˆä¸ºå®Œæ•´çš„ KNF ç¨‹åº
///
/// ### è½¬æ¢ç»“æžœ
/// è½¬æ¢åŽçš„ KNF ç¨‹åºåŒ…å«ï¼š
/// - æ‰€æœ‰é¡¶å±‚å˜é‡çš„ KNF å½¢å¼
/// - æ‰€æœ‰å‡½æ•°çš„ KNF å½¢å¼
/// - æ‰€æœ‰å±€éƒ¨å‡½æ•°çš„é—­åŒ…å½¢å¼
/// - æ‰€æœ‰è¡¨è¾¾å¼çš„ KNF å½¢å¼
///
/// ## ðŸ’¡ è®¾è®¡æ€æƒ³
///
/// ### ç»Ÿä¸€ç»“æž„
/// å°†æ•´ä¸ªç¨‹åºè½¬æ¢ä¸ºç»Ÿä¸€çš„ KNF ç»“æž„ï¼Œä¾¿äºŽåŽç»­å¤„ç†ã€‚
///
/// ### é¡ºåºä¾èµ–
/// æŒ‰ç…§ä¾èµ–å…³ç³»ç¡®å®šè½¬æ¢é¡ºåºï¼Œç¡®ä¿ç±»åž‹å’Œå˜é‡å¯ç”¨ã€‚
///
/// ### å…¨å±€ç®¡ç†
/// ç»Ÿä¸€ç®¡ç†å…¨å±€çŽ¯å¢ƒï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶åè°ƒå·¥ä½œã€‚
///
/// ### å®Œæ•´æ€§ä¿è¯
/// ç¡®ä¿æ‰€æœ‰ç¨‹åºç»„ä»¶éƒ½è¢«æ­£ç¡®è½¬æ¢ã€‚
///
/// ## ðŸš€ å®žçŽ°æŒ‘æˆ˜
///
/// ### è½¬æ¢é¡ºåº
/// éœ€è¦æ­£ç¡®ç¡®å®šè½¬æ¢é¡ºåºï¼Œé¿å…ä¾èµ–é—®é¢˜ã€‚
///
/// ### å…¨å±€çŽ¯å¢ƒ
/// éœ€è¦æ­£ç¡®åˆå§‹åŒ–å’Œç®¡ç†å…¨å±€çŽ¯å¢ƒã€‚
///
/// ### ç»„ä»¶æ•´åˆ
/// éœ€è¦å°†æ‰€æœ‰è½¬æ¢åŽçš„ç»„ä»¶æ­£ç¡®æ•´åˆã€‚
///
/// ### é”™è¯¯å¤„ç†
/// éœ€è¦å¤„ç†è½¬æ¢è¿‡ç¨‹ä¸­å¯èƒ½å‡ºçŽ°çš„å„ç§é”™è¯¯ã€‚
///
/// ## ðŸŽ¯ å®žçŽ°ç›®æ ‡
///
/// å®Œæˆ `knf.mbt` ä¸­çš„ `knf_transform` å‡½æ•°ï¼Œå®žçŽ°æ•´ä¸ªç¨‹åºçš„ KNF è½¬æ¢ã€‚
/// å‡½æ•°åº”è¯¥ï¼š
/// 1. æ­£ç¡®åˆå§‹åŒ– KNF ä¸Šä¸‹æ–‡
/// 2. æŒ‰ç…§æ­£ç¡®é¡ºåºè½¬æ¢æ‰€æœ‰ç»„ä»¶
/// 3. æ­£ç¡®è®¾ç½®å…¨å±€çŽ¯å¢ƒ
/// 4. å°†æ‰€æœ‰ç»„ä»¶æ•´åˆä¸ºç»Ÿä¸€çš„ KNF ç¨‹åº
/// 5. å¤„ç†è½¬æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯
///
/// ## ðŸŽ‰ æ­å–œå®Œæˆ KNF è½¬æ¢ï¼
///
/// æ­å–œä½ å®Œæˆäº†æ•´ä¸ª KNF è½¬æ¢çš„å­¦ä¹ ï¼ä½ å·²ç»æŽŒæ¡äº†ï¼š
/// - ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰çš„æ¦‚å¿µ
/// - ç®¡ç†èŒƒå¼ï¼ˆANFï¼‰çš„åŽŸç†
/// - æ ¸å¿ƒèŒƒå¼ï¼ˆKNFï¼‰çš„è½¬æ¢
/// - é™æ€å•èµ‹å€¼ï¼ˆSSAï¼‰çš„å‡†å¤‡
///
/// çŽ°åœ¨ä½ å·²ç»å‡†å¤‡å¥½è¿›å…¥ä¸‹ä¸€ä¸ªå¤§ç¯‡ç« ï¼š**LLVM IR**ï¼
/// åœ¨ LLVM IR ä¸­ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•å°† KNF è½¬æ¢ä¸º LLVM ä¸­é—´è¡¨ç¤ºï¼Œ
/// è¿™æ˜¯ç¼–è¯‘å™¨åŽç«¯çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå°†ä¸ºä½ æ‰“å¼€ä»£ç ç”Ÿæˆçš„å¤§é—¨ã€‚
///
/// è®©æˆ‘ä»¬å¼€å§‹å®žçŽ°ç¨‹åºçš„è½¬æ¢å§ï¼ðŸš€
///
/// ================================================================================

///|
test "Top Function Knf Transformation Test" {
  let code =
    #|let a = 3;
    #|let b = 4;
    #|fn fold(arr: Array[Int], f: (Int, Int) -> Int, initv: Int) -> Int { 
    #|  let mut result = initv;
    #|  let mut i = 0; 
    #|  while i < arr.length() {
    #|    result = f(result, arr[i]);
    #|  }
    #|  result
    #|}
    #|
    #|fn main {
    #|  fn max(a, b) { if a > b { a } else { b } }
    #|  fn min(a, b) { if a < b { a } else { b } }
    #|  let numbers = [a, 1, b, 1, 5, 9, 2, 6, 5];
    #|  let maximum = fold(numbers, max, -1000);
    #|  let minimum = fold(numbers, min, 1000);
    #|  let max_min_diff = maximum - minimum;
    #|  print_int(max_min_diff);
    #|}

  let tokens = @lexer.tokenize(code)
  let program = @parser.parse(tokens)
  let program = @typecheck.typecheck(program)
  let knf = knf_transform(program)
  assert_true(knf.top_lets.contains("a"))
  assert_true(knf.top_lets.contains("b"))
  assert_true(knf.functions.contains("fold"))
  assert_true(knf.functions.contains("main"))
  // if you call println(knf), you should see
  // the knf program like follows: 
  // ```
  // let a : Int = 3;
  // let b : Int = 4;
  // fn fold(arr: Array[Int], f: (Int, Int) -> Int, initv: Int) -> Int {
  //   let mut result : Int = initv;
  //   let mut i : Int = 0;
  //   while {let tmp : () -> Int = arr.length; let tmp$1 : Int = tmp(); i < tmp$1; } {
  //     let tmp$2 : Int = arr[i];
  //     result = f(result, tmp$2);
  //   }
  //   result;
  // }
  // fn main {
  //   fn max(a$1 : Int, b$1 : Int) -> Int {
  //     if a$1 > b$1 {
  //       a$1;
  //     } else {
  //       b$1;
  //     };
  //   }
  //   fn min(a$1 : Int, b$1 : Int) -> Int {
  //     if a$1 < b$1 {
  //       a$1;
  //     } else {
  //       b$1;
  //     };
  //   }
  //   let tmp : Int = 1;
  //   let tmp$1 : Int = 1;
  //   let tmp$2 : Int = 5;
  //   let tmp$3 : Int = 9;
  //   let tmp$4 : Int = 2;
  //   let tmp$5 : Int = 6;
  //   let tmp$6 : Int = 5;
  //   let numbers : Array[Int] = [a, tmp, b, tmp$1, tmp$2, tmp$3, tmp$4, tmp$5, tmp$6];
  //   let tmp$7 : Int = 1000;
  //   let tmp$8 : Int = -tmp$7;
  //   let maximum : Int = fold(numbers, max, tmp$8);
  //   let tmp$9 : Int = 1000;
  //   let minimum : Int = fold(numbers, min, tmp$9);
  //   let max_min_diff : Int = maximum - minimum;
  //   print_int(max_min_diff);
  // }
  // ```
}
