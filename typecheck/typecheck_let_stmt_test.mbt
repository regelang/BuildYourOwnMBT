/// ================================================================================
/// # ç±»å‹æ£€æŸ¥è¯­å¥ï¼šlet ä¸æ¨¡å¼åŒ¹é…
///
/// æˆ‘ä»¬å·²ç»å¤„ç†äº† `let mut` å’Œé¡¶å±‚çš„ `let`ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å¤„ç†å‡½æ•°ä½“å†…éƒ¨æœ€å¸¸è§çš„ `let` è¯­å¥ã€‚
///
/// å®ƒä¸æˆ‘ä»¬ä¹‹å‰å®ç°çš„ `let` æ£€æŸ¥æœ€å¤§çš„ä¸åŒåœ¨äºï¼š**å·¦ä¾§å¯ä»¥æ˜¯ä¸€ä¸ªå¤æ‚çš„æ¨¡å¼ï¼ˆPatternï¼‰**ã€‚
///
/// ```moonbit
/// let (a, (b, c)) = (1, (true, "hello"));
/// ```
///
/// ç±»å‹æ£€æŸ¥å™¨éœ€è¦èƒ½å¤Ÿâ€œè§£å¼€â€ç­‰å·ä¸¤è¾¹çš„ç»“æ„ï¼Œå¹¶å°†å³ä¾§å€¼çš„ç±»å‹æ­£ç¡®åœ°èµ‹äºˆå·¦ä¾§æ¨¡å¼ä¸­çš„æ¯ä¸€ä¸ªå˜é‡ã€‚
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `check_let_stmt`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `typecheck/let_stmt.mbt` æ–‡ä»¶ä¸­å®ç° `Context::check_let_stmt` å‡½æ•°ã€‚
///
/// ### ğŸ’¡ å®ç°æ€è·¯
///
/// 1.  **æ£€æŸ¥è¡¨è¾¾å¼ç±»å‹ï¼š** å’Œä¹‹å‰ä¸€æ ·ï¼Œé¦–å…ˆè°ƒç”¨ `check_expr` è·å¾— `=` å³ä¾§è¡¨è¾¾å¼çš„ç±»å‹ `T`ã€‚
///
/// 2.  **å¤„ç†ç±»å‹æ³¨è§£ï¼š** å¦‚æœ `let` è¯­å¥å¸¦æœ‰ç±»å‹æ³¨è§£ï¼ˆä¾‹å¦‚ `let (a, b): (Int, Int) = ...`ï¼‰ï¼Œåˆ™éœ€è¦æ£€æŸ¥è¡¨è¾¾å¼ç±»å‹ `T` æ˜¯å¦ä¸è¯¥æ³¨è§£å…¼å®¹ã€‚
///
/// 3.  **ç»‘å®šæ¨¡å¼ä¸ç±»å‹ï¼ˆæ ¸å¿ƒï¼ï¼‰ï¼š**
///     *   è¿™æ˜¯æœ¬æ¬¡æŒ‘æˆ˜æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚ä½ éœ€è¦å°†å·¦ä¾§çš„ `pattern` å’Œå³ä¾§çš„ç±»å‹ `T` è¿›è¡ŒåŒ¹é…å’Œç»‘å®šã€‚
///     *   å»ºè®®ä¸ºæ­¤å®ç°ä¸€ä¸ªå•ç‹¬çš„è¾…åŠ©å‡½æ•°ï¼Œä¾‹å¦‚ `bind_pattern_type(pattern: Pattern, ty: TypeKind)`ã€‚
///     *   è¿™ä¸ªå‡½æ•°éœ€è¦é€’å½’åœ°å¤„ç†æ¨¡å¼ï¼š
///         *   **`Ident(name)`ï¼š** æœ€ç®€å•çš„æƒ…å†µã€‚å°† `name` å’Œç±»å‹ `ty` æ·»åŠ åˆ°ç±»å‹ç¯å¢ƒä¸­ï¼ˆæ³¨æ„æ˜¯**ä¸å¯å˜**çš„ `mutable: false`ï¼‰ã€‚
///         *   **`Wildcard` (`_`)ï¼š** å¿½ç•¥å³å¯ï¼Œå®ƒä¸å¼•å…¥ä»»ä½•æ–°çš„å˜é‡ç»‘å®šã€‚
///         *   **`Tuple(sub_patterns)`ï¼š** è¿™æ˜¯é€’å½’çš„å…³é”®ã€‚
///             *   é¦–å…ˆï¼Œæ£€æŸ¥ç±»å‹ `ty` æ˜¯å¦ä¹Ÿæ˜¯ä¸€ä¸ªå…ƒç»„ç±»å‹ `Tuple(element_types)`ã€‚å¦‚æœä¸æ˜¯ï¼ˆä¾‹å¦‚ï¼Œè¯•å›¾ç”¨å…ƒç»„æ¨¡å¼åŒ¹é…ä¸€ä¸ª `Int`ï¼‰ï¼Œåˆ™æŠ›å‡ºç±»å‹é”™è¯¯ã€‚
///             *   ç„¶åï¼Œæ£€æŸ¥æ¨¡å¼å’Œç±»å‹çš„é•¿åº¦æ˜¯å¦ä¸€è‡´ã€‚
///             *   æœ€åï¼Œéå† `sub_patterns` å’Œ `element_types`ï¼Œå¯¹æ¯ä¸€å¯¹ `(sub_pattern, element_type)` **é€’å½’è°ƒç”¨ `bind_pattern_type`**ã€‚
///
/// é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥ä¼˜é›…åœ°å°†ä»»æ„å¤æ‚çš„ç±»å‹â€œè§£æ„â€å¹¶ç»‘å®šåˆ°å¯¹åº”çš„å˜é‡ä¸Šã€‚
///
/// ---
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p typecheck -f typecheck_let_stmt_test.mbt
/// ```
///
/// æ­å–œä½ ï¼å®Œæˆè¿™ä¸€æ­¥ï¼Œä½ çš„ç±»å‹æ£€æŸ¥å™¨å°±å‡ ä¹æ‹¥æœ‰å¤„ç†æ‰€æœ‰æ ¸å¿ƒè¯­è¨€ç‰¹æ€§çš„èƒ½åŠ›äº†ï¼
/// ================================================================================

///|
test "Let Stmt Type Check" {
  let code =
    #|let x : Double = 42.0;
    #|let (x, y) = (1, 2);
    #|let z = [];
    #|let mat = [[1, 2], z];
    #|let _ = z.push(true);
  let ctx = Context::new()
  // Parse
  let tokens = @lexer.tokenize(code)
  // Type check for `let x : Int = 42;`
  let (let_stmt1, tok_view) = @parser.parse_let_stmt(tokens[:])
  let checked_let_stmt1 = ctx.check_let_stmt(let_stmt1)
  assert_true(checked_let_stmt1.ty is Double)
  // Type check for `let (x, y) = (1, 2);`
  let (let_stmt2, tok_view) = @parser.parse_let_stmt(tok_view)
  let checked_let_stmt2 = ctx.check_let_stmt(let_stmt2)
  assert_true(checked_let_stmt2.ty is Tuple([Int, Int]))
  assert_true(ctx.lookup_type("x") is Some({ kind: Int, .. }))
  assert_true(ctx.lookup_type("y") is Some({ kind: Int, .. }))
  // Type check for `let z = [];`
  let (let_stmt3, tok_view) = @parser.parse_let_stmt(tok_view)
  let checked_let_stmt3 = ctx.check_let_stmt(let_stmt3)
  assert_true(checked_let_stmt3.ty is Array(TypeVar(_)))
  // Type check for `let mat = [[1, 2], z];`
  let (let_stmt4, tok_view) = @parser.parse_let_stmt(tok_view)
  let checked_let_stmt4 = ctx.check_let_stmt(let_stmt4)
  assert_true(checked_let_stmt4.ty is Array(Array(Int)))
  assert_true(ctx.lookup_type("mat") is Some({ kind: Array(Array(Int)), .. }))
  let zty = ctx.lookup_type("z")
  assert_true(
    ctx.lookup_type("z") is Some({ kind: Array(Int), .. }),
    msg="Type of z is \{zty}",
  )
  // Type check for `let _ = z.push(true);`
  // Should fail
  let (let_stmt5, _) = @parser.parse_let_stmt(tok_view)
  let check_result = try? ctx.check_let_stmt(let_stmt5)
  assert_true(check_result is Err(_))
}
