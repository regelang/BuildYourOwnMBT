/// ================================================================================
/// # ç±»å‹æ£€æŸ¥è¯­å¥ï¼šlet mut
///
/// æˆ‘ä»¬å·²ç»èƒ½å¤Ÿæ£€æŸ¥å„ç§å¤æ‚çš„è¡¨è¾¾å¼äº†ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™å°†ç›®å…‰è½¬å‘**è¯­å¥ï¼ˆStatementsï¼‰**çš„ç±»å‹æ£€æŸ¥äº†ã€‚
///
/// è¯­å¥ä¸è¡¨è¾¾å¼çš„æ ¸å¿ƒåŒºåˆ«åœ¨äºï¼šè¯­å¥ä¸ä¸€å®šæœ‰â€œå€¼â€ï¼Œä½†å®ƒä»¬é€šå¸¸ä¼šäº§ç”Ÿ**å‰¯ä½œç”¨ï¼ˆSide Effectsï¼‰**ã€‚
/// åœ¨ç±»å‹æ£€æŸ¥ä¸­ï¼Œæœ€é‡è¦çš„å‰¯ä½œç”¨å°±æ˜¯**æ”¹å˜ç±»å‹ç¯å¢ƒï¼ˆType Environmentï¼‰**ã€‚
///
/// `let mut` è¯­å¥å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå®ƒä¼šå‘å½“å‰ä½œç”¨åŸŸå¼•å…¥ä¸€ä¸ªæ–°çš„å¯å˜å˜é‡ã€‚
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `check_let_mut_stmt`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `typecheck/let_mut_stmt.mbt` æ–‡ä»¶ä¸­å®ç° `Context::check_let_mut_stmt` å‡½æ•°ã€‚
///
/// ### ğŸ’¡ å®ç°æ€è·¯
///
/// `check_let_mut_stmt` çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
///
/// 1.  **æ£€æŸ¥è¡¨è¾¾å¼ï¼š** é¦–å…ˆï¼Œè°ƒç”¨ `self.check_expr` æ¥ç¡®å®š `=` å³ä¾§è¡¨è¾¾å¼çš„ç±»å‹ã€‚
///
/// 2.  **å¤„ç†ç±»å‹æ³¨è§£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š**
///     *   `let mut` è¯­å¥å¯èƒ½å¸¦æœ‰æ˜¾å¼çš„ç±»å‹æ³¨è§£ï¼Œä¾‹å¦‚ `let mut x: Double = ...`ã€‚
///     *   å¦‚æœå­˜åœ¨ç±»å‹æ³¨è§£ï¼Œä½ éœ€è¦è°ƒç”¨ `self.check_parser_type` æ¥è½¬æ¢å®ƒã€‚
///     *   ç„¶åï¼Œ**å…³é”®ä¸€æ­¥**ï¼šä½¿ç”¨ `self.is_type_compatible` éªŒè¯è¡¨è¾¾å¼çš„ç±»å‹æ˜¯å¦ä¸æ³¨è§£çš„ç±»å‹å…¼å®¹ã€‚å¦‚æœä¸å…¼å®¹ï¼Œåˆ™åº”æŠ›å‡ºç±»å‹é”™è¯¯ã€‚
///
/// 3.  **ç¡®å®šå˜é‡ç±»å‹ï¼š**
///     *   å¦‚æœå­˜åœ¨ç±»å‹æ³¨è§£ï¼Œå˜é‡çš„ç±»å‹å°±æ˜¯è¯¥æ³¨è§£çš„ç±»å‹ã€‚
///     *   å¦‚æœä¸å­˜åœ¨ï¼Œå˜é‡çš„ç±»å‹å°±ä»è¡¨è¾¾å¼çš„ç±»å‹ä¸­**æ¨æ–­**å‡ºæ¥ã€‚
///
/// 4.  **æ›´æ–°ç±»å‹ç¯å¢ƒï¼š**
///     *   è¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼ä¸€æ—¦ç¡®å®šäº†æ–°å˜é‡çš„åç§°å’Œç±»å‹ï¼Œä½ å¿…é¡»å°†å®ƒæ·»åŠ åˆ°ç±»å‹ç¯å¢ƒ `self.type_env` ä¸­ã€‚
///     *   åœ¨æ·»åŠ åˆ°ç¯å¢ƒæ—¶ï¼Œè¯·åŠ¡å¿…æ ‡è®°è¯¥ç±»å‹ä¸º**å¯å˜çš„ï¼ˆmutable: trueï¼‰**ã€‚è¿™å¯¹äºåç»­çš„èµ‹å€¼è¯­å¥æ£€æŸ¥è‡³å…³é‡è¦ã€‚
///
/// ### ğŸ¤” æ·±å…¥æ€è€ƒï¼šç©ºæ•°ç»„çš„ç±»å‹æ¨æ–­
///
/// æœ¬æ¬¡æŒ‘æˆ˜çš„æµ‹è¯•ç”¨ä¾‹åŒ…å« `let mut z = []`ã€‚
///
/// > å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªç©ºæ•°ç»„æ—¶ï¼Œå®ƒçš„å…ƒç´ ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ`Int`? `String`?
///
/// åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘ä»¬**æ— æ³•çŸ¥é“**ã€‚è¿™å°±æ˜¯**ç±»å‹å˜é‡ï¼ˆType Variableï¼‰**ç™»åœºçš„æ—¶æœºã€‚
/// å½“é‡åˆ°æ— æ³•ç«‹å³ç¡®å®šçš„ç±»å‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„â€œå ä½ç¬¦â€ç±»å‹ï¼Œä¾‹å¦‚ `Array(TypeVar(0))`ã€‚
///
/// åœ¨åç»­ä»£ç ä¸­ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡å¯¹ `z` è¿›è¡Œæ“ä½œæ—¶ï¼ˆä¾‹å¦‚ `z.push(3.14)`ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† `TypeVar(0)` çš„å®é™…ç±»å‹â€œç»‘å®šâ€ä¸º `Double`ã€‚
/// è¿™å°±æ˜¯ç±»å‹æ¨æ–­çš„æ ¸å¿ƒæ€æƒ³ä¹‹ä¸€ã€‚ä½ çš„ `check_array_expr` å‡½æ•°å¯èƒ½éœ€è¦æ”¯æŒè¿™ç§è¡Œä¸ºã€‚
///
/// ---
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p typecheck -f typecheck_let_mut_stmt_test.mbt
/// ```
/// ================================================================================

///|
test "Let Mut Stmt Type Check" {
  let code =
    #|let mut x : Double = 42.0;
    #|let mut y = 10;
    #|let mut z = [];
    #|let _ = z.push(3.14);
    #|let _ = z.push("Hello"); // Should fail
  let ctx = Context::new()
  // Parse
  let tokens = @lexer.tokenize(code)
  // Type check for `let mut x : Double = 42.0;`
  let (let_mut_stmt1, tok_view) = @parser.parse_let_mut_stmt(tokens[:])
  let checked_let_mut_stmt1 = ctx.check_let_mut_stmt(let_mut_stmt1)
  assert_true(checked_let_mut_stmt1.ty is Double)
  // Type check for `let mut y = 10;`
  let (let_mut_stmt2, tok_view) = @parser.parse_let_mut_stmt(tok_view)
  let checked_let_mut_stmt2 = ctx.check_let_mut_stmt(let_mut_stmt2)
  assert_true(checked_let_mut_stmt2.ty is Int)
  // Type check for `let mut z = [];`
  let (let_mut_stmt3, tok_view) = @parser.parse_let_mut_stmt(tok_view)
  let checked_let_mut_stmt3 = ctx.check_let_mut_stmt(let_mut_stmt3)
  assert_true(checked_let_mut_stmt3.ty is Array(TypeVar(_)))
  // Type check for `let _ = z.push(3.14);`
  // Parse Let Stmt
  let (let_stmt4, tok_view) = @parser.parse_let_stmt(tok_view)
  let checked_let_stmt4 = ctx.check_let_stmt(let_stmt4)
  assert_true(checked_let_stmt4.ty is Unit)
  assert_true(ctx.lookup_type("z") is Some({ kind: Array(Double), .. }))
  // Type check for `let _ = z.push("Hello");` - Should fail
  let (let_stmt5, _) = @parser.parse_let_stmt(tok_view)
  let check_result = try? ctx.check_let_stmt(let_stmt5)
  assert_true(check_result is Err(_))
}
