/// ================================================================================
/// # ç±»åž‹æ£€æŸ¥çš„æ ¸å¿ƒï¼šExpr
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥å¤„ç† `AtomExpr` å’Œ `ApplyExpr` äº†ã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ°äº†ç±»åž‹æ£€æŸ¥çš„æ ¸å¿ƒæž¢çº½ï¼š`check_expr` å‡½æ•°ã€‚
///
/// `Expr` æ˜¯ä¸€ä¸ªé€’å½’çš„æžšä¸¾ç±»åž‹ï¼Œå®ƒå¯ä»¥ä»£è¡¨å„ç§å¤æ‚çš„è¡¨è¾¾å¼ï¼Œå¦‚ä¸€å…ƒè¿ç®—ã€äºŒå…ƒè¿ç®—ç­‰ã€‚
/// `check_expr` çš„èŒè´£å°±æ˜¯æ·±å…¥åˆ°è¿™äº›è¡¨è¾¾å¼çš„å†…éƒ¨ï¼ŒéªŒè¯å®ƒä»¬çš„ç±»åž‹è§„åˆ™ï¼Œå¹¶æœ€ç»ˆç¡®å®šæ•´ä¸ªè¡¨è¾¾å¼çš„ç±»åž‹ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡ï¼šå®žçŽ° `check_expr`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `typecheck/expr.mbt` æ–‡ä»¶ä¸­å®žçŽ° `Context::check_expr` å‡½æ•°ã€‚
/// æœ¬æ¬¡æŒ‘æˆ˜çš„æµ‹è¯•è¦†ç›–äº†å¤šç§è¡¨è¾¾å¼ï¼Œä½ éœ€è¦ä¸€æ¬¡æ€§å¤„ç†å®ƒä»¬ï¼
///
/// ### ðŸ’¡ å®žçŽ°æ€è·¯
///
/// ä½ éœ€è¦åœ¨ `check_expr` ä¸­ `match` ä¼ å…¥çš„ `expr.kind`ï¼Œå¹¶ä¸ºä¸åŒçš„æƒ…å†µç¼–å†™ç±»åž‹æ£€æŸ¥é€»è¾‘ï¼š
///
/// 1.  **`ApplyExpr(apply_expr)`:**
///     *   è¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µã€‚ç›´æŽ¥è°ƒç”¨æˆ‘ä»¬åˆšå®Œæˆçš„ `self.check_apply_expr(apply_expr)`ã€‚
///     *   è¿”å›žçš„ `ApplyExpr` å·²ç»å¸¦æœ‰äº†ç±»åž‹ï¼Œç”¨å®ƒæ¥æž„é€ ä¸€ä¸ª `typecheck::Expr` å¹¶è¿”å›žã€‚
///
/// 2.  **`NotExpr(inner_expr)` (é€»è¾‘éž `!`)**
///     *   é¦–å…ˆï¼Œé€’å½’è°ƒç”¨ `self.check_expr(inner_expr)` æ¥æ£€æŸ¥å†…éƒ¨è¡¨è¾¾å¼ã€‚
///     *   **ç±»åž‹è§„åˆ™ï¼š** `!` æ“ä½œç¬¦åªèƒ½ç”¨äºŽ `Bool` ç±»åž‹ã€‚ä½ éœ€è¦æ£€æŸ¥ `inner_expr` çš„ç±»åž‹æ˜¯å¦ä¸º `Bool`ã€‚å¦‚æžœä¸æ˜¯ï¼Œå°±æŠ›å‡ºç±»åž‹é”™è¯¯ã€‚
///     *   **è¿”å›žç±»åž‹ï¼š** `NotExpr` æœ¬èº«çš„ç±»åž‹æ°¸è¿œæ˜¯ `Bool`ã€‚
///
/// 3.  **`NegExpr(inner_expr)` (å–å `-`)**
///     *   åŒæ ·ï¼Œé€’å½’è°ƒç”¨ `self.check_expr(inner_expr)`ã€‚
///     *   **ç±»åž‹è§„åˆ™ï¼š** `-` æ“ä½œç¬¦åœ¨æˆ‘ä»¬çš„è¯­è¨€ä¸­åªèƒ½ç”¨äºŽ `Int` æˆ– `Double`ã€‚ä½ éœ€è¦æ£€æŸ¥ `inner_expr` çš„ç±»åž‹ã€‚
///     *   **è¿”å›žç±»åž‹ï¼š** `NegExpr` çš„ç±»åž‹ä¸Žå®ƒå†…éƒ¨è¡¨è¾¾å¼çš„ç±»åž‹ç›¸åŒã€‚
///
/// 4.  **`BinaryExpr(op, left, right)` (äºŒå…ƒè¿ç®—)**
///     *   è¿™æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œé€’å½’è°ƒç”¨ `check_expr` æ£€æŸ¥å·¦å³ä¸¤ä¸ªå­è¡¨è¾¾å¼ `left` å’Œ `right`ã€‚
///     *   **é€šç”¨è§„åˆ™ï¼š** å¯¹äºŽæ‰€æœ‰äºŒå…ƒè¿ç®—ï¼Œå·¦å³ä¸¤ä¸ªæ“ä½œæ•°çš„ç±»åž‹å¿…é¡»å…¼å®¹ï¼ˆåœ¨æˆ‘ä»¬çš„ç®€å•å®žçŽ°ä¸­ï¼Œæ„å‘³ç€ç±»åž‹å¿…é¡»å®Œå…¨ç›¸åŒï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨ `self.is_type_compatible(...)` è¾…åŠ©å‡½æ•°æ¥åˆ¤æ–­ã€‚
///     *   **æ ¹æ®æ“ä½œç¬¦ `op` åˆ¤æ–­è¿”å›žç±»åž‹ï¼š**
///         *   **ç®—æœ¯è¿ç®— (`+`, `-`, `*`, `/`, `%`)ï¼š** æ“ä½œæ•°å¿…é¡»æ˜¯ `Int` æˆ– `Double`ã€‚è¿”å›žç±»åž‹ä¸Žæ“ä½œæ•°ç±»åž‹ç›¸åŒã€‚
///         *   **æ¯”è¾ƒè¿ç®— (`>`, `<`, `==`, `!=`, `>=`, `<=`)ï¼š** æ“ä½œæ•°å¯ä»¥æ˜¯ `Int` æˆ– `Double`ã€‚è¿”å›žç±»åž‹æ°¸è¿œæ˜¯ `Bool`ã€‚
///         *   **é€»è¾‘è¿ç®— (`&&`, `||`)ï¼š** æ“ä½œæ•°å¿…é¡»æ˜¯ `Bool`ã€‚è¿”å›žç±»åž‹ä¹Ÿæ˜¯ `Bool`ã€‚ï¼ˆæ³¨ï¼šæœ¬æ¬¡æµ‹è¯•æœªè¦†ç›–ï¼Œä½†å¯ä»¥æå‰æ€è€ƒï¼‰
///
/// ---
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// å®ŒæˆåŽï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€éªŒä½ çš„å®žçŽ°ï¼š
///
/// ```bash
/// moon test -p typecheck -f typecheck_simple_expr_test.mbt
/// ```
///
/// åŠ æ²¹ï¼è¿™æ˜¯ç±»åž‹æ£€æŸ¥å™¨ä¸­å·¥ä½œé‡æœ€å¤§ã€ä¹Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚
/// ================================================================================

///|
test "Simple Expression Type Check" {
  let code =
    #|42 ; 3.14 ; true ; "Hello";
    #|!true ; !false ; !x ;
    #|-42 ; -3.14 ; -y ;
    #|1 + 3; 4 - 5 ; 6 * 7; 8.0 / 2.0; 9 % 4;
    #|1 > 2; 42.0 >= y; x == true ;
  let ctx = Context::new()
  ctx.type_env.set("x", { kind: TypeKind::Bool, mutable: false })
  ctx.type_env.set("y", { kind: TypeKind::Double, mutable: false })
  // Parse
  let tokens = @lexer.tokenize(code)
  // Type of 42
  let (a, tok_view) = @parser.parse_expr(tokens[:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  // Type of 3.14
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Double)
  // Type of true
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  // Type of "Hello"
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is String)
  // Type of !true
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  // Type of !false
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  // Type of !x
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  // Type of -42
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  // Type of -3.14
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Double)
  // Type of -y
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Double)
  // Type of 1 + 3
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  // Type of 4 - 5
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  // Type of 6 * 7
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  // Type of 8.0 / 2.0
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Double)
  // Type of 9 % 4
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Int)
  //// Type of 1 > 2
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  //// Type of 42 == y
  let (a, tok_view) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
  //// Type of x == true
  let (a, _) = @parser.parse_expr(tok_view[1:])
  let a = ctx.check_expr(a)
  assert_true(a.ty is Bool)
}
