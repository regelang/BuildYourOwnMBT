
/// ================================================================================
/// # ðŸŽ‰ ç»ˆç« ï¼šå®Œæˆç±»åž‹æ£€æŸ¥å™¨
///
/// ðŸŽŠ **æ­å–œä½ ï¼ä½ å·²ç»æ¥åˆ°äº†ç±»åž‹æ£€æŸ¥é˜¶æ®µçš„æœ€åŽä¸€å…³ï¼** ðŸŽŠ
///
/// ç»è¿‡å‰é¢çš„æ‰€æœ‰æŒ‘æˆ˜ï¼Œä½ å·²ç»æž„å»ºäº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç±»åž‹æ£€æŸ¥ç³»ç»Ÿã€‚çŽ°åœ¨ï¼Œæ˜¯æ—¶å€™å®Œæˆæœ€åŽçš„æ­¥éª¤ï¼š
/// å®žçŽ° `typechecker.mbt` ä¸­çš„ `typecheck` å‡½æ•°ï¼Œå®ƒå°†éåŽ†æ•´ä¸ªè¯­æ³•æ ‘ï¼Œå°†æ‰€æœ‰ `TypeVar` æ›¿æ¢ä¸ºå…·ä½“çš„å®žä½“ç±»åž‹ã€‚
///
/// ## ðŸŽ¯ ä½ çš„ä»»åŠ¡ï¼šå®žçŽ° `typecheck` å‡½æ•°
///
/// `typecheck` å‡½æ•°æ˜¯æ•´ä¸ªç±»åž‹æ£€æŸ¥é˜¶æ®µçš„æœ€ç»ˆå…¥å£ã€‚å®ƒçš„æ ¸å¿ƒä»»åŠ¡æ˜¯ï¼š
///
/// 1. **éåŽ†æ•´ä¸ªè¯­æ³•æ ‘**ï¼šä»Žç¨‹åºçš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€’å½’åœ°è®¿é—®æ¯ä¸€ä¸ªè¯­æ³•èŠ‚ç‚¹
/// 2. **æ›¿æ¢ç±»åž‹å˜é‡**ï¼šå°† AST ä¸­æ‰€æœ‰çš„ `TypeVar` æ›¿æ¢ä¸ºé€šè¿‡ç±»åž‹æ£€æŸ¥å¾—åˆ°çš„å®žé™…ç±»åž‹
/// 3. **è¿”å›žç±»åž‹åŒ–çš„ AST**ï¼šè¿”å›žä¸€ä¸ªæ‰€æœ‰ç±»åž‹éƒ½å·²ç¡®å®šçš„è¯­æ³•æ ‘
///
/// ### ðŸ’¡ å®žçŽ°æ€è·¯
///
/// ä½ å·²ç»å®žçŽ°äº† `check_program` å‡½æ•°ï¼Œå®ƒä¼šï¼š
/// - è¿›è¡Œå®Œæ•´çš„ç±»åž‹æ£€æŸ¥
/// - åœ¨ `Context` ä¸­è®°å½•æ‰€æœ‰ç±»åž‹ä¿¡æ¯
/// - ç¡®ä¿ç¨‹åºåœ¨ç±»åž‹å±‚é¢æ˜¯æ­£ç¡®çš„
///
/// çŽ°åœ¨ï¼Œä½ éœ€è¦å®žçŽ° `typecheck` å‡½æ•°ï¼Œå®ƒä¼šï¼š
/// - è°ƒç”¨ `check_program` è¿›è¡Œç±»åž‹æ£€æŸ¥
/// - éåŽ† ASTï¼Œå°† `TypeVar` æ›¿æ¢ä¸ºå®žé™…ç±»åž‹
/// - è¿”å›žç±»åž‹åŒ–åŽçš„ AST
///
/// **å…³é”®æ­¥éª¤ï¼š**
///
/// 1. **è°ƒç”¨ç±»åž‹æ£€æŸ¥**ï¼šä½¿ç”¨ `check_program` å¯¹ç¨‹åºè¿›è¡Œç±»åž‹æ£€æŸ¥
/// 2. **éåŽ†æ›¿æ¢**ï¼šå®žçŽ°ä¸€ä¸ªéåŽ†å‡½æ•°ï¼Œé€’å½’åœ°è®¿é—®æ¯ä¸ªèŠ‚ç‚¹
/// 3. **ç±»åž‹æ›¿æ¢**ï¼šå¯¹äºŽåŒ…å« `TypeVar` çš„èŠ‚ç‚¹ï¼Œä»Ž `Context` ä¸­æŸ¥æ‰¾å¯¹åº”çš„å®žé™…ç±»åž‹å¹¶æ›¿æ¢
/// 4. **ä¿æŒç»“æž„**ï¼šç¡®ä¿æ›¿æ¢åŽçš„ AST ç»“æž„ä¸ŽåŽŸå§‹ç»“æž„å®Œå…¨ä¸€è‡´
///
/// ## ðŸš€ è§è¯ä½ çš„æˆæžœï¼
///
/// å®Œæˆè¿™ä¸ªä»»åŠ¡åŽï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ MiniMoonBit ç±»åž‹æ£€æŸ¥å™¨ï¼
/// ä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•ä½ çš„å®žçŽ°ï¼š
///
/// ```bash
/// moon test -p typecheck -f typechecker_test.mbt
/// ```
///
/// è¿™ä¸ªæµ‹è¯•ä¼šéªŒè¯ä½ çš„ `typecheck` å‡½æ•°æ˜¯å¦æ­£ç¡®åœ°å°†æ‰€æœ‰ `TypeVar` æ›¿æ¢ä¸ºäº†å…·ä½“çš„ç±»åž‹ã€‚
///
/// ## ðŸŽŠ æ­å–œä½ å®Œæˆäº†ç±»åž‹æ£€æŸ¥çš„æ‰€æœ‰å†…å®¹ï¼
///
/// ä½ å·²ç»æˆåŠŸæž„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ç±»åž‹æ£€æŸ¥ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
/// - âœ… åŸºç¡€ç±»åž‹æ£€æŸ¥
/// - âœ… è¡¨è¾¾å¼ç±»åž‹æŽ¨æ–­
/// - âœ… è¯­å¥ç±»åž‹æ£€æŸ¥
/// - âœ… å‡½æ•°ç±»åž‹æ£€æŸ¥
/// - âœ… ç»“æž„ä½“ç±»åž‹æ£€æŸ¥
/// - âœ… ç¨‹åºçº§ç±»åž‹æ£€æŸ¥
/// - âœ… ç±»åž‹å˜é‡æ›¿æ¢
///
/// **è¿™æ˜¯ä¸€ä¸ªäº†ä¸èµ·çš„æˆå°±ï¼** ä½ å·²ç»æŽŒæ¡äº†çŽ°ä»£ç¼–è¯‘å™¨ä¸­æœ€æ ¸å¿ƒçš„é™æ€åˆ†æžæŠ€æœ¯ä¹‹ä¸€ã€‚
///
/// **æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ç¼–è¯‘å™¨çš„ä¸‹ä¸€ä¸ªæ¿€åŠ¨äººå¿ƒçš„é˜¶æ®µï¼šKNF è½¬æ¢ï¼**
/// ================================================================================

///|
test "Program TypeCheck Test" {
  let code =
    #|let a = 3;
    #|let b = 4;
    #|fn fold(arr: Array[Int], f: (Int, Int) -> Int, init: Int) -> Int { 
    #|  let mut result = init;
    #|  let mut i = 0; 
    #|  while i < arr.length() {
    #|    result = f(result, arr[i]);
    #|  }
    #|  result
    #|}
    #|
    #|fn main {
    #|  fn max(a, b) { if a > b { a } else { b } }
    #|  fn min(a, b) { if a < b { a } else { b } }
    #|  let numbers = [a, 1, b, 1, 5, 9, 2, 6, 5];
    #|  let maximum = fold(numbers, max, -1000);
    #|  let minimum = fold(numbers, min, 1000);
    #|  let max_min_diff = maximum - minimum;
    #|  print_int(max_min_diff);
    #|}

  let tokens = @lexer.tokenize(code)
  let program = @parser.parse(tokens)
  let program = typecheck(program)

  let program_str = program.to_string()
  assert_false(program_str.contains("TypeVar"))
}
