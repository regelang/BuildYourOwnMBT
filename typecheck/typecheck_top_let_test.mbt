/// ================================================================================
/// # ç±»å‹æ£€æŸ¥è¯­å¥ï¼šé¡¶å±‚ let
///
/// é™¤äº†å‡½æ•°å†…éƒ¨çš„ `let mut`ï¼Œæˆ‘ä»¬çš„è¯­è¨€è¿˜æ”¯æŒåœ¨é¡¶å±‚ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰ä½¿ç”¨ `let` æ¥å®šä¹‰å…¨å±€å¸¸é‡ã€‚
/// å¯¹å®ƒçš„ç±»å‹æ£€æŸ¥ä¸ `let mut` éå¸¸ç›¸ä¼¼ï¼Œä½†æœ‰ä¸€ä¸ªå…³é”®çš„åŒºåˆ«ã€‚
///
/// ## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼šå®ç° `check_top_let`
///
/// ä½ çš„ä»»åŠ¡æ˜¯åœ¨ `typecheck/top_let.mbt` æ–‡ä»¶ä¸­å®ç° `Context::check_top_let` å‡½æ•°ã€‚
///
/// ### ğŸ’¡ å®ç°æ€è·¯
///
/// `check_top_let` çš„é€»è¾‘å‡ ä¹ä¸ `check_let_mut_stmt` å®Œå…¨ç›¸åŒï¼š
///
/// 1.  æ£€æŸ¥ `=` å³ä¾§è¡¨è¾¾å¼çš„ç±»å‹ã€‚
/// 2.  å¦‚æœå­˜åœ¨ç±»å‹æ³¨è§£ï¼Œåˆ™éªŒè¯å…¶ä¸è¡¨è¾¾å¼ç±»å‹æ˜¯å¦å…¼å®¹ã€‚
/// 3.  å°†æ–°å˜é‡çš„åç§°å’Œç±»å‹æ·»åŠ åˆ°ç±»å‹ç¯å¢ƒ `self.type_env` ä¸­ã€‚
///
/// **å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼š**
///
/// > é€šè¿‡é¡¶å±‚ `let` å®šä¹‰çš„å˜é‡æ˜¯**ä¸å¯å˜çš„ï¼ˆimmutableï¼‰**ã€‚
/// > å› æ­¤ï¼Œåœ¨å°†å®ƒæ·»åŠ åˆ°ç±»å‹ç¯å¢ƒæ—¶ï¼Œä½ å¿…é¡»å°†å…¶æ ‡è®°ä¸º `mutable: false`ã€‚
///
/// è¿™ç¡®ä¿äº†ç¼–è¯‘å™¨åœ¨åç»­çš„æ£€æŸ¥ä¸­ï¼Œå¦‚æœé‡åˆ°è¯•å›¾ä¿®æ”¹è¯¥å˜é‡çš„èµ‹å€¼è¯­å¥ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°æŠ›å‡ºé”™è¯¯ã€‚
///
/// ---
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p typecheck -f typecheck_top_let_test.mbt
/// ```
/// ================================================================================

///|
test "Top Let Stmt Type Check" {
  let code =
    #|let x : Int = 42;
    #|let y = true;
  let ctx = Context::new()
  // Parse
  let tokens = @lexer.tokenize(code)
  // Type check for `let x : Int = 42;`
  let (top_let1, tok_view) = @parser.parse_top_let(tokens[:])
  let checked_top_let1 = ctx.check_top_let(top_let1)
  assert_true(checked_top_let1.ty.kind is Int)
  let ty1 = ctx.lookup_type("x")
  assert_true(ty1 is Some(t) && t.kind is Int && t.mutable == false)

  // Type check for `let y = true;`
  let (top_let2, _) = @parser.parse_top_let(tok_view)
  let checked_top_let2 = ctx.check_top_let(top_let2)
  assert_true(checked_top_let2.ty.kind is Bool)
  let ty2 = ctx.lookup_type("y")
  assert_true(ty2 is Some(t) && t.kind is Bool && t.mutable == false)
}
