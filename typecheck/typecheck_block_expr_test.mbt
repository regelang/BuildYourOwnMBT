/// ================================================================================
/// # ç±»å‹æ£€æŸ¥è¯­å¥å’Œä»£ç å—
///
/// æˆ‘ä»¬å·²ç»å¯ä»¥ç‹¬ç«‹åœ°æ£€æŸ¥å„ç§è¯­å¥äº†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªâ€œæ€»æŒ‡æŒ¥â€æ¥è°ƒåº¦å®ƒä»¬ï¼Œå¹¶å¤„ç†è¯­å¥çš„é›†åˆâ€”â€”ä»£ç å—ï¼ˆBlockï¼‰ã€‚
///
/// ## ğŸ¯ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šå®ç° `check_stmt`
///
/// ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯åœ¨ `typecheck/stmt.mbt` æ–‡ä»¶ä¸­å®ç° `Context::check_stmt` å‡½æ•°ã€‚
/// è¿™ä¸ªå‡½æ•°å°†ä½œä¸ºä¸€ä¸ªåˆ†å‘å™¨ï¼ˆDispatcherï¼‰ã€‚
///
/// ### ğŸ’¡ `check_stmt` å®ç°æ€è·¯
///
/// `match` ä¼ å…¥çš„ `stmt.kind`ï¼Œç„¶åè°ƒç”¨æˆ‘ä»¬å·²ç»å®ç°çš„ç›¸åº”çš„æ£€æŸ¥å‡½æ•°ï¼š
/// *   `LetStmt(...)` -> `check_let_stmt(...)`
/// *   `LetMutStmt(...)` -> `check_let_mut_stmt(...)`
/// *   `AssignStmt(...)` -> `check_assign_stmt(...)`
/// *   `ExprStmt(expr)` -> `check_expr(expr)`
/// *   ...ç­‰ç­‰
///
/// ### â­ ç‰¹åˆ«å…³æ³¨ï¼š`ReturnStmt`
///
/// åœ¨å¤„ç† `ReturnStmt` æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“ `return` è¯­å¥çš„ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Ÿ
///
/// > æˆ‘ä»¬å¿…é¡»å°† `return` åé¢è¡¨è¾¾å¼çš„ç±»å‹ä¸**å½“å‰å‡½æ•°ç­¾åä¸­å£°æ˜çš„è¿”å›ç±»å‹**è¿›è¡Œæ¯”è¾ƒã€‚
///
/// è¿™ä¸ªâ€œå½“å‰å‡½æ•°çš„è¿”å›ç±»å‹â€ä¿¡æ¯å°±å­˜æ”¾åœ¨ `Context` ä¸­ã€‚æˆ‘ä»¬çº¦å®šä½¿ç”¨ `current_func_ret_ty: Option[TypeKind]` å­—æ®µæ¥è®°å½•å®ƒã€‚
///
/// *   å½“æ£€æŸ¥ `ReturnStmt(Some(expr))` æ—¶ï¼Œä½ éœ€è¦æ£€æŸ¥ `expr` çš„ç±»å‹æ˜¯å¦ä¸ `self.current_func_ret_ty` å…¼å®¹ã€‚
/// *   å½“æ£€æŸ¥ `ReturnStmt(None)` æ—¶ï¼ˆå³ `return;`ï¼‰ï¼Œä½ éœ€è¦æ£€æŸ¥ `self.current_func_ret_ty` æ˜¯å¦ä¸º `Unit`ã€‚
/// *   å¦‚æœ `self.current_func_ret_ty` æ˜¯ `None`ï¼Œè¯´æ˜ `return` è¯­å¥å‡ºç°åœ¨äº†å‡½æ•°ä¹‹å¤–ï¼Œåº”è¯¥æŠ›å‡ºé”™è¯¯ã€‚
///
/// ## ğŸ¯ ä½ çš„ç¬¬äºŒä¸ªä»»åŠ¡ï¼šå®ç° `check_block_expr`
///
/// å®Œæˆäº† `check_stmt` åï¼Œä½ éœ€è¦åœ¨ `typecheck/block_expr.mbt` ä¸­å®ç° `check_block_expr`ã€‚
///
/// ### ğŸ’¡ `check_block_expr` å®ç°æ€è·¯
///
/// 1.  **å¤„ç†ä½œç”¨åŸŸï¼ˆScopingï¼‰ï¼š**
///     *   ä»£ç å— `{...}` ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸã€‚åœ¨å—å†…å®šä¹‰çš„å˜é‡ä¸åº”è¯¥â€œæ³„éœ²â€åˆ°å¤–éƒ¨ã€‚
///     *   åœ¨å¼€å§‹æ£€æŸ¥å—å†…è¯­å¥**ä¹‹å‰**ï¼Œè°ƒç”¨ `self.enter_scope()` æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å˜é‡ç¯å¢ƒã€‚
///     *   åœ¨æ‰€æœ‰è¯­å¥æ£€æŸ¥å®Œæˆ**ä¹‹å**ï¼Œå¿…é¡»è°ƒç”¨ `self.exit_scope()` æ¥é”€æ¯è¿™ä¸ªç¯å¢ƒï¼Œæ¢å¤åˆ°ä¸Šä¸€å±‚ã€‚
///
/// 2.  **éå†è¯­å¥ï¼š**
///     *   éå†å—å†…çš„æ¯ä¸€æ¡è¯­å¥ï¼Œè°ƒç”¨ä½ åˆšåˆšå®Œæˆçš„ `self.check_stmt` æ¥æ£€æŸ¥å®ƒã€‚
///
/// 3.  **ç¡®å®šå—çš„ç±»å‹ï¼š**
///     *   ä»£ç å—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒæœ‰è‡ªå·±çš„ç±»å‹ã€‚
///     *   è§„åˆ™æ˜¯ï¼šå—çš„ç±»å‹å°±æ˜¯**æœ€åä¸€æ¡è¡¨è¾¾å¼è¯­å¥çš„ç±»å‹**ã€‚
///     *   å¦‚æœä»£ç å—ä¸ºç©ºï¼Œæˆ–è€…æœ€åä¸€æ¡è¯­å¥ä»¥åˆ†å·ç»“å°¾ï¼ˆå³ä¸æ˜¯è¡¨è¾¾å¼è¯­å¥ï¼‰ï¼Œé‚£ä¹ˆæ•´ä¸ªå—çš„ç±»å‹å°±æ˜¯ `Unit`ã€‚
///
/// ---
///
/// **é˜¶æ®µæ€§æµ‹è¯•ï¼š**
///
/// ```bash
/// moon test -p typecheck -f typecheck_block_expr_test.mbt
/// ```
/// ================================================================================

///|
test "Block Expr TypeCheck Test" {
  let code =
    #|let arr = [];
    #|
    #|{
    #|  let (x, y) = (1, 2);
    #|  let mut z = x + y;
    #|  z += 10;
    #|  arr.push(z);
    #|}
    #|
    #|{
    #|  let (x, y) = (1.0, 2.0);
    #|  let z = x * y;
    #|  let arr = [1.0, z, 5.0];
    #|  arr[2] = arr[1];
    #|  arr[2]
    #|}
    #|
    #|{ arr[0] = 1.0; } // should cause type error
  let ctx = Context::new()
  // Parse
  let tokens = @lexer.tokenize(code)
  let (let_stmt, tok_view) = @parser.parse_let_stmt(tokens[:])
  let _ = ctx.check_let_stmt(let_stmt)
  // TypeCheck first block expr
  let (block_expr1, tok_view) = @parser.parse_block_expr(tok_view)
  let checked_block1 = ctx.check_block_expr(block_expr1)
  assert_true(checked_block1.stmts.length() is 4)
  assert_true(checked_block1.ty is Unit)
  // TypeCheck second block expr
  let (block_expr2, tok_view) = @parser.parse_block_expr(tok_view)
  let checked_block2 = ctx.check_block_expr(block_expr2)
  assert_true(checked_block2.stmts.length() is 5)
  assert_true(checked_block2.ty is Double)
  // TypeCheck third block expr (should raise type error)
  assert_true(ctx.lookup_type("arr") is Some({ kind: Array(Int), .. }))
  let (block_expr3, _) = @parser.parse_block_expr(tok_view)
  let checked_block3 = try? ctx.check_block_expr(block_expr3)
  assert_true(checked_block3 is Err(_))
}
